<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seri Analiz & Tahmin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap');
:root{
  --bg:#f4efe4;--paper:#faf6ed;--ink:#1c1710;--ink2:#3a3228;--ink3:#6e6050;
  --rule:#d6c9b4;--red:#b83232;--blue:#1a5c8a;--green:#1f7a45;--amber:#c07a00;--purple:#6b3fa0;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--ink);font-family:'Space Mono',monospace;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:repeating-linear-gradient(transparent,transparent 27px,rgba(180,158,130,.22)27px,rgba(180,158,130,.22)28px);}
.wrap{position:relative;z-index:1;max-width:1320px;margin:0 auto;padding:28px 22px 80px;}
header{border-bottom:3px solid var(--ink);padding-bottom:18px;margin-bottom:28px;}
.eyebrow{font-size:10px;letter-spacing:4px;color:var(--ink3);text-transform:uppercase;margin-bottom:4px;}
h1{font-family:'Bebas Neue',sans-serif;font-size:clamp(28px,5vw,60px);letter-spacing:3px;line-height:.95;}
h1 em{color:var(--blue);font-style:normal;}h1 strong{color:var(--red);}
.sub{margin-top:8px;font-size:11px;color:var(--ink3);line-height:1.85;max-width:640px;}
.entry-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
@media(max-width:800px){.entry-grid{grid-template-columns:1fr;}}
.panel{background:var(--paper);border:2px solid var(--ink);padding:20px 20px 14px;position:relative;margin-top:14px;}
.panel::before{content:attr(data-lbl);position:absolute;top:-12px;left:12px;background:var(--paper);
  padding:0 8px;font-size:10px;letter-spacing:3px;text-transform:uppercase;font-weight:700;border:2px solid var(--ink);}
.panel.bl::before{color:var(--blue);border-color:var(--blue);}
.panel.rd::before{color:var(--red);border-color:var(--red);}
.hint{font-size:10px;color:var(--ink3);margin-top:7px;line-height:1.75;}
.hint b{color:var(--blue);}
textarea{width:100%;height:120px;background:transparent;border:1px solid var(--rule);
  color:var(--ink);font-family:'Space Mono',monospace;font-size:12px;padding:9px 10px;resize:vertical;outline:none;line-height:1.75;}
textarea:focus{border-color:var(--ink);}
#setInput{width:100%;background:transparent;border:1px solid var(--rule);color:var(--ink);
  font-family:'Space Mono',monospace;font-size:13px;padding:9px 10px;outline:none;margin-bottom:8px;}
#setInput:focus{border-color:var(--blue);}
#setPreview{display:flex;flex-wrap:wrap;gap:5px;min-height:24px;margin-bottom:5px;}
.tag{background:rgba(26,92,138,.12);border:1px solid rgba(26,92,138,.4);color:var(--blue);padding:3px 10px;font-size:11px;font-weight:700;}
.stat-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));margin-bottom:20px;border:2px solid var(--ink);overflow:hidden;}
.si{padding:10px 12px;background:var(--paper);border-right:1px solid var(--rule);}
.si:last-child{border-right:none;}
.si-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);margin-bottom:3px;}
.si-val{font-size:16px;font-weight:700;color:var(--ink);}
.si-val.ok{color:var(--green);}.si-val.warn{color:var(--amber);}.si-val.err{color:var(--red);}
.si-sub{font-size:9px;color:var(--ink3);margin-top:2px;}
.ctrl-row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;
  margin-bottom:20px;padding:14px 18px;background:var(--paper);border:2px solid var(--ink);}
.ctrl{display:flex;flex-direction:column;gap:4px;}
.ctrl label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);}
.ctrl .vv{font-size:14px;font-weight:700;color:var(--ink);}
.ctrl input[type=range]{-webkit-appearance:none;width:100px;height:3px;background:var(--rule);outline:none;cursor:pointer;}
.ctrl input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:var(--ink);border-radius:50%;cursor:pointer;}
.ctrl select{background:var(--paper);border:1px solid var(--rule);color:var(--ink);
  padding:5px 8px;font-family:'Space Mono',monospace;font-size:11px;outline:none;cursor:pointer;}
.btn{padding:9px 16px;background:var(--ink);color:var(--bg);border:2px solid var(--ink);
  font-family:'Space Mono',monospace;font-size:11px;letter-spacing:1.5px;text-transform:uppercase;
  cursor:pointer;transition:all .15s;white-space:nowrap;}
.btn:hover{background:transparent;color:var(--ink);}
.btn.g{background:var(--green);border-color:var(--green);}
.btn.g:hover{background:transparent;color:var(--green);}
.btn.r{background:var(--red);border-color:var(--red);}
.btn.r:hover{background:transparent;color:var(--red);}
.btn:disabled{opacity:.35;cursor:not-allowed;}
/* ENSEMBLE PANEL */
.ens-panel{background:var(--paper);border:2px solid var(--ink);padding:14px 18px;margin-bottom:20px;display:none;}
.ens-panel-title{font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px;margin-bottom:10px;border-bottom:1px solid var(--rule);padding-bottom:6px;}
.ens-checks{display:flex;flex-wrap:wrap;gap:8px 20px;}
.ens-check{display:flex;align-items:center;gap:6px;font-size:11px;cursor:pointer;user-select:none;}
.ens-check input[type=checkbox]{width:14px;height:14px;cursor:pointer;accent-color:var(--green);}
/* PROGRESS */
.prog-wrap{display:none;background:var(--paper);border:2px solid var(--ink);padding:14px 18px;margin-bottom:18px;}
.prog-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px;}
.prog-outer{width:100%;height:5px;background:var(--rule);}
.prog-inner{height:100%;background:var(--green);transition:width .08s linear;}
.prog-txt{font-size:12px;font-weight:700;margin-top:5px;}
/* RESULTS */
.rc{background:var(--paper);border:2px solid var(--ink);padding:18px;margin-bottom:18px;}
.rc-title{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:2px;
  border-bottom:1px solid var(--rule);padding-bottom:6px;margin-bottom:12px;display:flex;align-items:baseline;gap:12px;}
.rc-sub{font-size:10px;font-family:'Space Mono',monospace;font-weight:400;color:var(--ink3);letter-spacing:0;}
.results-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:18px;}
@media(max-width:700px){.results-grid{grid-template-columns:1fr;}}
.fr{display:flex;justify-content:space-between;align-items:baseline;padding:5px 0;border-bottom:1px dotted var(--rule);font-size:11px;}
.fr:last-child{border-bottom:none;}
.fr-l{color:var(--ink3);}.fr-r{font-weight:700;}
.fr-r.ok{color:var(--green);}.fr-r.warn{color:var(--amber);}.fr-r.err{color:var(--red);}
/* CHART */
.chart-card{background:var(--paper);border:2px solid var(--ink);padding:18px 20px;margin-bottom:20px;}
.chart-card.fullscreen{position:fixed!important;inset:0!important;z-index:9999!important;
  margin:0!important;border:none!important;display:flex;flex-direction:column;
  padding:16px 20px;background:var(--paper)!important;}
.chart-card.fullscreen .cw{flex:1;height:auto!important;}
.chart-top{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:6px;}
.chart-ttl{font-family:'Bebas Neue',sans-serif;font-size:19px;letter-spacing:2px;}
.cbts{display:flex;gap:5px;}
.cbt{background:var(--paper);border:2px solid var(--ink);color:var(--ink);font-size:14px;
  width:30px;height:30px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;transition:all .12s;}
.cbt:hover{background:var(--ink);color:var(--bg);}
.leg-row{display:flex;gap:14px;flex-wrap:wrap;font-size:10px;margin-bottom:10px;align-items:center;}
.leg{display:flex;align-items:center;gap:5px;}
.ll{width:22px;height:3px;border-radius:1px;}
.cw{position:relative;width:100%;height:340px;}
.cw canvas{position:absolute;inset:0;width:100%!important;height:100%!important;}
/* 2D TABLE */
.p2d-outer{overflow-x:auto;margin-top:4px;}
.p2d{border-collapse:separate;border-spacing:0;font-size:11px;width:100%;}
.p2d th{padding:7px 10px;background:var(--ink);color:var(--bg);font-size:9px;letter-spacing:2px;
  text-transform:uppercase;border:1px solid var(--ink2);white-space:nowrap;text-align:center;}
.p2d th.rh{background:var(--ink2);}
.p2d td{padding:6px 9px;border:1px solid var(--rule);text-align:center;white-space:nowrap;font-size:11px;font-weight:700;}
.p2d tr:hover td{filter:brightness(.96);}
.p2d td.sh{background:var(--paper)!important;color:var(--ink3);font-size:10px;text-align:left;}
.p2d td.bt{color:var(--green);font-weight:700;}
.p2d td.bs{color:var(--amber);font-weight:700;}
.tbl-legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;font-size:10px;align-items:center;}
.tll{display:flex;align-items:center;gap:5px;}
.tlb{width:15px;height:15px;border:1px solid #aaa;}
/* INFO BOX */
.info-box{background:var(--paper);border-left:4px solid var(--blue);
  padding:16px 18px;font-size:11px;line-height:1.9;color:var(--ink2);margin-bottom:18px;}
.info-box h4{font-size:13px;font-family:'Bebas Neue',sans-serif;letter-spacing:2px;margin-bottom:6px;margin-top:10px;}
.info-box h4:first-child{margin-top:0;}
.mrow{padding:3px 0;border-bottom:1px dotted var(--rule);}
.mrow:last-child{border:none;}
.mn{color:var(--blue);font-weight:700;}
</style>
</head>
<body>
<div class="wrap">

<!-- HEADER -->
<header>
  <div class="eyebrow">// Adım Kümesi · Seri Analiz · 9 Yöntem · LSTM · N-HiTS</div>
  <h1><em>SERİ</em> <strong>TAHMİN</strong></h1>
  <p class="sub">Adım kümesi gir → Seriyi yapıştır → Yöntemi seç → 2B olasılık ısı tablosu + kümülatif grafik</p>
</header>

<!-- 1. VERİ GİRİŞİ -->
<div class="entry-grid">
  <div class="panel bl" data-lbl="adım kümesi (izin verilen değerler)">
    <input id="setInput" placeholder="Örnek: 1, 2, 3  veya  3, 3.2, 3.4, 3.6"
      oninput="parseSetInput()" autocomplete="off">
    <div id="setPreview"></div>
    <div class="hint">Virgülle ayır. <b>Örnek: 3, 3.2, 3.4, 3.6</b><br>
    Seri yalnızca bu değerlerden oluşabilir.</div>
  </div>
  <div class="panel rd" data-lbl="veri serisi (ham değerler)">
    <textarea id="seriesInput"
      placeholder="3,3,3.2,3.2,3.4,3.4,3.2,3,3,3.2,3.4,3.6,3.4,3.2&#10;&#10;Virgül, noktalı virgül veya yeni satırla ayır."></textarea>
    <div class="hint">Kümülatif değil, ham adım değerleri.</div>
  </div>
</div>

<!-- 2. İSTATİSTİK BAR -->
<div class="stat-bar">
  <div class="si"><div class="si-lbl">Veri Uzunluğu</div><div class="si-val" id="stLen">—</div></div>
  <div class="si"><div class="si-lbl">Küme Boyutu</div><div class="si-val" id="stSetN">—</div></div>
  <div class="si"><div class="si-lbl">Geçersiz</div><div class="si-val" id="stBad">—</div></div>
  <div class="si"><div class="si-lbl">Ortalama</div><div class="si-val" id="stMean">—</div></div>
  <div class="si"><div class="si-lbl">Std Dev</div><div class="si-val" id="stStd">—</div></div>
  <div class="si"><div class="si-lbl">ACF(1)</div><div class="si-val" id="stAcf">—</div></div>
  <div class="si"><div class="si-lbl">Trend</div><div class="si-val" id="stTrend">—</div></div>
  <div class="si"><div class="si-lbl">Entropi</div><div class="si-val" id="stEnt">—</div>
    <div class="si-sub">belirsizlik bit</div></div>
</div>

<!-- 3. ANALİZ SEÇENEKLERİ -->
<div class="ctrl-row">
  <div class="ctrl">
    <label>Tahmin Adımı</label>
    <span class="vv" id="vN">8</span>
    <input type="range" id="rN" min="1" max="24" value="8"
      oninput="document.getElementById('vN').textContent=this.value">
  </div>
  <div class="ctrl">
    <label>Yöntem</label>
    <select id="method" onchange="onMethodChange()">
      <option value="mc">MC Markov Zinciri</option>
      <option value="arima">ARIMA AR(p)</option>
      <option value="holt">Holt Exp. Smoothing</option>
      <option value="nbwin">Naive Bayes (Pencere)</option>
      <option value="kalman">Kalman Filter</option>
      <option value="gp">Gaussian Process (Matérn 5/2)</option>
      <option value="particle">Particle Filter (SMC)</option>
      <option value="nhits">N-HiTS</option>
      <option value="lstm">GRU + MC-Dropout</option>
      <option value="combined" selected>Ensemble (Seçilebilir)</option>
    </select>
  </div>
  <div class="ctrl">
    <label>Simülasyon</label>
    <span class="vv" id="vMC">2000</span>
    <input type="range" id="rMC" min="500" max="8000" step="500" value="2000"
      oninput="document.getElementById('vMC').textContent=this.value">
  </div>
  <div class="ctrl">
    <label>Güven Bandı</label>
    <select id="bandConf">
      <option value="0.8">%80</option>
      <option value="0.9" selected>%90</option>
      <option value="0.95">%95</option>
    </select>
  </div>
  <div style="flex:1"></div>
  <button class="btn g" onclick="runAnalysis()">▶ ANALİZ ET</button>
  <button class="btn r" onclick="loadExample()">ÖRNEK</button>
</div>

<!-- ENSEMBLE YÖNTEMLERİ PANEL -->
<div class="ens-panel" id="ensPanel">
  <div class="ens-panel-title">ENSEMBLE — Hangi Yöntemler Dahil Edilsin?</div>
  <div class="ens-checks">
    <label class="ens-check"><input type="checkbox" id="ec_mc"      checked> MC Markov Zinciri</label>
    <label class="ens-check"><input type="checkbox" id="ec_arima"   checked> ARIMA AR(p)</label>
    <label class="ens-check"><input type="checkbox" id="ec_holt"    checked> Holt Exp. Smoothing</label>
    <label class="ens-check"><input type="checkbox" id="ec_nbwin"   checked> Naive Bayes (Pencere)</label>
    <label class="ens-check"><input type="checkbox" id="ec_kalman"        > Kalman Filter</label>
    <label class="ens-check"><input type="checkbox" id="ec_gp"           > Gaussian Process</label>
    <label class="ens-check"><input type="checkbox" id="ec_particle"     > Particle Filter</label>
    <label class="ens-check"><input type="checkbox" id="ec_nhits"        > N-HiTS</label>
  </div>
  <div class="hint" style="margin-top:8px;">En az 2 yöntem seçili olmalıdır. GRU/LSTM Ensemble'a dahil edilmez (eğitim süresi nedeniyle).</div>
</div>

<!-- PROGRESS -->
<div class="prog-wrap" id="progWrap">
  <div class="prog-lbl" id="progLbl">Başlatılıyor…</div>
  <div class="prog-outer"><div class="prog-inner" id="progBar" style="width:0%"></div></div>
  <div class="prog-txt" id="progTxt">0%</div>
</div>

<!-- 4. 2B OLASILIK TABLOSU -->
<div class="rc" id="sec_table" style="display:none">
  <div class="rc-title">
    2B OLASILIK TABLOSU
    <span class="rc-sub">Satır = tahmin adımı · Sütun = değer · Hücre = % olasılık</span>
  </div>
  <div class="p2d-outer" id="p2dWrap"></div>
  <div class="tbl-legend" id="tblLeg"></div>
</div>

<!-- 5. ANA GRAFİK -->
<div class="chart-card" id="sec_chart1" style="display:none">
  <div class="chart-top">
    <div class="chart-ttl">VERİ + TAHMİN</div>
    <div class="cbts">
      <button class="cbt" onclick="c1zi()">＋</button>
      <button class="cbt" onclick="c1zo()">－</button>
      <button class="cbt" onclick="c1zr()">⊙</button>
      <button class="cbt" id="fs1btn" onclick="toggleFS('chartCard1','fs1btn')">⛶</button>
    </div>
  </div>
  <div class="leg-row">
    <div class="leg"><div class="ll" style="background:var(--blue)"></div>Gözlem</div>
    <div class="leg"><div class="ll" style="border-top:2px dashed var(--green);height:0;width:22px"></div>Tahmin medyanı</div>
    <div class="leg"><div class="ll" style="height:10px;width:22px;background:rgba(31,122,69,.12);border:1px solid rgba(31,122,69,.35)"></div>Güven bandı</div>
    <div class="leg"><div class="ll" style="background:var(--red)"></div>Geçersiz nokta</div>
    <span style="font-size:9px;color:var(--ink3);margin-left:auto;">scroll zoom · sürükle pan · ESC tam ekran</span>
  </div>
  <div class="cw" id="chartCard1"><canvas id="chart1"></canvas></div>
</div>

<!-- 6. ANALİZ BULGULARI + TAHMİN ÖZETİ -->
<div class="results-grid" id="sec_results" style="display:none">
  <div class="rc"><div class="rc-title">ANALİZ BULGULARI</div><div id="findings"></div></div>
  <div class="rc"><div class="rc-title">TAHMİN ÖZETİ</div><div id="predSummary"></div></div>
</div>

<!-- 7. KÜMÜLATİF GRAFİK -->
<div class="chart-card" id="sec_chart2" style="display:none">
  <div class="chart-top">
    <div class="chart-ttl">KÜMÜLATİF SERİ <span style="font-size:12px;font-family:'Space Mono',monospace;font-weight:400;letter-spacing:0;color:var(--ink3);">— gözlem + tahmin dahil toplam</span></div>
    <div class="cbts">
      <button class="cbt" onclick="c2zi()">＋</button>
      <button class="cbt" onclick="c2zo()">－</button>
      <button class="cbt" onclick="c2zr()">⊙</button>
      <button class="cbt" id="fs2btn" onclick="toggleFS('chartCard2','fs2btn')">⛶</button>
    </div>
  </div>
  <div class="leg-row">
    <div class="leg"><div class="ll" style="background:var(--blue)"></div>Gözlem (kümülatif)</div>
    <div class="leg"><div class="ll" style="background:var(--amber)"></div>Tahmin medyanı (kümülatif)</div>
    <div class="leg"><div class="ll" style="height:10px;width:22px;background:rgba(192,122,0,.12);border:1px solid rgba(192,122,0,.4)"></div>Tahmin güven bandı</div>
  </div>
  <div class="cw" id="chartCard2"><canvas id="chart2"></canvas></div>
</div>

<!-- 8. YÖNTEM AÇIKLAMALARI -->
<div class="info-box" id="sec_info" style="display:none"></div>

</div><!-- .wrap -->

<!-- ════════════════════════════ JAVASCRIPT ════════════════════════════ -->
<script>
'use strict';

/* ── STATE ── */
var _set=[], _data=[], _chart1=null, _chart2=null, _lstmMdl=null, _lstmNrm=null;

/* ── UTILS ── */
function $(id){ return document.getElementById(id); }
function sleep(ms){ return new Promise(function(r){ setTimeout(r,ms); }); }
function setP(p,lbl,txt){
  $('progBar').style.width=Math.min(100,p)+'%';
  $('progTxt').textContent=txt||Math.round(p)+'%';
  if(lbl) $('progLbl').textContent=lbl;
}
function show(id){ $(id).style.display='block'; }
function hide(id){ $(id).style.display='none'; }

/* ── MATH ── */
function mean(a){
  if(!a||!a.length)return 0;
  var s=0;for(var i=0;i<a.length;i++)s+=a[i];return s/a.length;
}
function vari(a){
  if(!a||a.length<2)return 0;
  var m=mean(a),s=0;for(var i=0;i<a.length;i++)s+=(a[i]-m)*(a[i]-m);return s/a.length;
}
function std(a){ return Math.sqrt(vari(a)); }
function acf1(a){
  var n=a.length,m=mean(a),num=0,den=0;
  for(var i=1;i<n;i++)num+=(a[i]-m)*(a[i-1]-m);
  for(var i=0;i<n;i++)den+=(a[i]-m)*(a[i]-m);
  return den<1e-12?0:num/den;
}
function pct(a,p){
  var s=a.slice().sort(function(x,y){return x-y;});
  return s[Math.max(0,Math.min(s.length-1,Math.floor(p*(s.length-1))))];
}
function linTrend(a){
  var n=a.length,sx=0,sy=0,sxy=0,sxx=0;
  for(var i=0;i<n;i++){sx+=i;sy+=a[i];sxy+=i*a[i];sxx+=i*i;}
  var d=n*sxx-sx*sx;return d<1e-12?0:(n*sxy-sx*sy)/d;
}
function entropy(data,set){
  if(!set.length)return 0;
  var cnt={},n=data.length;
  for(var i=0;i<set.length;i++)cnt[set[i]]=0;
  for(var i=0;i<n;i++){var k=snap(data[i],set);cnt[k]=(cnt[k]||0)+1;}
  var h=0;
  for(var k in cnt){var p=cnt[k]/n;if(p>0)h-=p*Math.log2(p);}
  return h;
}
function grnd(){
  var u=0,v=0;while(!u)u=Math.random();while(!v)v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function snap(v,set){
  if(!set||!set.length)return v;
  var best=set[0];
  for(var i=1;i<set.length;i++)if(Math.abs(set[i]-v)<Math.abs(best-v))best=set[i];
  return best;
}

/* ── INPUT PARSING ── */
function parseSetInput(){
  var raw=$('setInput').value;
  var parts=raw.split(/[,;\s]+/);
  var seen={},vals=[];
  for(var i=0;i<parts.length;i++){
    var n=parseFloat(parts[i]);
    if(!isNaN(n)&&!seen[n]){seen[n]=true;vals.push(n);}
  }
  vals.sort(function(a,b){return a-b;});
  _set=vals;
  $('setPreview').innerHTML=_set.map(function(v){return '<span class="tag">'+v+'</span>';}).join('');
  $('stSetN').textContent=_set.length||'—';
}

function parseSeries(){
  var raw=$('seriesInput').value;
  var parts=raw.split(/[\n,;]+/);
  var out=[];
  for(var i=0;i<parts.length;i++){
    var n=parseFloat(parts[i].trim());
    if(!isNaN(n))out.push(n);
  }
  return out;
}

function onMethodChange(){
  var m=$('method').value;
  $('ensPanel').style.display=(m==='combined')?'block':'none';
}

/* ── TRANSITION MATRIX ── */
function buildTrans(data,set){
  var n=set.length;if(!n)return null;
  function idx(v){for(var i=0;i<set.length;i++)if(Math.abs(set[i]-v)<1e-9)return i;return -1;}
  var T=[];
  for(var i=0;i<n;i++){T.push([]);for(var j=0;j<n;j++)T[i].push(0.1);}
  for(var i=1;i<data.length;i++){
    var fi=idx(data[i-1]),ti=idx(data[i]);
    if(fi>=0&&ti>=0)T[fi][ti]++;
  }
  for(var i=0;i<n;i++){var s=0;for(var j=0;j<n;j++)s+=T[i][j];for(var j=0;j<n;j++)T[i][j]/=s;}
  return T;
}

/* ── METHOD 1: MC MARKOV ── */
function mcPredict(data,steps,set,T){
  if(!set.length){
    var s=std(data),m=mean(data),a=acf1(data),last=data[data.length-1],path=[];
    for(var i=0;i<steps;i++){last=last*a+m*(1-Math.abs(a))+s*grnd()*(1-Math.abs(a));path.push(last);}
    return path;
  }
  function idx(v){for(var i=0;i<set.length;i++)if(Math.abs(set[i]-v)<1e-9)return i;return -1;}
  var cur=idx(data[data.length-1]);if(cur<0)cur=Math.floor(set.length/2);
  var path=[];
  for(var i=0;i<steps;i++){
    var row=T[cur],r=Math.random(),cum=0;
    for(var j=0;j<set.length;j++){cum+=row[j];if(r<=cum){cur=j;break;}}
    path.push(set[cur]);
  }
  return path;
}

/* ── METHOD 2: AR(p) ── */
function fitAR(data,p){
  var n=data.length;if(n<=p||p<1)return [0];
  var m=mean(data),c=[];
  for(var k=0;k<=p;k++){var s=0;for(var i=k;i<n;i++)s+=(data[i]-m)*(data[i-k]-m);c.push(s/(n-k));}
  var phi=[c[1]/(c[0]||1e-10)],V=c[0]*(1-phi[0]*phi[0]);
  for(var lag=2;lag<=p;lag++){
    var num=c[lag];for(var j=0;j<phi.length;j++)num-=phi[j]*(c[lag-1-j]||0);
    var kk=num/(V||1e-10),phi2=[];
    for(var j=0;j<phi.length;j++)phi2.push(phi[j]-kk*(phi[phi.length-2-j]||0));
    phi2.push(kk);phi=phi2;V*=(1-kk*kk);
    if(isNaN(V)||V<=0)break;
  }
  return phi;
}
function arPredict(data,phi,steps,nStd,set){
  var m=mean(data),hist=data.map(function(v){return v-m;}),path=[];
  for(var i=0;i<steps;i++){
    var pred=0;for(var j=0;j<phi.length;j++)pred+=phi[j]*(hist[hist.length-1-j]||0);
    pred+=m+nStd*grnd();
    if(set.length)pred=snap(pred,set);
    hist.push(pred-m);path.push(pred);
  }
  return path;
}

/* ── METHOD 3: HOLT ── */
function holtPredict(data,steps,set,nStd){
  var alpha=0.3,beta=0.1,lv=data[0],tr=(data[data.length-1]-data[0])/(data.length-1||1);
  for(var i=1;i<data.length;i++){
    var lp=lv,tp=tr;lv=alpha*data[i]+(1-alpha)*(lp+tp);tr=beta*(lv-lp)+(1-beta)*tp;
  }
  var path=[];
  for(var s=0;s<steps;s++){
    var v=lv+tr*(s+1)+nStd*grnd();if(set.length)v=snap(v,set);path.push(v);
  }
  return path;
}

/* ── METHOD 4: NAIVE BAYES WINDOW ── */
function nbPredict(data,steps,set){
  var es=set.length?set:Array.from(new Set(data)).sort(function(a,b){return a-b;});
  var win=3;
  if(!es.length||data.length<win+1)return mcPredict(data,steps,es,buildTrans(data,es));
  function idx(v){for(var i=0;i<es.length;i++)if(Math.abs(es[i]-v)<1e-9)return i;return 0;}
  function key(w){return w.map(function(v){return Math.max(0,idx(v));}).join('-');}
  var cnt={};
  for(var i=win;i<data.length;i++){
    var k=key(data.slice(i-win,i)),ni=idx(data[i]);
    if(!cnt[k]){cnt[k]=[];for(var j=0;j<es.length;j++)cnt[k].push(0.05);}
    cnt[k][ni]++;
  }
  var w=data.slice(-win),path=[];
  for(var i=0;i<steps;i++){
    var k=key(w),row=cnt[k]||(function(){var r=[];for(var j=0;j<es.length;j++)r.push(1);return r;})();
    var total=0;for(var j=0;j<row.length;j++)total+=row[j];
    var r=Math.random()*total,cum=0,chosen=0;
    for(var j=0;j<es.length;j++){cum+=row[j];if(r<=cum){chosen=j;break;}}
    w=w.slice(1);w.push(es[chosen]);path.push(es[chosen]);
  }
  return path;
}

/* ── METHOD 5: KALMAN FILTER ── */
function kalmanPredict(data,steps,set){
  var s2=std(data)||0.1,R=s2*s2*0.16,Q=s2*s2*0.0225,Qt=s2*s2*0.0025;
  var xl=data[0],xt=(data[data.length-1]-data[0])/(data.length-1||1),Pll=1,Plt=0,Ptt=1;
  for(var i=1;i<data.length;i++){
    var xl_=xl+xt,xt_=xt,Pll_=Pll+2*Plt+Ptt+Q,Plt_=Plt+Ptt,Ptt_=Ptt+Qt;
    var inn=data[i]-xl_,S=Pll_+R,Kl=Pll_/S,Kt=Plt_/S;
    xl=xl_+Kl*inn;xt=xt_+Kt*inn;Pll=(1-Kl)*Pll_;Plt=(1-Kl)*Plt_-Kl*Ptt_;Ptt=Ptt_-Kt*Plt_;
  }
  var lv=xl+grnd()*Math.sqrt(Math.max(0,Pll)),tr=xt+grnd()*Math.sqrt(Math.max(0,Math.abs(Ptt))),path=[];
  for(var s=0;s<steps;s++){
    lv+=tr+grnd()*Math.sqrt(Q);tr+=grnd()*Math.sqrt(Qt);
    var v=lv+grnd()*Math.sqrt(R);if(set.length)v=snap(v,set);path.push(v);
  }
  return path;
}

/* ── METHOD 6: GAUSSIAN PROCESS (Matérn 5/2, mean-centered) ── */
function gpPredict(data,steps,set){
  var n=data.length,dm=mean(data);
  var cd=data.map(function(v){return v-dm;});
  var sigF=std(cd)||0.1,ell=Math.max(3,n*0.15),sigN=sigF*0.3,sn2=sigN*sigN;
  function k52(d){var r=Math.abs(d)/ell,s5=Math.sqrt(5)*r;return sigF*sigF*(1+s5+5*r*r/3)*Math.exp(-s5);}
  var m=Math.min(20,n);
  var Xu=[],X=[],Xs=[];
  for(var i=0;i<m;i++)Xu.push(i*(n-1)/(m-1||1));
  for(var i=0;i<n;i++)X.push(i);
  for(var i=0;i<steps;i++)Xs.push(n+i);
  function mk(r,c,fn){var A=[];for(var i=0;i<r;i++){A.push([]);for(var j=0;j<c;j++)A[i].push(fn(i,j));}return A;}
  var Kuu=mk(m,m,function(i,j){return k52(Xu[i]-Xu[j])+(i===j?1e-5:0);});
  var Knu=mk(n,m,function(i,j){return k52(X[i]-Xu[j]);});
  var Ksu=mk(steps,m,function(i,j){return k52(Xs[i]-Xu[j]);});
  function chol(A){
    var sz=A.length,L=mk(sz,sz,function(){return 0;});
    for(var i=0;i<sz;i++)for(var j=0;j<=i;j++){
      var s=A[i][j];for(var k=0;k<j;k++)s-=L[i][k]*L[j][k];
      L[i][j]=i===j?Math.sqrt(Math.max(s,1e-14)):s/(L[j][j]||1e-14);
    }return L;
  }
  function solL(L,b){var nn=L.length,x=[];for(var i=0;i<nn;i++){var s=b[i];for(var j=0;j<i;j++)s-=L[i][j]*x[j];x.push(s/(L[i][i]||1e-14));}return x;}
  function solLT(L,b){var nn=L.length,x=new Array(nn).fill(0);for(var i=nn-1;i>=0;i--){var s=b[i];for(var j=i+1;j<nn;j++)s-=L[j][i]*x[j];x[i]=s/(L[i][i]||1e-14);}return x;}
  var Luu=chol(Kuu);
  var W=mk(m,n,function(j,i){return Knu[i][j];}).map(function(col){return solL(Luu,col);});
  var WWT=mk(m,m,function(i,j){var s=0;for(var k=0;k<n;k++)s+=W[i][k]*W[j][k];return s;});
  var Ac=WWT.map(function(row,i){return row.map(function(v,j){return v/sn2+(i===j?1:0);});});
  var La=chol(Ac);
  var Wy=W.map(function(row){var s=0;for(var i=0;i<n;i++)s+=row[i]*cd[i];return s;});
  var v2=solLT(La,solL(La,Wy));
  var Wv2=[];for(var i=0;i<n;i++){var s=0;for(var j=0;j<m;j++)s+=W[j][i]*v2[j];Wv2.push(s);}
  var alpha=cd.map(function(y,i){return y/sn2-Wv2[i]/(sn2*sn2);});
  var Ws=mk(m,steps,function(j,i){return Ksu[i][j];}).map(function(col){return solL(Luu,col);});
  var KnTa=[];for(var j=0;j<m;j++){var s=0;for(var i=0;i<n;i++)s+=Knu[i][j]*alpha[i];KnTa.push(s);}
  var t2=solLT(Luu,solL(Luu,KnTa));
  var path=[];
  for(var s=0;s<steps;s++){
    var mu=0;for(var j=0;j<m;j++)mu+=Ksu[s][j]*t2[j];
    var diag=0;for(var j=0;j<m;j++)diag+=Ws[j][s]*Ws[j][s];
    var va=Math.max(sn2,sigF*sigF-diag+sn2);
    var v=(mu+dm)+grnd()*Math.sqrt(va);
    if(set.length)v=snap(v,set);path.push(v);
  }
  return path;
}

/* ── METHOD 7: PARTICLE FILTER (SMC) ── */
function particlePredict(data,steps,set,nP){
  nP=nP||200;
  var sN=std(data)||0.1,a1v=acf1(data),mn=mean(data),tN=sN*Math.max(0.05,1-Math.abs(a1v));
  function llik(obs,x){var d=obs-x;return -0.5*d*d/(sN*sN*0.25+1e-10);}
  var pt=[];for(var i=0;i<nP;i++)pt.push(data[0]+grnd()*sN*0.3);
  for(var t=1;t<data.length;t++){
    for(var i=0;i<nP;i++)pt[i]=pt[i]*a1v+mn*(1-Math.abs(a1v))+grnd()*tN;
    var lw=pt.map(function(x){return llik(data[t],x);}),mxlw=Math.max.apply(null,lw);
    var rw=lw.map(function(l){return Math.exp(l-mxlw);}),sw=0;
    for(var i=0;i<nP;i++)sw+=rw[i];
    var wt=rw.map(function(w){return w/sw;}),cw=[],acc=0;
    for(var i=0;i<nP;i++){acc+=wt[i];cw.push(acc);}
    var u0=Math.random()/nP,np=[],ci=0;
    for(var k=0;k<nP;k++){
      var tgt=u0+k/nP;while(ci<nP-1&&cw[ci]<tgt)ci++;
      np.push(pt[ci]+grnd()*tN*0.1);
    }
    pt=np;
  }
  var path=[];
  for(var s=0;s<steps;s++){
    for(var i=0;i<nP;i++)pt[i]=pt[i]*a1v+mn*(1-Math.abs(a1v))+grnd()*tN;
    var so=pt.slice().sort(function(a,b){return a-b;});
    var v=so[Math.floor(nP/2)];if(set.length)v=snap(v,set);path.push(v);
  }
  return path;
}

/* ── METHOD 8: N-HiTS ── */
function nhitsPredict(data,steps,set){
  var n=data.length,dm=mean(data),ds=std(data)||1;
  var norm=data.map(function(v){return(v-dm)/ds;});
  function basis(t,H,nPoly,nFreq){
    var b=[1];
    for(var p=1;p<=nPoly;p++)b.push(Math.pow(t/H,p));
    for(var k=1;k<=nFreq;k++){b.push(Math.sin(2*Math.PI*k*t/H));b.push(Math.cos(2*Math.PI*k*t/H));}
    return b;
  }
  function ols(X,y){
    var nb=X[0].length,ns=X.length,XtX=[],Xty=[];
    for(var i=0;i<nb;i++){XtX.push([]);for(var j=0;j<nb;j++)XtX[i].push(0);Xty.push(0);}
    for(var r=0;r<ns;r++)for(var i=0;i<nb;i++){Xty[i]+=X[r][i]*y[r];for(var j=0;j<nb;j++)XtX[i][j]+=X[r][i]*X[r][j];}
    for(var i=0;i<nb;i++)XtX[i][i]+=1e-4;
    var aug=XtX.map(function(row,i){return row.concat([Xty[i]]);});
    for(var col=0;col<nb;col++){
      var piv=col;for(var row=col+1;row<nb;row++)if(Math.abs(aug[row][col])>Math.abs(aug[piv][col]))piv=row;
      var tmp=aug[col];aug[col]=aug[piv];aug[piv]=tmp;
      var d=aug[col][col]||1e-12;
      for(var row=0;row<nb;row++)if(row!==col){var f=aug[row][col]/d;for(var k=0;k<=nb;k++)aug[row][k]-=f*aug[col][k];}
      for(var k=0;k<=nb;k++)aug[col][k]/=d;
    }
    return aug.map(function(row){return row[nb];});
  }
  var cfgs=[[1,2,3],[2,1,2],[4,1,1]],res=norm.slice(),outs=[];
  for(var sc=0;sc<cfgs.length;sc++){
    var pool=cfgs[sc][0],nPoly=cfgs[sc][1],nFreq=cfgs[sc][2];
    var pooled=[],rDown=[];
    for(var i=0;i<n;i+=pool){
      var chunk=norm.slice(i,Math.min(i+pool,n));
      var rchunk=res.slice(i,Math.min(i+pool,n));
      pooled.push(mean(chunk));rDown.push(mean(rchunk));
    }
    var np=pooled.length;if(np<3)continue;
    var lb=Math.min(np,Math.max(4,Math.floor(np*0.5)));
    var rw=rDown.slice(-lb),H=steps;
    var Xlb=[];for(var t=0;t<lb;t++)Xlb.push(basis(t,lb,nPoly,nFreq));
    var beta=ols(Xlb,rw);
    var Xfw=[];for(var t=0;t<H;t++)Xfw.push(basis(t,H,nPoly,nFreq));
    var fc=Xfw.map(function(b){var s=0;for(var i=0;i<b.length;i++)s+=b[i]*beta[i];return s;});
    outs.push(fc);
    var bc=Xlb.map(function(b){var s=0;for(var i=0;i<b.length;i++)s+=b[i]*beta[i];return s;});
    var start=n-lb*pool;
    for(var i=0;i<lb*pool&&start+i<n;i++){
      var bi=Math.floor(i/pool);if(bi<bc.length)res[start+i]-=bc[bi];
    }
  }
  if(!outs.length)return arPredict(data,fitAR(data,3),steps,ds*0.3,set);
  var rStd=std(res)||0.01;
  var path=[];
  for(var s=0;s<steps;s++){
    var sum=0;for(var i=0;i<outs.length;i++)sum+=(outs[i][s]||0);
    var v=sum*ds+dm+grnd()*rStd*ds;
    if(set.length)v=snap(v,set);path.push(v);
  }
  return path;
}

/* ── METHOD 9: GRU + MC-DROPOUT ── */
async function gruPredict(data,steps,set,nRep){
  nRep=nRep||120;
  var seqLen=Math.min(10,Math.max(3,Math.floor(data.length*0.4)));
  if(data.length<seqLen+4){
    return Array.from({length:nRep},function(){return kalmanPredict(data,steps,set);});
  }
  /* --- normalize --- */
  var mn2=Math.min.apply(null,data),mx=Math.max.apply(null,data),rng=mx-mn2||1;
  _lstmNrm={min:mn2,range:rng};
  var nm=data.map(function(v){return(v-mn2)/rng;});
  var Xs=[],Ys=[];
  for(var i=0;i<nm.length-seqLen;i++){Xs.push(nm.slice(i,i+seqLen));Ys.push(nm[i+seqLen]);}
  if(Xs.length<4){
    return Array.from({length:nRep},function(){return kalmanPredict(data,steps,set);});
  }
  /* --- build & train --- */
  setP(10,'GRU: TF.js hazırlanıyor…');
  try{await tf.ready();}catch(e){}
  await sleep(60);
  if(_lstmMdl){try{_lstmMdl.dispose();}catch(e){}_lstmMdl=null;}
  var mdl=tf.sequential();
  mdl.add(tf.layers.gru({units:16,inputShape:[seqLen,1],returnSequences:false}));
  mdl.add(tf.layers.dropout({rate:0.2}));
  mdl.add(tf.layers.dense({units:8,activation:'relu'}));
  mdl.add(tf.layers.dropout({rate:0.15}));
  mdl.add(tf.layers.dense({units:1}));
  mdl.compile({optimizer:tf.train.adam(0.02),loss:'mse'});
  var xT=tf.tensor3d(Xs.map(function(s){return s.map(function(v){return[v];});}));
  var yT=tf.tensor2d(Ys.map(function(v){return[v];}));
  var epochs=40,trainOk=false;
  try{
    await mdl.fit(xT,yT,{
      epochs:epochs,batchSize:Math.min(16,Xs.length),shuffle:true,
      callbacks:{onEpochEnd:async function(ep,logs){
        setP(18+(ep/epochs)*46,'GRU eğitim — epoch '+(ep+1)+'/'+epochs+(logs&&logs.loss?' | loss:'+logs.loss.toFixed(5):''));
        await new Promise(function(r){setTimeout(r,0);});
      }}
    });
    trainOk=true;
  }catch(e){console.warn('GRU train err:',e);}
  xT.dispose();yT.dispose();
  if(!trainOk){
    try{mdl.dispose();}catch(e){}
    return Array.from({length:nRep},function(){return kalmanPredict(data,steps,set);});
  }
  _lstmMdl=mdl;
  /* --- MC-Dropout inference --- */
  var seed=nm.slice(-seqLen),allPaths=[];
  for(var r=0;r<nRep;r++){
    var seq=seed.slice(),path=[];
    for(var s=0;s<steps;s++){
      var val=tf.tidy(function(){
        var inp=tf.tensor3d([seq.slice(-seqLen).map(function(v){return[v];})]);
        return _lstmMdl.predict(inp,{training:true}).dataSync()[0];
      });
      var dv=val*rng+mn2;
      path.push(set.length?snap(dv,set):dv);
      seq.push(val);
    }
    allPaths.push(path);
    if(r%15===0){setP(66+(r/nRep)*28,'MC-Dropout: '+r+'/'+nRep);await new Promise(function(res){setTimeout(res,0);});}
  }
  return allPaths;
}

/* ── ENSEMBLE ── */
function getEnsembleMethods(){
  var methods=[];
  if($('ec_mc').checked)    methods.push('mc');
  if($('ec_arima').checked) methods.push('arima');
  if($('ec_holt').checked)  methods.push('holt');
  if($('ec_nbwin').checked) methods.push('nbwin');
  if($('ec_kalman').checked)methods.push('kalman');
  if($('ec_gp').checked)    methods.push('gp');
  if($('ec_particle').checked)methods.push('particle');
  if($('ec_nhits').checked) methods.push('nhits');
  if(methods.length<1)methods=['mc','arima','holt','nbwin'];
  return methods;
}

function ensemblePath(data,steps,set,T,phi,nStd,methods){
  var paths=[];
  for(var mi=0;mi<methods.length;mi++){
    var m=methods[mi],p;
    if(m==='mc')      p=mcPredict(data,steps,set,T);
    else if(m==='arima')  p=arPredict(data,phi,steps,nStd*0.4,set);
    else if(m==='holt')   p=holtPredict(data,steps,set,nStd*0.4);
    else if(m==='nbwin')  p=nbPredict(data,steps,set);
    else if(m==='kalman') p=kalmanPredict(data,steps,set);
    else if(m==='gp')     p=gpPredict(data,steps,set);
    else if(m==='particle')p=particlePredict(data,steps,set,150);
    else if(m==='nhits')  p=nhitsPredict(data,steps,set);
    else p=mcPredict(data,steps,set,T);
    paths.push(p);
  }
  return Array.from({length:steps},function(_,s){
    var vals=paths.map(function(p){return p[s];});
    if(set.length){
      var freq={};
      vals.forEach(function(v){var k=snap(v,set).toString();freq[k]=(freq[k]||0)+1;});
      return parseFloat(Object.entries(freq).sort(function(a,b){return b[1]-a[1];})[0][0]);
    }
    return mean(vals);
  });
}

/* ── MAIN ANALYSIS ── */
async function runAnalysis(){
  /* parse inputs */
  _data=parseSeries();
  if(_data.length<6){alert('En az 6 veri noktası gerekli.');return;}
  var nPred=+$('rN').value,method=$('method').value;
  var mcRep=+$('rMC').value,conf=+$('bandConf').value,alpha=(1-conf)/2;
  var effSet=_set.length?_set:[...new Set(_data)].sort(function(a,b){return a-b;});

  /* stats */
  var bad=_set.length?_data.filter(function(v){return!_set.some(function(s){return Math.abs(s-v)<1e-9;});}).length:0;
  var m=mean(_data),s=std(_data),a1=acf1(_data),tr=linTrend(_data),ent=entropy(_data,effSet);

  $('stLen').textContent=_data.length;
  $('stSetN').textContent=_set.length||'—';
  var bEl=$('stBad');bEl.textContent=bad;bEl.className='si-val'+(bad>0?' err':'');
  $('stMean').textContent=m.toFixed(3);
  $('stStd').textContent=s.toFixed(3);
  $('stAcf').textContent=a1.toFixed(3);
  $('stEnt').textContent=ent.toFixed(2);
  var tEl=$('stTrend');
  if(Math.abs(tr)<0.0005){tEl.textContent='→ Sabit';tEl.className='si-val';}
  else if(tr>0){tEl.textContent='↑ Yükselen';tEl.className='si-val ok';}
  else{tEl.textContent='↓ Düşen';tEl.className='si-val err';}

  /* hide results, show progress */
  ['sec_table','sec_chart1','sec_results','sec_chart2','sec_info'].forEach(hide);
  show('progWrap');
  setP(4,'Modeller hazırlanıyor…');await sleep(20);

  var T=buildTrans(_data,effSet);
  var phi=fitAR(_data,Math.min(6,Math.floor(_data.length*0.3)));
  var nStd=s*Math.max(0.05,1-Math.abs(a1));
  var ensMethods=getEnsembleMethods();

  var simPaths=[];

  try{
    if(method==='lstm'){
      var lstmPaths=await gruPredict(_data,nPred,effSet,Math.min(mcRep,150));
      simPaths=lstmPaths;
      setP(97,'Sonuçlar…');await sleep(10);
    } else {
      setP(10,'Simülasyonlar başlıyor…');await sleep(10);
      var bSz=80;
      for(var i=0;i<mcRep;i+=bSz){
        var nb=Math.min(bSz,mcRep-i);
        for(var b=0;b<nb;b++){
          var path;
          if     (method==='mc')      path=mcPredict(_data,nPred,effSet,T);
          else if(method==='arima')   path=arPredict(_data,phi,nPred,nStd*0.4,effSet);
          else if(method==='holt')    path=holtPredict(_data,nPred,effSet,nStd*0.4);
          else if(method==='nbwin')   path=nbPredict(_data,nPred,effSet);
          else if(method==='kalman')  path=kalmanPredict(_data,nPred,effSet);
          else if(method==='gp')      path=gpPredict(_data,nPred,effSet);
          else if(method==='particle')path=particlePredict(_data,nPred,effSet,150);
          else if(method==='nhits')   path=nhitsPredict(_data,nPred,effSet);
          else                        path=ensemblePath(_data,nPred,effSet,T,phi,nStd,ensMethods);
          simPaths.push(path);
        }
        setP(10+((i+bSz)/mcRep)*80,'Simülasyon: '+Math.min(i+bSz,mcRep)+'/'+mcRep);
        await sleep(0);
      }
    }
  } catch(e){
    console.error('Analysis error:',e);
    alert('Hata: '+e.message);
    hide('progWrap');
    return;
  }

  if(!simPaths.length){alert('Simülasyon üretilemedi.');hide('progWrap');return;}

  setP(92,'Sonuçlar hesaplanıyor…');await sleep(10);

  /* percentiles */
  var predMed=[],predLo=[],predHi=[];
  for(var st=0;st<nPred;st++){
    var vals=simPaths.map(function(p){return p[st];});
    predMed.push(pct(vals,.5));
    predLo.push(pct(vals,alpha));
    predHi.push(pct(vals,1-alpha));
  }

  /* 2D probability */
  var prob2d=Array.from({length:nPred},function(_,step){
    var vals=simPaths.map(function(p){return p[step];});
    var cnt={};effSet.forEach(function(v){cnt[v]=0;});
    vals.forEach(function(v){var k=snap(v,effSet);cnt[k]=(cnt[k]||0)+1;});
    return effSet.map(function(v){return(cnt[v]||0)/vals.length;});
  });

  setP(97,'Grafikler çiziliyor…');await sleep(10);

  drawChart1(predMed,predLo,predHi,bad,effSet);
  drawChart2(predMed,predLo,predHi);
  renderTable(prob2d,effSet,nPred);
  renderResults(predMed,predLo,predHi,nPred,bad,m,s,a1,tr,method,simPaths.length,conf,ent,effSet,ensMethods);

  setP(100,'Tamamlandı ✔','100%');
  ['sec_table','sec_chart1','sec_results','sec_chart2','sec_info'].forEach(show);
  $('sec_results').style.display='grid';
}

/* ── CHART 1: Raw + Forecast ── */
function drawChart1(predMed,predLo,predHi,bad,effSet){
  if(_chart1){_chart1.destroy();_chart1=null;}
  var ctx=$('chart1').getContext('2d');
  var oLen=_data.length;
  var labels=Array.from({length:oLen+predMed.length},function(_,i){return i;});
  var obs=[].concat(_data,Array(predMed.length).fill(null));
  var med=[].concat(Array(oLen-1).fill(null),[_data[oLen-1]],predMed);
  var lo=[].concat(Array(oLen-1).fill(null),[_data[oLen-1]],predLo);
  var hi=[].concat(Array(oLen-1).fill(null),[_data[oLen-1]],predHi);
  var inv=_set.length?_data.map(function(v){return _set.some(function(s){return Math.abs(s-v)<1e-9;})?null:v;}):_data.map(function(){return null;});
  inv=inv.concat(Array(predMed.length).fill(null));
  _chart1=new Chart(ctx,{type:'line',data:{labels:labels,datasets:[
    {label:'BandHi',data:hi,borderColor:'transparent',backgroundColor:'rgba(31,122,69,.10)',pointRadius:0,fill:'+1',tension:.35},
    {label:'BandLo',data:lo,borderColor:'rgba(31,122,69,.25)',borderWidth:1,borderDash:[3,2],backgroundColor:'rgba(31,122,69,.10)',pointRadius:0,fill:false,tension:.35},
    {label:'Medyan',data:med,borderColor:'#1f7a45',borderWidth:2.5,borderDash:[6,3],pointRadius:0,fill:false,tension:.35},
    {label:'Gözlem',data:obs,borderColor:'#1a5c8a',borderWidth:2,pointRadius:2.5,pointBackgroundColor:'#1a5c8a',fill:false,tension:.2},
    {label:'Geçersiz',type:'scatter',data:inv,backgroundColor:'rgba(184,50,50,.8)',borderColor:'transparent',pointRadius:5,pointStyle:'crossRot',fill:false},
  ]},options:{
    animation:false,responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},
      tooltip:{mode:'index',intersect:false,callbacks:{label:function(c){return c.parsed.y!=null?c.dataset.label+': '+c.parsed.y.toFixed(4):null;}}},
      zoom:{pan:{enabled:true,mode:'x'},zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'}}
    },
    scales:{
      x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'#6e6050',font:{family:'Space Mono',size:9},maxTicksLimit:14},title:{display:true,text:'Adım',color:'#6e6050',font:{family:'Space Mono',size:9}}},
      y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'#6e6050',font:{family:'Space Mono',size:9},maxTicksLimit:8}}
    },elements:{point:{radius:0}}
  }});
}
function c1zi(){if(_chart1)_chart1.zoom(1.35);}
function c1zo(){if(_chart1)_chart1.zoom(0.75);}
function c1zr(){if(_chart1)_chart1.resetZoom();}

/* ── CHART 2: Cumulative ── */
function drawChart2(predMed,predLo,predHi){
  if(_chart2){_chart2.destroy();_chart2=null;}
  var ctx=$('chart2').getContext('2d');
  var oLen=_data.length;
  /* build cumulative series */
  var cumObs=[],acc=0;
  for(var i=0;i<oLen;i++){acc+=_data[i];cumObs.push(acc);}
  /* cumulative forecast continues from last observed cumulative */
  var cumMed=[],cumLo=[],cumHi=[];
  var baseAcc=acc;
  var accMed=baseAcc,accLo=baseAcc,accHi=baseAcc;
  for(var i=0;i<predMed.length;i++){
    accMed+=predMed[i];cumMed.push(accMed);
    accLo+=predLo[i];  cumLo.push(accLo);
    accHi+=predHi[i];  cumHi.push(accHi);
  }
  var labels=Array.from({length:oLen+predMed.length},function(_,i){return i;});
  /* observed series padded with null for forecast zone */
  var obsDs=[].concat(cumObs,Array(predMed.length).fill(null));
  /* forecast series padded with null for observation zone, bridged at last obs */
  var medDs=[].concat(Array(oLen-1).fill(null),[cumObs[oLen-1]],cumMed);
  var loDs= [].concat(Array(oLen-1).fill(null),[cumObs[oLen-1]],cumLo);
  var hiDs= [].concat(Array(oLen-1).fill(null),[cumObs[oLen-1]],cumHi);
  _chart2=new Chart(ctx,{type:'line',data:{labels:labels,datasets:[
    {label:'TahminBandHi',data:hiDs,borderColor:'transparent',backgroundColor:'rgba(192,122,0,.12)',pointRadius:0,fill:'+1',tension:.35},
    {label:'TahminBandLo',data:loDs,borderColor:'rgba(192,122,0,.3)',borderWidth:1,borderDash:[3,2],backgroundColor:'rgba(192,122,0,.12)',pointRadius:0,fill:false,tension:.35},
    {label:'Tahmin Medyan',data:medDs,borderColor:'#c07a00',borderWidth:2.5,borderDash:[6,3],pointRadius:0,fill:false,tension:.35},
    {label:'Gözlem (kümülatif)',data:obsDs,borderColor:'#1a5c8a',borderWidth:2,pointRadius:2,pointBackgroundColor:'#1a5c8a',fill:false,tension:.2},
  ]},options:{
    animation:false,responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},
      tooltip:{mode:'index',intersect:false,callbacks:{label:function(c){return c.parsed.y!=null?c.dataset.label+': '+c.parsed.y.toFixed(4):null;}}},
      zoom:{pan:{enabled:true,mode:'x'},zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'}}
    },
    scales:{
      x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'#6e6050',font:{family:'Space Mono',size:9},maxTicksLimit:14},title:{display:true,text:'Adım',color:'#6e6050',font:{family:'Space Mono',size:9}}},
      y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'#6e6050',font:{family:'Space Mono',size:9},maxTicksLimit:8},title:{display:true,text:'Kümülatif Toplam',color:'#6e6050',font:{family:'Space Mono',size:9}}}
    },elements:{point:{radius:0}}
  }});
}
function c2zi(){if(_chart2)_chart2.zoom(1.35);}
function c2zo(){if(_chart2)_chart2.zoom(0.75);}
function c2zr(){if(_chart2)_chart2.resetZoom();}

/* ── FULLSCREEN ── */
function toggleFS(cardId,btnId){
  var c=$('sec_chart1');
  var isFs;
  if(cardId==='chartCard1'){
    c=$('sec_chart1');
    isFs=c.classList.toggle('fullscreen');
    $(btnId).textContent=isFs?'✕':'⛶';
    setTimeout(function(){if(_chart1)_chart1.resize();},50);
  } else {
    c=$('sec_chart2');
    isFs=c.classList.toggle('fullscreen');
    $(btnId).textContent=isFs?'✕':'⛶';
    setTimeout(function(){if(_chart2)_chart2.resize();},50);
  }
}
document.addEventListener('keydown',function(e){
  if(e.key==='Escape'){
    [$('sec_chart1'),$('sec_chart2')].forEach(function(c,i){
      if(c.classList.contains('fullscreen')){
        c.classList.remove('fullscreen');
        $(i===0?'fs1btn':'fs2btn').textContent='⛶';
        setTimeout(function(){if(i===0&&_chart1)_chart1.resize();else if(_chart2)_chart2.resize();},50);
      }
    });
  }
});

/* ── 2D TABLE ── */
function renderTable(prob2d,effSet,nPred){
  var nC=effSet.length,nR=nPred;
  /* column max for blue heat (column-normalized) */
  var colMax=Array.from({length:nC},function(_,ci){
    return Math.max.apply(null,prob2d.map(function(row){return row[ci];}))|| 1e-9;
  });
  /* row best index (green border) */
  var rowBest=prob2d.map(function(row){
    var best=0;row.forEach(function(p,i){if(p>row[best])best=i;});return best;
  });
  /* col best row index (amber border) */
  var colBest=Array.from({length:nC},function(_,ci){
    var best=0;prob2d.forEach(function(row,ri){if(row[ci]>prob2d[best][ci])best=ri;});return best;
  });
  var hdr='<tr><th class="rh" style="min-width:64px;text-align:left;padding-left:10px;">Adım ↓ / Değer →</th>'+
    effSet.map(function(v){return '<th>'+v+'</th>';}).join('')+
    '<th class="rh">En Olası</th><th class="rh">2. Olası</th></tr>';
  var rows=prob2d.map(function(row,ri){
    var ranked=row.map(function(p,i){return{p:p,i:i};}).sort(function(a,b){return b.p-a.p;});
    var best=ranked[0],sec=ranked[1]||ranked[0];
    var cells=row.map(function(p,ci){
      var pStr=(p*100).toFixed(1);
      var norm=colMax[ci]>0?p/colMax[ci]:0;
      var r=Math.round(248-norm*118),g=Math.round(245-norm*100),b=Math.round(255-norm*50);
      var bg='rgb('+r+','+g+','+b+')';
      var tc=norm>0.58?'#fff':'var(--ink)';
      var isRB=(ci===rowBest[ri]),isCB=(ri===colBest[ci]);
      var extra='';
      if(isRB&&isCB) extra='outline:3px solid #1f7a45;outline-offset:-1px;box-shadow:inset 0 0 0 4px #c07a00;';
      else if(isRB)  extra='outline:3px solid #1f7a45;outline-offset:-1px;';
      else if(isCB)  extra='outline:3px solid #c07a00;outline-offset:-1px;';
      return '<td style="background:'+bg+';color:'+tc+';'+extra+'">'+pStr+'%</td>';
    }).join('');
    return '<tr><td class="sh">t+'+(ri+1)+'</td>'+cells+
      '<td class="bt">'+effSet[best.i]+' <span style="font-size:10px;color:var(--ink3);font-weight:400">('+  (best.p*100).toFixed(1)+'%)</span></td>'+
      '<td class="bs">'+effSet[sec.i]+' <span style="font-size:10px;color:var(--ink3);font-weight:400">('+(sec.p*100).toFixed(1)+'%)</span></td></tr>';
  }).join('');
  $('p2dWrap').innerHTML='<table class="p2d"><thead>'+hdr+'</thead><tbody>'+rows+'</tbody></table>';
  $('tblLeg').innerHTML=
    '<div class="tll"><div class="tlb" style="background:rgb(130,145,205)"></div><span><b>Koyu mavi</b> = o <u>sütun (değer)</u> içinde en yüksek görülme — sütun bazı normalize</span></div>'+
    '<div class="tll"><div class="tlb" style="outline:3px solid #1f7a45;outline-offset:-1px"></div><span><b>Yeşil çerçeve</b> = o satırda en yüksek %</span></div>'+
    '<div class="tll"><div class="tlb" style="outline:3px solid #c07a00;outline-offset:-1px"></div><span><b>Sarı çerçeve</b> = o sütunda en yüksek %</span></div>'+
    '<div class="tll"><div class="tlb" style="outline:3px solid #1f7a45;outline-offset:-1px;box-shadow:inset 0 0 0 4px #c07a00"></div><span><b>İç içe</b> = her ikisinde de zirve</span></div>';
}

/* ── RESULTS ── */
function renderResults(predMed,predLo,predHi,nPred,bad,m,s,a1,tr,method,nSim,conf,ent,effSet,ensMethods){
  var last=_data[_data.length-1],fMed=predMed[nPred-1],fLo=predLo[nPred-1],fHi=predHi[nPred-1];
  var acfI=Math.abs(a1)>0.5?'Güçlü':Math.abs(a1)>0.2?'Orta':'Zayıf';
  var freq={};_data.forEach(function(v){var k=v.toString();freq[k]=(freq[k]||0)+1;});
  var top=Object.entries(freq).sort(function(a,b){return b[1]-a[1];})[0];
  var mnames={mc:'MC Markov',arima:'ARIMA AR(p)',holt:'Holt ES',nbwin:'Naive Bayes',
    kalman:'Kalman Filter',gp:'Gauss. Process',particle:'Particle Filter',
    nhits:'N-HiTS',lstm:'GRU+MC-Dropout',combined:'Ensemble'};
  var methodStr=mnames[method]||(method);
  if(method==='combined') methodStr='Ensemble ['+ensMethods.map(function(x){return mnames[x]||x;}).join(', ')+']';

  $('findings').innerHTML=
    '<div class="fr"><span class="fr-l">En sık değer</span><span class="fr-r ok">'+top[0]+' (%'+((top[1]/_data.length)*100).toFixed(1)+')</span></div>'+
    '<div class="fr"><span class="fr-l">ACF(1)</span><span class="fr-r '+(Math.abs(a1)>0.3?'ok':'warn')+'">'+a1.toFixed(4)+' — '+acfI+' otokor.</span></div>'+
    '<div class="fr"><span class="fr-l">Entropi</span><span class="fr-r '+(ent>2?'warn':'')+'">'+ent.toFixed(3)+' / '+Math.log2(effSet.length||1).toFixed(2)+' bit max</span></div>'+
    '<div class="fr"><span class="fr-l">Trend</span><span class="fr-r">'+tr.toFixed(5)+'/adım</span></div>'+
    '<div class="fr"><span class="fr-l">Geçersiz</span><span class="fr-r '+(bad>0?'err':'')+'">'+bad+(bad>0?' ⚠':''  )+'</span></div>'+
    '<div class="fr"><span class="fr-l">Yöntem</span><span class="fr-r">'+methodStr+'</span></div>'+
    '<div class="fr"><span class="fr-l">Simülasyon</span><span class="fr-r">'+nSim.toLocaleString()+' yol</span></div>';

  var fMedS=typeof fMed==='number'?fMed.toFixed(4):fMed;
  var fLoS=typeof fLo==='number'?fLo.toFixed(4):fLo;
  var fHiS=typeof fHi==='number'?fHi.toFixed(4):fHi;
  $('predSummary').innerHTML=
    '<div class="fr"><span class="fr-l">Son gözlem</span><span class="fr-r">'+last+'</span></div>'+
    '<div class="fr"><span class="fr-l">t+'+nPred+' medyan</span><span class="fr-r ok">'+fMedS+'</span></div>'+
    '<div class="fr"><span class="fr-l">Alt %'+(conf*100).toFixed(0)+'</span><span class="fr-r warn">'+fLoS+'</span></div>'+
    '<div class="fr"><span class="fr-l">Üst %'+(conf*100).toFixed(0)+'</span><span class="fr-r warn">'+fHiS+'</span></div>'+
    '<div class="fr"><span class="fr-l">Yön</span><span class="fr-r '+(fMed>last?'ok':fMed<last?'err':'')+'">'+  (fMed>last?'↑ Yükselen':fMed<last?'↓ Düşen':'→ Sabit')+'</span></div>'+
    '<div class="fr"><span class="fr-l">Belirsizlik ±</span><span class="fr-r">'+((fHi-fLo)/2).toFixed(4)+'</span></div>';

  /* infoBox */
  var bestM=Math.abs(a1)>0.6?'Kalman Filter':Math.abs(a1)>0.4?'MC Markov':ent<0.8?'Naive Bayes':ent>2.5?'Particle Filter':'Ensemble';
  $('sec_info').innerHTML=
    '<h4>📊 2B TABLO NASIL OKUNUR?</h4>'+
    '<div class="mrow"><b>Mavi yoğunluğu sütun bazlı normalize edilir.</b> Her sütunun kendi içindeki en yüksek değer en koyu mavi alır. O değerin tüm adımlar içinde hangi adımda zirve yaptığını gösterir.</div>'+
    '<div class="mrow"><b>% sayısı</b> → o adımda o değerin simülasyonlardaki görülme oranı. Örneğin %65 → 2000 simülasyonun 1300\'ü o adımda o değeri vermiş.</div>'+
    '<div class="mrow"><b>🟢 Yeşil çerçeve</b> = o satırda (adımda) en yüksek % → "bu adımda en olası değer"</div>'+
    '<div class="mrow"><b>🟡 Sarı çerçeve</b> = o sütunda (değerde) en yüksek % → "bu değerin zirve yaptığı adım"</div>'+
    '<div class="mrow"><b>İç içe çerçeve</b> = hem satırda hem sütunda zirve — çift kazanan hücre.</div>'+
    '<h4>📈 KÜMÜLATİF GRAFİK</h4>'+
    '<div class="mrow">Alt grafik, tüm gözlem değerlerinin kümülatif toplamını ve tahmin adımlarının kümülatif devamını gösterir. Mavi = gözlem kümülatifi, Turuncu kesik çizgi = tahmin medyanı kümülatifi, bant = güven aralığı. Toplam büyüme eğilimini ve tahmin belirsizliğinin kümülatif etkisini görselleştirir.</div>'+
    '<h4>🔬 9 ANALİZ YÖNTEMİ</h4>'+
    '<div class="mrow"><span class="mn">MC Markov Zinciri</span> — geçmiş geçiş sıklıklarından olasılık matrisi. Adım kümeli seriler için hızlı ve etkili.</div>'+
    '<div class="mrow"><span class="mn">ARIMA AR(p)</span> — Yule-Walker otoregresif katsayılar; son p gözleme göre doğrusal tahmin. Güçlü ACF varsa iyi.</div>'+
    '<div class="mrow"><span class="mn">Holt Exp. Smoothing</span> — α=0.3 seviye + β=0.1 trend. Yavaş değişen serilerde kararlı.</div>'+
    '<div class="mrow"><span class="mn">Naive Bayes (Pencere-3)</span> — son 3 değerin bağlamına göre sonraki dağılım. Kısa örüntü tekrarlayan serilerde güçlü.</div>'+
    '<div class="mrow"><span class="mn">Kalman Filter</span> — [seviye, trend] gizli durum; R ve Q gürültüsü veriden otomatik. Gürültülü + otokorele seriler için teorik en iyi.</div>'+
    '<div class="mrow"><span class="mn">Gaussian Process (Matérn 5/2)</span> — kernel Bayesian regresyon. Mean-centered çalışır (snap-to-zero hatası yok). FITC inducing-point yaklaşımı.</div>'+
    '<div class="mrow"><span class="mn">Particle Filter (SMC)</span> — 200 parçacık, sistematik yeniden örnekleme. Non-linear, non-Gaussian. Adım kümeli seriler için teorik en doğru.</div>'+
    '<div class="mrow"><span class="mn">N-HiTS</span> — 3 stack (pooling 1×/2×/4×), her stack polinom + Fourier bazında artık regresyonu. Sinyal bileşenlerini hiyerarşik ayrıştırır.</div>'+
    '<div class="mrow"><span class="mn">GRU + MC-Dropout</span> — tf.js GRU (16 unit, 40 epoch). tf.ready()+warmup ile başlar. Test zamanı dropout=ON → 120 forward pass → Bayesian belirsizlik.</div>'+
    '<div class="mrow"><span class="mn">Ensemble</span> — Seçilen yöntemlerin çoğunluk oylaması. Hangi yöntemlerin dahil edileceği kontrol edilebilir.</div>'+
    '<br>Entropi = <strong>'+ent.toFixed(3)+' bit</strong> → '+
    (ent<0.5?'çok düzenli, tahmin kolay':ent<1.5?'orta belirsizlik':ent<2.5?'yüksek belirsizlik':'çok belirsiz, tahmin güç')+
    '. &nbsp;Önerilen: <strong>'+bestM+'</strong>.'+
    (bad>0?'<br><br><span style="color:var(--red)">⚠ '+bad+' nokta adım kümesi dışında — veriyi kontrol et.</span>':'');
}

/* ── EXAMPLE ── */
function loadExample(){
  $('setInput').value='3, 3.2, 3.4, 3.6';
  parseSetInput();
  $('seriesInput').value=
    '3,3,3.2,3.2,3.4,3.4,3.4,3.2,3.2,3,3,3,3.2,3.4,3.6,3.6,3.4,3.4,3.2,3.2,'+
    '3,3,3.2,3.2,3.4,3.4,3.6,3.6,3.4,3.2,3,3,3.2,3.4,3.4,3.2,3.2,3,3,3.2';
  $('rN').value=8;$('vN').textContent='8';
  $('method').value='combined';
  onMethodChange();
}
</script>
</body>
</html>
