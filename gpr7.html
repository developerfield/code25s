<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>GPR¬∑PRO¬∑EXPLORER</title><link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;600;700&family=VT323&display=swap" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script><style>
:root{--bg:#0b0d0f;--s1:#111416;--s2:#161a1d;--b:#1e2428;--b2:#252c30;--p:#4ade80;--am:#f59e0b;--rd:#ef4444;--bl:#38bdf8;--cy:#22d3ee;--t:#c8d4cc;--t2:#6b8070;--t3:#3d5040;--glo:rgba(74,222,128,.12);}
body.light{--bg:#f0f4f0;--s1:#e8ede8;--s2:#dfe6df;--b:#c8d4c8;--b2:#b8c8b8;--t:#1a2e1a;--t2:#4a6448;--t3:#8aaa88;--glo:rgba(74,222,128,.08);}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;background:var(--bg);}
body{font-family:'Inconsolata',monospace;color:var(--t);font-size:12px;}
.app{display:grid;grid-template-columns:190px 1fr;height:100vh;}
.sb{background:var(--s1);border-right:1px solid var(--b);display:flex;flex-direction:column;overflow:hidden;}
.sb-head{padding:5px 8px;border-bottom:1px solid var(--b);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.logo{font-family:'VT323',monospace;font-size:1.4rem;color:var(--p);text-shadow:0 0 8px var(--glo);letter-spacing:2px;}
.sb-scroll{flex:1;overflow-y:auto;padding:5px 7px;display:flex;flex-direction:column;gap:5px;}
.sb-scroll::-webkit-scrollbar{width:3px;}.sb-scroll::-webkit-scrollbar-thumb{background:var(--b2);}
.sb-foot{padding:3px 8px;border-top:1px solid var(--b);font-size:.6rem;color:var(--t3);display:flex;gap:8px;flex-shrink:0;}
.blk{background:var(--s2);border:1px solid var(--b);padding:5px 7px;}
.blk-t{font-size:.58rem;color:var(--t3);letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;}
.blk-t:hover{color:var(--t2);}
.blk-body{overflow:hidden;transition:max-height .2s ease;}
.blk-body.collapsed{max-height:0!important;}
textarea,select,input[type=text],input[type=number]{width:100%;background:var(--bg);border:1px solid var(--b);color:var(--t);font-family:'Inconsolata',monospace;font-size:.7rem;padding:3px 5px;outline:none;transition:border .12s;}
textarea{resize:vertical;min-height:48px;}
textarea:focus,select:focus,input:focus{border-color:var(--p);}
select option{background:var(--bg);}
.row{display:flex;gap:3px;margin-top:3px;}
.row>*{flex:1;}
.btn{background:transparent;border:1px solid var(--b2);color:var(--t2);font-family:'Inconsolata',monospace;font-size:.65rem;padding:2px 6px;cursor:pointer;transition:all .1s;white-space:nowrap;text-align:center;}
.btn:hover{border-color:var(--p);color:var(--p);}
.btn.p{border-color:var(--p);color:var(--p);}
.btn.p:hover{background:var(--p);color:var(--bg);}
.btn.am{border-color:var(--am);color:var(--am);}
.btn.am:hover{background:var(--am);color:var(--bg);}
.btn.act{background:var(--b2);border-color:var(--p);color:var(--p);}
.btn:disabled{opacity:.3;cursor:not-allowed;}
.sl-row{margin-bottom:4px;}
.sl-h{display:flex;justify-content:space-between;font-size:.6rem;color:var(--t2);margin-bottom:1px;}
.sl-h span:last-child{color:var(--p);}
.sl-wrap{display:flex;gap:3px;align-items:center;}
.sl-wrap input[type=range]{flex:1;accent-color:var(--p);height:3px;cursor:pointer;}
.sl-wrap input[type=number]{width:46px;flex:none;font-size:.62rem;padding:2px 3px;}
.tog-row{display:flex;align-items:center;gap:5px;font-size:.62rem;color:var(--t2);margin-top:2px;}
.tog{width:26px;height:14px;background:var(--bg);border:1px solid var(--b2);position:relative;cursor:pointer;transition:all .15s;flex-shrink:0;}
.tog.on{background:var(--b2);border-color:var(--p);}
.tog::after{content:'';position:absolute;width:8px;height:8px;background:var(--t3);top:2px;left:2px;transition:transform .15s;}
.tog.on::after{background:var(--p);transform:translateX(12px);}
.dp-list{max-height:90px;overflow-y:auto;margin-top:3px;}
.dp-list::-webkit-scrollbar{width:2px;}.dp-list::-webkit-scrollbar-thumb{background:var(--b2);}
.dp-r{display:flex;align-items:center;gap:2px;padding:2px 3px;font-size:.62rem;}
.dp-r:hover{background:var(--b);}
.dp-x{color:var(--p);min-width:30px;}.dp-y{flex:1;}
.dp-acts button{background:none;border:none;color:var(--t3);cursor:pointer;font-size:10px;padding:0 2px;font-family:'Inconsolata',monospace;}
.dp-acts button:hover{color:var(--p);}
.dp-acts .del:hover{color:var(--rd);}
.xyf{display:none;gap:3px;margin-top:3px;align-items:flex-end;}
.xyf label{font-size:.56rem;color:var(--t3);display:block;margin-bottom:1px;}
.ser-r{display:flex;align-items:center;gap:4px;padding:2px 4px;border:1px solid var(--b);font-size:.62rem;margin-bottom:2px;}
.ser-dot{width:6px;height:6px;flex-shrink:0;}
.ser-del{background:none;border:none;color:var(--rd);cursor:pointer;font-size:11px;}
.lml-b{background:var(--bg);border:1px solid var(--b);padding:3px 5px;font-size:.62rem;color:var(--t2);margin-top:3px;}
.lml-b strong{color:var(--p);}
.sgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:2px;margin-top:3px;}
.sc{background:var(--bg);border:1px solid var(--b);padding:3px 5px;}
.sv{font-family:'VT323',monospace;font-size:.9rem;color:var(--p);}
.sl2{font-size:.48rem;color:var(--t3);text-transform:uppercase;letter-spacing:1px;}
.ll{font-size:.58rem;color:var(--t2);max-height:60px;overflow-y:auto;display:flex;flex-direction:column;gap:1px;}
.ll::-webkit-scrollbar{width:2px;}.ll::-webkit-scrollbar-thumb{background:var(--b2);}
.ln{display:flex;gap:4px;}
.ts{color:var(--t3);flex-shrink:0;}
.ok{color:var(--p);}.wa{color:var(--am);}.er{color:var(--rd);}.inf{color:var(--t2);}
.run-btn{width:100%;padding:6px;background:transparent;border:1px solid var(--p);color:var(--p);font-family:'VT323',monospace;font-size:1.05rem;letter-spacing:3px;cursor:pointer;transition:all .15s;margin-top:3px;}
.run-btn:hover:not(:disabled){background:var(--p);color:var(--bg);}
.run-btn:disabled{opacity:.3;cursor:not-allowed;}
.prog{height:2px;background:var(--b);overflow:hidden;}
.pb{height:100%;background:var(--p);width:0;transition:width .2s;}
.ca{position:relative;overflow:hidden;background:var(--bg);}
canvas{display:block;cursor:crosshair;width:100%;height:100%;}
.hud{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:4px;z-index:20;}
.hbtn{background:rgba(11,13,15,.88);border:1px solid var(--b2);color:var(--t2);font-family:'Inconsolata',monospace;font-size:.72rem;padding:5px 9px;cursor:pointer;transition:all .1s;min-width:32px;text-align:center;}
.hbtn:hover{border-color:var(--p);color:var(--p);}
.zi{position:absolute;bottom:10px;left:10px;background:rgba(11,13,15,.8);border:1px solid var(--b);padding:3px 8px;font-size:.6rem;color:var(--t3);pointer-events:none;}
.chi{position:absolute;top:10px;left:10px;background:rgba(11,13,15,.92);border:1px solid var(--b);padding:4px 10px;font-size:.65rem;color:var(--cy);pointer-events:none;display:none;}
.fso{position:fixed;inset:0;z-index:500;display:none;background:var(--bg);}
.fso.on{display:flex;flex-direction:column;}
.fso-top{padding:6px 12px;border-bottom:1px solid var(--b);display:flex;align-items:center;gap:8px;flex-shrink:0;}
.fso-ca{flex:1;position:relative;overflow:hidden;}
.tab-bar{display:flex;gap:2px;margin-bottom:3px;}
.tab{font-size:.6rem;padding:2px 6px;cursor:pointer;border:1px solid var(--b);color:var(--t3);background:transparent;font-family:'Inconsolata',monospace;}
.tab.act{border-color:var(--p);color:var(--p);background:var(--b);}
.tab-content{display:none;}.tab-content.act{display:block;}
.opt-res{font-size:.58rem;color:var(--t2);margin-top:3px;line-height:1.4;}
.rec-box{background:var(--bg);border:1px solid var(--b);padding:4px 6px;font-size:.6rem;color:var(--t2);margin-top:3px;line-height:1.5;display:none;}
.rec-box .rh{color:var(--am);font-size:.58rem;margin-bottom:2px;}
.rec-box .rv{color:var(--p);}
input[type=file]{display:none;}
/* POPUP PANELS */
.pop-btn{background:transparent;border:1px solid var(--b2);color:var(--t2);font-family:'Inconsolata',monospace;font-size:.6rem;padding:2px 7px;cursor:pointer;position:relative;}
.pop-btn:hover{border-color:var(--p);color:var(--p);}
.pop-btn.open{border-color:var(--p);color:var(--p);background:var(--b);}
.pop-wrap{position:relative;display:inline-block;}
.popup{position:fixed;z-index:300;background:var(--s1);border:1px solid var(--p);padding:8px;min-width:240px;max-width:300px;display:none;box-shadow:0 4px 20px rgba(0,0,0,.5);}
.popup.open{display:block;}
.popup .blk-t{margin-bottom:5px;color:var(--am);cursor:default;}
@media(max-width:700px){.app{grid-template-columns:1fr;grid-template-rows:auto 1fr;}.sb{max-height:40vh;}}
</style></head><body>
<div class="app" id="APP">
<div class="sb">
<div class="sb-head">
<span class="logo">GPR¬∑PRO</span>
<div style="display:flex;gap:3px;align-items:center;">
<button type="button" class="btn" id="themeBtn" title="Tema">‚òæ</button>
<button type="button" class="btn" id="fsBtn" title="Tam Ekran">‚õ∂</button>
</div>
</div>
<div class="sb-scroll">

<div class="blk">
<div class="blk-t" data-blk="veri">VERƒ∞ <span style="font-size:.55rem;color:var(--t3);">‚ñæ</span></div>
<div class="blk-body" id="blk-veri">
<textarea id="dataInput">2.1,3.5,2.8,5.2,4.1,6.8,5.9,8.4,7.2,9.8,8.5,11.2</textarea>
<div class="row">
<input type="text" id="serName" placeholder="seri adƒ±...">
<button type="button" class="btn p" id="addSerBtn">+SERƒ∞</button>
</div>
<div class="row">
<button type="button" class="btn" id="togPtBtn">+NOKTA</button>
<button type="button" class="btn" id="refreshBtn">‚Ü∫</button>
<label for="csvFile" class="btn" style="cursor:pointer;">CSV</label>
<input type="file" id="csvFile" accept=".csv,.txt">
</div>
<div class="xyf" id="xyf">
<div style="flex:1"><label>X</label><input type="number" id="addX" step="any" placeholder="x"></div>
<div style="flex:1"><label>Y</label><input type="number" id="addY" step="any" placeholder="y"></div>
<button type="button" class="btn p" id="confirmPt" style="height:25px;align-self:flex-end">Gƒ∞R</button>
</div>
<div class="dp-list" id="dpList"></div>
<div id="serList" style="margin-top:3px;"><span style="font-size:.6rem;color:var(--t3);">‚Äî aktif veri kullanƒ±lƒ±r ‚Äî</span></div>
</div>
</div>

<div class="blk">
<div class="blk-t" data-blk="kernel">KERNEL <span style="font-size:.55rem;color:var(--t3);">‚ñæ</span></div>
<div class="blk-body" id="blk-kernel">
<div class="row" style="margin-top:0;margin-bottom:3px;">
<select id="kernelSel">
<option value="rbf">RBF</option>
<option value="matern32">Mat√©rn 3/2</option>
<option value="matern52">Mat√©rn 5/2</option>
<option value="periodic">Periodic</option>
<option value="rq">Rational Quadratic</option>
<option value="linear">Linear</option>
<option value="poly">Polynomial</option>
<option value="spectral">Spectral Mixture</option>
</select>
<button type="button" class="btn am" id="bestLMLBtn" title="Bu kernel i√ßin en iyi ‚Ñì ve œÉ_n bul">BEST LML</button>
</div>
<div class="sl-row">
<div class="sl-h"><span>LENGTH SCALE (‚Ñì)</span><span id="lv">1.5</span></div>
<div class="sl-wrap"><input type="range" id="pl" min=".05" max="10" step=".05" value="1.5"><input type="number" id="pl_n" min=".05" max="10" step=".05" value="1.5"></div>
</div>
<div class="sl-row">
<div class="sl-h"><span>NOISE (œÉ_n)</span><span id="nv">0.10</span></div>
<div class="sl-wrap"><input type="range" id="pn" min=".001" max="3" step=".001" value="0.1"><input type="number" id="pn_n" min=".001" max="3" step=".001" value="0.1"></div>
</div>
<div class="sl-row" id="pSW" style="display:none;">
<div class="sl-h"><span>PERIOD (p)</span><span id="ppv">3.0</span></div>
<div class="sl-wrap"><input type="range" id="pp" min=".5" max="15" step=".1" value="3"><input type="number" id="pp_n" min=".5" max="15" step=".1" value="3"></div>
</div>
<div class="sl-row" id="aSW" style="display:none;">
<div class="sl-h"><span>ALPHA (Œ±)</span><span id="av">1.0</span></div>
<div class="sl-wrap"><input type="range" id="pa" min=".1" max="5" step=".1" value="1"><input type="number" id="pa_n" min=".1" max="5" step=".1" value="1"></div>
</div>
<div class="sl-row" id="dSW" style="display:none;">
<div class="sl-h"><span>DEGREE (d)</span><span id="dv">2</span></div>
<div class="sl-wrap"><input type="range" id="pd" min="1" max="5" step="1" value="2"><input type="number" id="pd_n" min="1" max="5" step="1" value="2"></div>
</div>
<div class="lml-b" id="lmlBox">LML: <strong>‚Äî</strong></div>
</div>
</div>

<div class="blk">
<div class="blk-t" data-blk="tahmin">TAHMƒ∞N <span style="font-size:.55rem;color:var(--t3);">‚ñæ</span></div>
<div class="blk-body" id="blk-tahmin">
<div class="tab-bar">
<button type="button" class="tab act" data-tab="fc">GELECEK</button>
<button type="button" class="tab" data-tab="interp">ARA</button>
<button type="button" class="tab" data-tab="missing">KAYIP</button>
</div>
<div class="tab-content act" id="tab-fc">
<div class="sl-row">
<div class="sl-h"><span>ƒ∞LERƒ∞ ADIM</span><span id="stv">10</span></div>
<div class="sl-wrap"><input type="range" id="pst" min="1" max="50" step="1" value="10"><input type="number" id="pst_n" min="1" max="50" step="1" value="10"></div>
</div>
<div class="sl-row">
<div class="sl-h"><span>G√úVEN k¬∑œÉ</span><span id="civ">1.96</span></div>
<div class="sl-wrap"><input type="range" id="pci" min=".5" max="3.5" step=".01" value="1.96"><input type="number" id="pci_n" min=".5" max="3.5" step=".01" value="1.96"></div>
</div>
<!-- Ensemble popup trigger -->
<div style="margin-top:3px;display:flex;gap:3px;flex-wrap:wrap;">
<button type="button" class="pop-btn" id="ensPopBtn">‚öñ Aƒüƒ±rlƒ±klar ‚ñæ</button>
<button type="button" class="pop-btn" id="visPopBtn">üëÅ G√∂r√ºn√ºm ‚ñæ</button>
</div>
</div>
<div class="tab-content" id="tab-interp">
<div class="sl-row" style="margin-top:2px;">
<div class="sl-h"><span>MESH √á√ñZ.</span><span id="resv">300</span></div>
<div class="sl-wrap"><input type="range" id="pres" min="50" max="800" step="10" value="300"><input type="number" id="pres_n" min="50" max="800" step="10" value="300"></div>
</div>
<div style="margin-top:3px;display:flex;gap:3px;flex-wrap:wrap;">
<button type="button" class="pop-btn" id="interpPopBtn">üëÅ G√∂r√ºn√ºm ‚ñæ</button>
</div>
</div>
<div class="tab-content" id="tab-missing">
<div style="font-size:.6rem;color:var(--t2);margin-bottom:2px;">Kayƒ±p X noktalarƒ±:</div>
<input type="text" id="missingX" placeholder="3.5, 7.2, 10.1 ...">
<div class="tog-row"><button type="button" class="tog on" id="togMissCI"></button><span>Kayƒ±p nokta CI</span></div>
</div>
</div>
</div>

<div class="blk">
<div class="blk-t" data-blk="opt">OPTƒ∞Mƒ∞ZASYON <span style="font-size:.55rem;color:var(--t3);">‚ñæ</span></div>
<div class="blk-body" id="blk-opt">
<div class="row" style="margin-top:0;">
<button type="button" class="btn am" id="autoOptBtn">GRID SEARCH</button>
<button type="button" class="btn" id="analyzeBtn">ANALƒ∞Z</button>
<button type="button" class="btn" id="exportBtn">‚ÜìCSV</button>
</div>
<div class="opt-res" id="optRes"></div>
<div class="rec-box" id="recBox"><div class="rh">‚ñ∂ ANALƒ∞Z √ñNERƒ∞Sƒ∞</div><div id="recContent"></div></div>
</div>
</div>

<div class="blk">
<div class="blk-t" data-blk="stats">ƒ∞STATƒ∞STƒ∞K <span style="font-size:.55rem;color:var(--t3);">‚ñæ</span></div>
<div class="blk-body" id="blk-stats">
<div class="sgrid">
<div class="sc"><div class="sv" id="sn">‚Äî</div><div class="sl2">N</div></div>
<div class="sc"><div class="sv" id="smean">‚Äî</div><div class="sl2">ORAN</div></div>
<div class="sc"><div class="sv" id="sstd">‚Äî</div><div class="sl2">STD</div></div>
<div class="sc"><div class="sv" id="sskew">‚Äî</div><div class="sl2">√áARP</div></div>
</div>
</div>
</div>

<div class="blk">
<div class="blk-t" data-blk="log">LOG <span style="font-size:.55rem;color:var(--t3);">‚ñæ</span></div>
<div class="blk-body" id="blk-log">
<div class="ll" id="logEl"></div>
</div>
</div>

<button type="button" class="run-btn" id="runBtn">[ HESAPLA ]</button>
<div class="prog"><div class="pb" id="pb"></div></div>
</div>
<div class="sb-foot">
<span id="stTxt">HAZIR</span>
<span>Z:<span id="zTxt" style="color:var(--p);">1.00√ó</span></span>
<span>Ctrl+‚Üµ</span>
</div>
</div>

<!-- MAIN CHART AREA - maximized -->
<div class="ca" id="mainCA">
<canvas id="mainC"></canvas>
<div class="chi" id="mainCHI"></div>
<div class="zi" id="mainZI">scroll=zoom ¬∑ drag=pan ¬∑ dbl=reset</div>
<div class="hud">
<button type="button" class="hbtn" id="zInBtn" title="Zoom In">+</button>
<button type="button" class="hbtn" id="zOutBtn" title="Zoom Out">-</button>
<button type="button" class="hbtn" id="zReset" title="Reset View">‚ä°</button>
<button type="button" class="hbtn" id="snapBtn" title="Grafik PNG (tam ekran)">üì∑</button>
<button type="button" class="hbtn" id="fsBtn2" title="Tam Ekran">‚õ∂</button>
</div>
</div>
</div>

<!-- FULLSCREEN OVERLAY (chart only, no sidebar) -->
<div class="fso" id="fsO">
<div class="fso-top">
<span class="logo" style="font-size:1.1rem;">GPR¬∑PRO</span>
<span style="font-size:.62rem;color:var(--t2);flex:1;">TAM EKRAN ¬∑ scroll=zoom ¬∑ drag=pan ¬∑ dbl=reset</span>
<button type="button" class="btn am" id="fsZIn">+</button>
<button type="button" class="btn am" id="fsZOut">-</button>
<button type="button" class="btn" id="fsZReset">‚ä°</button>
<button type="button" class="btn" id="fsClose">‚úï KAPAT</button>
</div>
<div class="fso-ca" id="fsCA">
<canvas id="fsC"></canvas>
<div class="chi" id="fsCHI"></div>
<div class="zi" id="fsZI"></div>
</div>
</div>

<!-- ENSEMBLE WEIGHTS POPUP -->
<div class="popup" id="ensPopup">
<div class="blk-t">ENSEMBLE AƒûIRLIKLARI</div>
<div class="sl-row"><div class="sl-h"><span>GPR</span><span id="wgv">.40</span></div><div class="sl-wrap"><input type="range" id="wg" min="0" max="1" step=".05" value=".4"><input type="number" id="wg_n" min="0" max="1" step=".05" value=".4"></div></div>
<div class="sl-row"><div class="sl-h"><span>KALMAN</span><span id="wkv">.20</span></div><div class="sl-wrap"><input type="range" id="wk" min="0" max="1" step=".05" value=".2"><input type="number" id="wk_n" min="0" max="1" step=".05" value=".2"></div></div>
<div class="sl-row"><div class="sl-h"><span>AR(p)</span><span id="wav">.15</span></div><div class="sl-wrap"><input type="range" id="wa" min="0" max="1" step=".05" value=".15"><input type="number" id="wa_n" min="0" max="1" step=".05" value=".15"></div></div>
<div class="sl-row"><div class="sl-h"><span>ARIMA</span><span id="wrv">.10</span></div><div class="sl-wrap"><input type="range" id="wr" min="0" max="1" step=".05" value=".1"><input type="number" id="wr_n" min="0" max="1" step=".05" value=".1"></div></div>
<div class="sl-row"><div class="sl-h"><span>ETS</span><span id="wev">.10</span></div><div class="sl-wrap"><input type="range" id="we" min="0" max="1" step=".05" value=".1"><input type="number" id="we_n" min="0" max="1" step=".05" value=".1"></div></div>
<div class="sl-row"><div class="sl-h"><span>LSTM-SIM</span><span id="wlv">.05</span></div><div class="sl-wrap"><input type="range" id="wl" min="0" max="1" step=".05" value=".05"><input type="number" id="wl_n" min="0" max="1" step=".05" value=".05"></div></div>
<div class="tog-row"><button type="button" class="tog on" id="togCI"></button><span>G√ºven bandƒ±</span></div>
<div class="tog-row"><button type="button" class="tog" id="togFanChart"></button><span>Fan chart (√ßoklu œÉ)</span></div>
<div class="tog-row"><button type="button" class="tog" id="togModels"></button><span>Model bile≈üenleri</span></div>
<div class="tog-row"><button type="button" class="tog" id="togMCMC"></button><span>Monte Carlo 50√ó</span></div>
</div>

<!-- VISUALISATION POPUP (forecast tab) -->
<div class="popup" id="visPopup">
<div class="blk-t">G√ñRSELLE≈ûTƒ∞RME</div>
<div class="tog-row"><button type="button" class="tog on" id="togGrid"></button><span>Izgara</span></div>
<div class="tog-row"><button type="button" class="tog on" id="togObs"></button><span>G√∂zlem noktalarƒ±</span></div>
<div class="tog-row"><button type="button" class="tog" id="togAnnot"></button><span>Deƒüer etiketleri</span></div>
<div class="tog-row"><button type="button" class="tog" id="togResid"></button><span>Residual √ßizgiler</span></div>
</div>

<!-- INTERPOLATION POPUP -->
<div class="popup" id="interpPopup">
<div class="blk-t">ƒ∞NTERPOLASYON G√ñR√úN√úMLERƒ∞</div>
<div class="tog-row"><button type="button" class="tog on" id="togInterpCI"></button><span>GPR interpolasyon CI</span></div>
<div class="tog-row"><button type="button" class="tog on" id="togSamples"></button><span>Posterior √∂rnekleri</span></div>
<div class="tog-row"><button type="button" class="tog" id="togDeriv"></button><span>T√ºrev eƒürisi</span></div>
<div class="tog-row"><button type="button" class="tog" id="togVar"></button><span>Varyans ƒ±sƒ± haritasƒ±</span></div>
<div class="tog-row"><button type="button" class="tog on" id="togGrid2"></button><span>Izgara</span></div>
<div class="tog-row"><button type="button" class="tog on" id="togObs2"></button><span>G√∂zlem noktalarƒ±</span></div>
</div>

<script>
(function(){
'use strict';
var $=function(id){return document.getElementById(id);};
var COLORS=['#4ade80','#f59e0b','#38bdf8','#a78bfa','#f472b6','#22d3ee','#fb923c','#84cc16'];
var series=[],dataPoints=[],gprResult=null,rPending=false;
var view={x0:0,x1:10,y0:-1,y1:12,zoom:1};
var fsView={x0:0,x1:10,y0:-1,y1:12,zoom:1};
function $g(id){return document.getElementById(id);}
function log(m,t){var el=$g('logEl');t=t||'inf';var d=new Date(),div=document.createElement('div');div.className='ln';div.innerHTML='<span class="ts">'+d.toTimeString().slice(0,8)+'</span><span class="'+t+'">'+m+'</span>';el.insertBefore(div,el.firstChild);while(el.children.length>80)el.removeChild(el.lastChild);}
function prog(p){$g('pb').style.width=Math.max(0,Math.min(100,p))+'%';}
function setSt(t){$g('stTxt').textContent=t;}
function h2r(h,a){if(h.startsWith('#')){var r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return'rgba('+r+','+g+','+b+','+a+')';}return h;}
function getCSSVar(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}

// COLLAPSIBLE BLOCKS
function initBlocks(){document.querySelectorAll('.blk-t[data-blk]').forEach(function(t){var body=$g('blk-'+t.dataset.blk);if(!body)return;body.style.maxHeight=body.scrollHeight+'px';t.addEventListener('click',function(){body.classList.toggle('collapsed');t.querySelector('span').textContent=body.classList.contains('collapsed')?'‚ñ∏':'‚ñæ';});});}

// POPUP PANELS
var openPopup=null;
function initPopups(){
function mkPop(btnId,popId){var btn=$g(btnId),pop=$g(popId);if(!btn||!pop)return;btn.addEventListener('click',function(e){e.stopPropagation();if(openPopup&&openPopup!==pop){openPopup.classList.remove('open');document.querySelector('[data-pop="'+openPopup.id+'"]')&&document.querySelector('[data-pop="'+openPopup.id+'"]').classList.remove('open');}if(pop.classList.contains('open')){pop.classList.remove('open');btn.classList.remove('open');openPopup=null;}else{var r=btn.getBoundingClientRect();pop.style.left=r.left+'px';pop.style.top=(r.bottom+4)+'px';pop.classList.add('open');btn.classList.add('open');openPopup=pop;}});btn.dataset.pop=popId;}
mkPop('ensPopBtn','ensPopup');mkPop('visPopBtn','visPopup');mkPop('interpPopBtn','interpPopup');
document.addEventListener('click',function(){if(openPopup){openPopup.classList.remove('open');document.querySelectorAll('.pop-btn.open').forEach(function(b){b.classList.remove('open');});openPopup=null;}});
document.querySelectorAll('.popup').forEach(function(p){p.addEventListener('click',function(e){e.stopPropagation();});});}

// DATA
function parseTA(){var ys=$g('dataInput').value.split(',').map(function(s){return parseFloat(s.trim());}).filter(function(n){return!isNaN(n);});dataPoints=ys.map(function(y,i){return{x:i+1,y:y};});renderDP();}
function getD(){if(dataPoints.length>=2)return{X:dataPoints.map(function(p){return p.x;}),y:dataPoints.map(function(p){return p.y;})};var ys=$g('dataInput').value.split(',').map(function(s){return parseFloat(s.trim());}).filter(function(n){return!isNaN(n);});return{X:ys.map(function(_,i){return i+1;}),y:ys};}
function renderDP(){var el=$g('dpList');if(!dataPoints.length){el.innerHTML='';return;}el.innerHTML=dataPoints.map(function(p,i){return'<div class="dp-r"><span class="dp-x">'+p.x+'</span><span class="dp-y">'+p.y.toFixed(3)+'</span><div class="dp-acts"><button type="button" onclick="G.mv('+i+',-1)">‚Üë</button><button type="button" onclick="G.mv('+i+',1)">‚Üì</button><button type="button" class="del" onclick="G.dp('+i+')">‚úï</button></div></div>';}).join('');}
window.G={mv:function(i,d){var ni=i+d;if(ni<0||ni>=dataPoints.length)return;var t=dataPoints[i];dataPoints[i]=dataPoints[ni];dataPoints[ni]=t;dataPoints=dataPoints.map(function(p,j){return{x:j+1,y:p.y};});renderDP();},dp:function(i){dataPoints.splice(i,1);dataPoints=dataPoints.map(function(p,j){return{x:j+1,y:p.y};});renderDP();log('Nokta silindi','wa');},rs:function(i){series.splice(i,1);renderSL();}};
function addXY(){var xv=parseFloat($g('addX').value),yv=parseFloat($g('addY').value);if(isNaN(xv)||isNaN(yv)){return;}dataPoints.push({x:xv,y:yv});dataPoints.sort(function(a,b){return a.x-b.x;});$g('addX').value='';$g('addY').value='';renderDP();log('x='+xv+' y='+yv,'ok');}
function addSer(){var d=getD();if(d.y.length<2){return;}var nm=$g('serName').value.trim()||'s'+(series.length+1);series.push({name:nm,X:d.X,y:d.y});$g('serName').value='';renderSL();log('Seri: '+nm,'ok');}
function renderSL(){var el=$g('serList');if(!series.length){el.innerHTML='<span style="font-size:.6rem;color:var(--t3);">‚Äî aktif veri kullanƒ±lƒ±r ‚Äî</span>';return;}el.innerHTML=series.map(function(s,i){return'<div class="ser-r"><div class="ser-dot" style="background:'+COLORS[i%COLORS.length]+'"></div><div style="flex:1;font-size:.62rem;">'+s.name+'</div><button type="button" class="ser-del" onclick="G.rs('+i+')">‚úï</button></div>';}).join('');}
function impCSV(ev){var f=ev.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(e){var lines=e.target.result.trim().split('\n'),nums=[];lines.forEach(function(l){var p=l.split(/[,;\t]/);for(var k=0;k<p.length;k++){var n=parseFloat(p[k].replace(',','.'));if(!isNaN(n)){nums.push(n);break;}}});if(nums.length<2){return;}$g('dataInput').value=nums.join(',');dataPoints=nums.map(function(y,i){return{x:i+1,y:y};});renderDP();log('CSV: '+f.name+' ('+nums.length+')','ok');analyzeData();};r.readAsText(f);}

// STATS
function stats(y){var n=y.length,m=y.reduce(function(a,b){return a+b;},0)/n,v=y.reduce(function(a,b){return a+Math.pow(b-m,2);},0)/n,s=Math.sqrt(v)||1e-9,sk=y.reduce(function(a,b){return a+Math.pow((b-m)/s,3);},0)/n,mn=Math.min.apply(null,y),mx=Math.max.apply(null,y);return{n:n,mean:m,std:s,skew:sk,min:mn,max:mx,range:mx-mn};}
function upStats(y){var s=stats(y);$g('sn').textContent=s.n;$g('smean').textContent=s.mean.toFixed(2);$g('sstd').textContent=s.std.toFixed(2);$g('sskew').textContent=s.skew.toFixed(2);}

// DATA ANALYSIS & RECOMMENDATION
function analyzeData(){
var d=getD();if(d.y.length<4)return;
var y=d.y,n=y.length,s=stats(y);
var diffs=y.slice(1).map(function(_,i){return y[i+1]-y[i];});
var trend=diffs.reduce(function(a,b){return a+b;},0)/diffs.length;
var stdD=Math.sqrt(diffs.map(function(d){return d*d;}).reduce(function(a,b){return a+b;},0)/diffs.length);
var mono=diffs.every(function(d){return d>0;})||diffs.every(function(d){return d<0;});
var periodic=false;
if(n>=8){var acf1=0,acf2=0,my=s.mean;for(var i=0;i<n-2;i++){acf1+=(y[i]-my)*(y[i+1]-my);acf2+=(y[i]-my)*(y[i+2]-my);}var varY=y.reduce(function(a,b){return a+Math.pow(b-my,2);},0);if(Math.abs(acf2/varY)>0.5&&(acf2/varY)>(acf1/varY))periodic=true;}
var cumulative=y.every(function(v,i){return i===0||v>=y[i-1];});
var highNoise=stdD/(s.range||1)>0.3;
var rec=[],dtype='';
if(cumulative)dtype='K√úM√úLATƒ∞F';else if(mono)dtype=trend>0?'ARTAN':'AZALAN';else if(periodic)dtype='PERƒ∞YODƒ∞K';else if(highNoise)dtype='G√úR√úLT√úL√ú/KARMA≈ûIK';else dtype='ORTADENGELƒ∞';
rec.push('<span class="rv">Tƒ∞P: '+dtype+'</span>');
if(periodic){rec.push('Kernel: <span class="rv">PERIODIC</span> (p‚âà'+Math.round(n/3)+')');rec.push('Model: <span class="rv">GPR+ETS</span>');}
else if(cumulative||mono){rec.push('Kernel: <span class="rv">RBF/LINEAR</span>');rec.push('Model: <span class="rv">KALMAN+AR</span>');}
else if(highNoise){rec.push('Kernel: <span class="rv">MAT√âRN 3/2</span>');rec.push('œÉ_n ‚âà <span class="rv">'+s.std.toFixed(2)+'</span>');}
else{rec.push('Kernel: <span class="rv">RBF/MAT√âRN 5/2</span>');rec.push('Ensemble: <span class="rv">dengeli</span>');}
rec.push('‚Ñì √∂neri: <span class="rv">'+((s.range/n)*2).toFixed(2)+'‚Äì'+(s.range/2).toFixed(2)+'</span>');
$g('recBox').style.display='block';$g('recContent').innerHTML=rec.join('<br>');}

// KERNEL
function kfn(x1,x2,l,sf,k,p,a,deg){var d=x1-x2,r=Math.abs(d);if(k==='rbf')return sf*sf*Math.exp(-d*d/(2*l*l));if(k==='matern32'){var s=1.7321*r/l;return sf*sf*(1+s)*Math.exp(-s);}if(k==='matern52'){var s2=2.2361*r/l;return sf*sf*(1+s2+s2*s2/3)*Math.exp(-s2);}if(k==='periodic'){var sv=Math.sin(3.14159*r/p);return sf*sf*Math.exp(-2*sv*sv/(l*l));}if(k==='rq')return sf*sf*Math.pow(1+d*d/(2*(a||1)*l*l),-(a||1));if(k==='linear')return sf*sf*(x1*x2+l);if(k==='poly')return sf*sf*Math.pow(x1*x2/l+1,deg||2);if(k==='spectral'){var cos=Math.cos(2*3.14159*r/(p||3));return sf*sf*Math.exp(-d*d/(2*l*l))*cos;}return sf*sf*Math.exp(-d*d/(2*l*l));}
function bK(X1,X2,l,sf,k,p,a,deg){return X1.map(function(x1){return X2.map(function(x2){return kfn(x1,x2,l,sf,k,p,a,deg);});});}
function cLML(y,K){try{var n=y.length,Ki=math.inv(K),al=math.multiply(Ki,y),fit=-0.5*math.dot(y,al),ev=math.eigs(K).values,ld=ev.reduce(function(a,v){return a+Math.log(Math.max(v,1e-10));},0);return fit-0.5*ld-0.5*n*Math.log(6.28318);}catch(e){return NaN;}}
function updKI(){var k=$g('kernelSel').value;$g('pSW').style.display=(k==='periodic'||k==='spectral')?'block':'none';$g('aSW').style.display=k==='rq'?'block':'none';$g('dSW').style.display=k==='poly'?'block':'none';}

// SNAPSHOT - render full size offscreen, save PNG
function snapPNG(){
if(!gprResult||!gprResult.length){log('√ñnce hesapla','wa');return;}
var W=3200,H=2000;
var off=document.createElement('canvas');off.width=W;off.height=H;
var sv={x0:view.x0,x1:view.x1,y0:view.y0,y1:view.y1,zoom:view.zoom};
renderCon(off,sv,false,W,H);
var a=document.createElement('a');a.download='gpr_chart.png';a.href=off.toDataURL('image/png',1);a.click();
log('PNG 3200√ó2000 kaydedildi','ok');}

// FORECASTING MODELS
function kalmanForecast(y,steps){
var n=y.length,Q=0.01,R=Math.max(0.01,stats(y).std*0.3);
var x=y[0],P=1,preds=[];
for(var i=0;i<n;i++){var xp=x,Pp=P+Q,K=Pp/(Pp+R);x=xp+K*(y[i]-xp);P=(1-K)*Pp;}
var trend=(y[n-1]-y[Math.max(0,n-5)])/(Math.min(5,n-1)||1);
var pCovs=[];
for(var s=1;s<=steps;s++){var Pp2=P+Q*s;preds.push(x+trend*s);pCovs.push(Pp2+R);}
return{mean:preds,cov:pCovs};}

function arForecast(y,steps,order){var n=y.length,p=Math.min(order||Math.min(5,Math.floor(n/2)),n-1);if(p<1)return{mean:Array(steps).fill(y[n-1]),cov:Array(steps).fill(1)};var A=[],b=[];for(var i=p;i<n;i++){var row=[];for(var j=1;j<=p;j++)row.push(y[i-j]);A.push(row);b.push(y[i]);}try{var At=math.transpose(A),coef=math.multiply(math.inv(math.multiply(At,A)),math.multiply(At,b));var hist=y.slice(),preds=[],errs=[];for(var s=0;s<steps;s++){var x=[];for(var j=0;j<p;j++)x.push(hist[hist.length-1-j]);var pr=math.dot(coef,x);preds.push(pr);hist.push(pr);errs.push(Math.pow(s+1,.5)*0.5);}return{mean:preds,cov:errs.map(function(e){return e*e;})};}catch(e){return{mean:Array(steps).fill(y[n-1]),cov:Array(steps).fill(1)};}}

function arimaDiff(y,d){var yd=y.slice();for(var i=0;i<d;i++){var t=[];for(var j=1;j<yd.length;j++)t.push(yd[j]-yd[j-1]);yd=t;}return yd;}
function arimaForecast(y,steps){var d=arimaDiff(y,1);var ar=arForecast(d,steps,Math.min(3,Math.floor(y.length/3)));var preds=[],last=y[y.length-1];for(var i=0;i<steps;i++){last+=ar.mean[i];preds.push(last);}return{mean:preds,cov:ar.cov.map(function(v){return v*2;})};}

function etsForecast(y,steps){var n=y.length,a=0.3,b=0.1,level=y[0],trend=(n>1?(y[n-1]-y[0])/(n-1):0);for(var i=1;i<n;i++){var pl=level;level=a*y[i]+(1-a)*(level+trend);trend=b*(level-pl)+(1-b)*trend;}var preds=[],covs=[];for(var s=1;s<=steps;s++){preds.push(level+trend*s);covs.push(Math.pow(s,.6)*0.3);}return{mean:preds,cov:covs.map(function(v){return v*v;})};}

function lstmSimForecast(y,steps){var n=y.length,ws=Math.min(8,n-1),preds=[],covs=[];var hist=y.slice();for(var s=0;s<steps;s++){var w=hist.slice(-ws),sum=0,wsum=0;for(var i=0;i<w.length;i++){var wi=Math.exp(i);sum+=w[i]*wi;wsum+=wi;}var base=sum/wsum;var noise=stats(y).std*0.15*(s+1)/(steps+1);preds.push(base);covs.push(noise*noise);hist.push(base);}return{mean:preds,cov:covs};}

function monteCarloSamples(ensembleMu,ensembleVar,steps,n){var samples=[];for(var i=0;i<n;i++){var s=ensembleMu.map(function(m,j){return m+Math.sqrt(Math.max(0,ensembleVar[j]))*(Math.random()*2-1)*1.5;});samples.push(s);}return samples;}

// GPR COMPUTE
function computeGPR(){
var d=getD();if(d.y.length<3){alert('En az 3 nokta');return;}
var ps=series.length>0?series:[{name:'aktif',X:d.X,y:d.y}];
var l=parseFloat($g('pl').value),sn=parseFloat($g('pn').value),pp=parseFloat($g('pp').value||3),aa=parseFloat($g('pa').value||1),deg=parseInt($g('pd').value||2),k=$g('kernelSel').value;
var res=parseInt($g('pres').value),steps=parseInt($g('pst').value);
upStats(ps[0].y);prog(5);
var xAll=[];ps.forEach(function(s){xAll=xAll.concat(s.X);});
var xMin=Math.min.apply(null,xAll),xMax=Math.max.apply(null,xAll),xPad=(xMax-xMin)*0.08||0.5;
var Xs=[];for(var i=0;i<=res;i++)Xs.push(xMin-xPad+i*(xMax-xMin+2*xPad)/res);
var xFut=Array.from({length:steps},function(_,i){return xMax+i+1;});
var results=[],lmlTot=0;
ps.forEach(function(ser,si){
var y=ser.y,X=ser.X,n=y.length,ym=y.reduce(function(a,b){return a+b;},0)/n,yv=y.reduce(function(a,b){return a+Math.pow(b-ym,2);},0)/n,sf=Math.sqrt(yv)||1;
try{
var K=bK(X,X,l,sf,k,pp,aa,deg);for(var i=0;i<n;i++)K[i][i]+=sn*sn;
var lv=cLML(y,K);lmlTot+=isNaN(lv)?0:lv;
var Ki=math.inv(K),Xstar=Xs.concat(xFut),KS=bK(Xstar,X,l,sf,k,pp,aa,deg),KsKi=math.multiply(KS,Ki);
var mu=math.multiply(KsKi,y);
var ksd=Xstar.map(function(x){return kfn(x,x,l,sf,k,pp,aa,deg);}),KsKiKsT=math.multiply(KsKi,math.transpose(KS));
var va=Xstar.map(function(_,i){return Math.max(0,ksd[i]-KsKiKsT[i][i]);});
var gprInterp=mu.slice(0,Xs.length),vaInterp=va.slice(0,Xs.length);
var gprFutMu=mu.slice(Xs.length),gprFutVar=va.slice(Xs.length);
var dm=gprInterp.map(function(_,i){if(i===0||i===gprInterp.length-1)return 0;return(gprInterp[i+1]-gprInterp[i-1])/(Xs[i+1]-Xs[i-1]);});
var samps=[];for(var s=0;s<3;s++)samps.push(gprInterp.map(function(m,i){return m+Math.sqrt(vaInterp[i])*(Math.random()*2-1)*1.1;}));
// forecast models
var kalm=kalmanForecast(y,steps);
var arR=arForecast(y,steps);
var ariR=arimaForecast(y,steps);
var etsR=etsForecast(y,steps);
var lstR=lstmSimForecast(y,steps);
// weights
var wg=parseFloat($g('wg').value),wk=parseFloat($g('wk').value),wa=parseFloat($g('wa').value),wr=parseFloat($g('wr').value),we=parseFloat($g('we').value),wl=parseFloat($g('wl').value);
var ws=wg+wk+wa+wr+we+wl||1;wg/=ws;wk/=ws;wa/=ws;wr/=ws;we/=ws;wl/=ws;
var ensF=xFut.map(function(_,i){return wg*gprFutMu[i]+wk*kalm.mean[i]+wa*arR.mean[i]+wr*ariR.mean[i]+we*etsR.mean[i]+wl*lstR.mean[i];});
var ensV=xFut.map(function(_,i){return wg*wg*gprFutVar[i]+wk*wk*kalm.cov[i]+wa*wa*arR.cov[i]+wr*wr*ariR.cov[i]+we*we*etsR.cov[i]+wl*wl*lstR.cov[i];});
// monte carlo
var mcSamp=$g('togMCMC').classList.contains('on')?monteCarloSamples(ensF,ensV,steps,50):[];
// missing points
var missingX=$g('missingX').value.split(',').map(function(s){var n=parseFloat(s.trim());return isNaN(n)?null:n;}).filter(function(v){return v!==null;});
var missingPred=[];if(missingX.length){var KSm=bK(missingX,X,l,sf,k,pp,aa,deg),KsKim=math.multiply(KSm,Ki);var mum=math.multiply(KsKim,y);var ksdm=missingX.map(function(x){return kfn(x,x,l,sf,k,pp,aa,deg);}),KsKiKsTm=math.multiply(KsKim,math.transpose(KSm));var vam=missingX.map(function(_,i){return Math.max(0,ksdm[i]-KsKiKsTm[i][i]);});missingPred=missingX.map(function(x,i){return{x:x,mu:mum[i],va:vam[i]};});}
results.push({name:ser.name,color:COLORS[si%COLORS.length],X:X,y:y,Xs:Xs,mu:gprInterp,va:vaInterp,dm:dm,samps:samps,xFut:xFut,ensF:ensF,ensV:ensV,gprFut:gprFutMu,kalmFut:kalm.mean,arFut:arR.mean,ariFut:ariR.mean,etsFut:etsR.mean,lstFut:lstR.mean,mcSamp:mcSamp,missingPred:missingPred,lv:lv});
}catch(e){log('['+ser.name+'] '+e.message,'er');}
prog(20+si*70/ps.length);});
$g('lmlBox').innerHTML='LML: <strong>'+lmlTot.toFixed(4)+'</strong>';
gprResult=results;
var yAll=[];results.forEach(function(r){yAll=yAll.concat(r.mu);r.y.forEach(function(v){yAll.push(v);});results.length&&r.ensF.forEach(function(v){yAll.push(v);});});
var yMin=Math.min.apply(null,yAll),yMax=Math.max.apply(null,yAll),yP=(yMax-yMin)*0.2||1,xF=results.length?results[0].xFut:[];
var xAllFull=xAll.concat(xF||[]);
view={x0:Math.min.apply(null,xAllFull)-xPad,x1:Math.max.apply(null,xAllFull)+xPad*.5,y0:yMin-yP,y1:yMax+yP,zoom:1};
fsView={x0:view.x0,x1:view.x1,y0:view.y0,y1:view.y1,zoom:1};
prog(100);setTimeout(function(){prog(0);},600);
log('LML='+lmlTot.toFixed(3)+' | '+results.length+' seri | '+steps+' adƒ±m','ok');
schedR();}

// RENDER ENGINE
function schedR(){if(rPending)return;rPending=true;requestAnimationFrame(function(){rPending=false;var mc=$g('mainC');renderCon(mc,view,false);if($g('fsO').classList.contains('on')){var fc=$g('fsC');renderCon(fc,fsView,true);}});}

function renderCon(canvas,v,isFs,forceW,forceH){
var dpr=forceW?1:(window.devicePixelRatio||1);
var W=forceW||(canvas.clientWidth);var H=forceH||(canvas.clientHeight);
if(W<20||H<20)return;
var pw=Math.round(W*dpr),ph=Math.round(H*dpr);
if(canvas.width!==pw||canvas.height!==ph){canvas.width=pw;canvas.height=ph;}
var ctx=canvas.getContext('2d');
if(!forceW){ctx.setTransform(dpr,0,0,dpr,0,0);}
var bg=getCSSVar('--bg'),bdr=getCSSVar('--b'),t3=getCSSVar('--t3'),t2=getCSSVar('--t2');
ctx.clearRect(0,0,W,H);ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);
var scale=Math.min(W/700,H/500,2.5);
var pd={l:Math.round(62*scale),r:Math.round(18*scale),t:Math.round(22*scale),b:Math.round(52*scale)};
var cw=W-pd.l-pd.r,ch=H-pd.t-pd.b;
if(cw<10||ch<10)return;
var xr=v.x1-v.x0,yr=v.y1-v.y0;if(xr<=0||yr<=0)return;
function tx(x){return pd.l+(x-v.x0)/xr*cw;}
function ty(y){return pd.t+ch-(y-v.y0)/yr*ch;}
canvas._txi=function(px){return v.x0+(px-pd.l)/cw*xr;};
canvas._tyi=function(py){return v.y0+(ch-(py-pd.t))/ch*yr;};
var zl=v.zoom,ptR=zl>=1.5?Math.round(6*scale):zl>=0.9?Math.round(4*scale):zl>=0.5?Math.round(2.5*scale):0;
var fnt=Math.round(12*scale)+'px Inconsolata,monospace';
var fnt2=Math.round(13*scale)+'px Inconsolata,monospace';
var showGrid=togOn('togGrid')||togOn('togGrid2');
var showObs=togOn('togObs')||togOn('togObs2');
var showAnnot=togOn('togAnnot');
var showCI=togOn('togCI');
var showFan=togOn('togFanChart');
var showModels=togOn('togModels');
var showMCMC=togOn('togMCMC');
var showIntCI=togOn('togInterpCI');
var showSamp=togOn('togSamples');
var showDeriv=togOn('togDeriv');
var showVar=togOn('togVar');
var showResid=togOn('togResid');
var showMissCI=togOn('togMissCI');
var ciK=parseFloat($g('pci').value);
function inV(x){var p=tx(x);return p>=pd.l-8&&p<=pd.l+cw+8;}
var lw=Math.max(1,Math.round(scale));
if(showGrid){
var nxt=Math.max(3,Math.min(12,Math.floor(cw/70))),nyt=Math.max(3,Math.min(8,Math.floor(ch/52)));
ctx.strokeStyle=bdr;ctx.lineWidth=lw;ctx.setLineDash([]);ctx.font=fnt;ctx.fillStyle=t3;ctx.textAlign='center';
for(var i=0;i<=nxt;i++){var xv=v.x0+i*xr/nxt,px2=tx(xv);ctx.beginPath();ctx.moveTo(px2,pd.t);ctx.lineTo(px2,pd.t+ch);ctx.stroke();ctx.fillText(xv.toFixed(2),px2,H-pd.b+Math.round(14*scale));}
ctx.textAlign='right';
for(var j=0;j<=nyt;j++){var yv=v.y0+j*yr/nyt,py2=ty(yv);ctx.beginPath();ctx.moveTo(pd.l,py2);ctx.lineTo(W-pd.r,py2);ctx.stroke();ctx.fillText(yv.toFixed(2),pd.l-4,py2+4);}
ctx.fillStyle=t2;ctx.textAlign='center';ctx.font=fnt2;
ctx.fillText('X',W/2,H-3);ctx.save();ctx.translate(Math.round(13*scale),H/2);ctx.rotate(-Math.PI/2);ctx.fillText('Y',0,0);ctx.restore();}
if(!gprResult||!gprResult.length){
ctx.fillStyle=t3;ctx.textAlign='center';ctx.font=Math.round(16*scale)+'px VT323,monospace';
ctx.fillText('[ VERƒ∞ Gƒ∞Rƒ∞N ‚Üí HESAPLA ]',W/2,H/2);
ctx.font=Math.round(11*scale)+'px Inconsolata,monospace';ctx.fillStyle=getCSSVar('--b2');
ctx.fillText('scroll=zoom  drag=pan  dblclick=reset  Ctrl+Enter=hesapla',W/2,H/2+Math.round(22*scale));
ctx.strokeStyle=bdr;ctx.lineWidth=lw;ctx.strokeRect(pd.l,pd.t,cw,ch);return;}
gprResult.forEach(function(r){
var Xs=r.Xs,mu=r.mu,va=r.va,c=r.color,xF=r.xFut,eF=r.ensF,eV=r.ensV;
var fst;
if(showVar){for(var i=0;i<Xs.length-1;i++){if(!inV(Xs[i]))continue;var nm=Math.min(1,Math.sqrt(va[i])/2);ctx.fillStyle=h2r(c,nm*0.15);ctx.fillRect(tx(Xs[i]),pd.t,Math.max(1,tx(Xs[i+1])-tx(Xs[i])),ch);}}
if(showIntCI){ctx.beginPath();fst=true;for(var i=0;i<Xs.length;i++){if(!inV(Xs[i]))continue;var px=tx(Xs[i]),py=ty(mu[i]+ciK*Math.sqrt(va[i]));if(fst){ctx.moveTo(px,py);fst=false;}else ctx.lineTo(px,py);}for(var i=Xs.length-1;i>=0;i--){if(!inV(Xs[i]))continue;ctx.lineTo(tx(Xs[i]),ty(mu[i]-ciK*Math.sqrt(va[i])));}ctx.closePath();ctx.fillStyle=h2r(c,.07);ctx.fill();[1,-1].forEach(function(sign){ctx.beginPath();fst=true;for(var i=0;i<Xs.length;i++){if(!inV(Xs[i]))continue;if(fst){ctx.moveTo(tx(Xs[i]),ty(mu[i]+sign*ciK*Math.sqrt(va[i])));fst=false;}else ctx.lineTo(tx(Xs[i]),ty(mu[i]+sign*ciK*Math.sqrt(va[i])));}ctx.strokeStyle=h2r(c,.25);ctx.lineWidth=lw;ctx.setLineDash([3,5]);ctx.stroke();ctx.setLineDash([]);});}
if(showSamp&&r.samps){r.samps.forEach(function(sp){ctx.beginPath();fst=true;for(var i=0;i<Xs.length;i++){if(!inV(Xs[i]))continue;if(fst){ctx.moveTo(tx(Xs[i]),ty(sp[i]));fst=false;}else ctx.lineTo(tx(Xs[i]),ty(sp[i]));}ctx.strokeStyle=h2r(c,.15);ctx.lineWidth=lw;ctx.setLineDash([2,6]);ctx.stroke();ctx.setLineDash([]);});}
if(showDeriv&&r.dm){var dmx=Math.max.apply(null,r.dm.map(Math.abs))||1,cY=(v.y0+v.y1)/2,rang=yr*0.2;ctx.beginPath();fst=true;for(var i=0;i<Xs.length;i++){if(!inV(Xs[i]))continue;if(fst){ctx.moveTo(tx(Xs[i]),ty(cY+r.dm[i]/dmx*rang));fst=false;}else ctx.lineTo(tx(Xs[i]),ty(cY+r.dm[i]/dmx*rang));}ctx.strokeStyle='rgba(245,158,11,.5)';ctx.lineWidth=lw*1.2;ctx.setLineDash([]);ctx.stroke();}
ctx.beginPath();fst=true;for(var i=0;i<Xs.length;i++){if(!inV(Xs[i]))continue;var px=tx(Xs[i]),py2=ty(mu[i]);if(fst){ctx.moveTo(px,py2);fst=false;}else ctx.lineTo(px,py2);}ctx.strokeStyle=c;ctx.lineWidth=lw*2;ctx.setLineDash([]);ctx.shadowColor=h2r(c,.4);ctx.shadowBlur=4*scale;ctx.stroke();ctx.shadowBlur=0;
if(xF&&xF.length){var lx=tx(r.X[r.X.length-1]);ctx.beginPath();ctx.moveTo(lx,pd.t);ctx.lineTo(lx,pd.t+ch);ctx.strokeStyle=h2r(c,.2);ctx.lineWidth=lw;ctx.setLineDash([4,5]);ctx.stroke();ctx.setLineDash([]);ctx.fillStyle=h2r(c,.4);ctx.font=Math.round(9*scale)+'px Inconsolata,monospace';ctx.fillText('‚ñ∂TAHMIN',lx+3,pd.t+Math.round(11*scale));}
if(showFan&&xF&&xF.length){[3,2,1.5,1].forEach(function(k2,ki){ctx.beginPath();fst=true;for(var i=0;i<xF.length;i++){if(!inV(xF[i]))continue;var px=tx(xF[i]),py=ty(eF[i]+k2*Math.sqrt(Math.max(0,eV[i])));if(fst){ctx.moveTo(px,py);fst=false;}else ctx.lineTo(px,py);}for(var i=xF.length-1;i>=0;i--){if(!inV(xF[i]))continue;ctx.lineTo(tx(xF[i]),ty(eF[i]-k2*Math.sqrt(Math.max(0,eV[i]))));}ctx.closePath();ctx.fillStyle=h2r(c,.04+ki*0.02);ctx.fill();});}
if(showCI&&xF&&xF.length){ctx.beginPath();fst=true;for(var i=0;i<xF.length;i++){if(!inV(xF[i]))continue;if(fst){ctx.moveTo(tx(xF[i]),ty(eF[i]+ciK*Math.sqrt(Math.max(0,eV[i]))));fst=false;}else ctx.lineTo(tx(xF[i]),ty(eF[i]+ciK*Math.sqrt(Math.max(0,eV[i]))));}for(var i=xF.length-1;i>=0;i--){if(!inV(xF[i]))continue;ctx.lineTo(tx(xF[i]),ty(eF[i]-ciK*Math.sqrt(Math.max(0,eV[i]))));}ctx.closePath();ctx.fillStyle=h2r(c,.1);ctx.fill();}
if(showMCMC&&r.mcSamp&&r.mcSamp.length&&xF){r.mcSamp.forEach(function(s2){ctx.beginPath();fst=true;for(var i=0;i<xF.length;i++){if(!inV(xF[i]))continue;if(fst){ctx.moveTo(tx(xF[i]),ty(s2[i]));fst=false;}else ctx.lineTo(tx(xF[i]),ty(s2[i]));}ctx.strokeStyle=h2r(c,.08);ctx.lineWidth=lw;ctx.setLineDash([]);ctx.stroke();});}
var mdColors={'GPR':'#4ade80','KALMAN':'#38bdf8','AR':'#f59e0b','ARIMA':'#a78bfa','ETS':'#f472b6','LSTM':'#22d3ee'};
if(showModels&&xF&&xF.length){[[r.gprFut,'GPR'],[r.kalmFut,'KALMAN'],[r.arFut,'AR'],[r.ariFut,'ARIMA'],[r.etsFut,'ETS'],[r.lstFut,'LSTM']].forEach(function(pair){var data=pair[0],nm=pair[1],mc=mdColors[nm]||c;ctx.beginPath();fst=true;for(var i=0;i<xF.length;i++){if(!inV(xF[i]))continue;if(fst){ctx.moveTo(tx(xF[i]),ty(data[i]));fst=false;}else ctx.lineTo(tx(xF[i]),ty(data[i]));}ctx.strokeStyle=h2r(mc,.5);ctx.lineWidth=lw;ctx.setLineDash([2,4]);ctx.stroke();ctx.setLineDash([]);ctx.fillStyle=h2r(mc,.7);ctx.font=Math.round(8*scale)+'px Inconsolata,monospace';var lxi=xF[xF.length-1];if(inV(lxi))ctx.fillText(nm,tx(lxi)+2,ty(data[data.length-1]));});}
if(xF&&xF.length){ctx.beginPath();fst=true;var cp=[{x:r.X[r.X.length-1],y:r.y[r.y.length-1]}].concat(xF.map(function(x,i){return{x:x,y:eF[i]};}));for(var i=0;i<cp.length;i++){if(!inV(cp[i].x))continue;if(fst){ctx.moveTo(tx(cp[i].x),ty(cp[i].y));fst=false;}else ctx.lineTo(tx(cp[i].x),ty(cp[i].y));}ctx.strokeStyle=c;ctx.lineWidth=lw*2;ctx.setLineDash([6,3]);ctx.shadowColor=h2r(c,.3);ctx.shadowBlur=3*scale;ctx.stroke();ctx.shadowBlur=0;ctx.setLineDash([]);
for(var i=0;i<xF.length;i++){if(!inV(xF[i]))continue;var px=tx(xF[i]),py2=ty(eF[i]);ctx.beginPath();ctx.arc(px,py2,3.5*scale,0,6.283);ctx.fillStyle=c;ctx.fill();ctx.strokeStyle=bg;ctx.lineWidth=1.5*scale;ctx.stroke();}}
if(r.missingPred&&r.missingPred.length){r.missingPred.forEach(function(mp){if(!inV(mp.x))return;var px=tx(mp.x),py2=ty(mp.mu),sd=Math.sqrt(mp.va);ctx.beginPath();ctx.moveTo(px-4*scale,py2);ctx.lineTo(px+4*scale,py2);ctx.moveTo(px,py2-4*scale);ctx.lineTo(px,py2+4*scale);ctx.strokeStyle='#22d3ee';ctx.lineWidth=2*scale;ctx.stroke();if(showMissCI){ctx.beginPath();ctx.moveTo(px,ty(mp.mu+ciK*sd));ctx.lineTo(px,ty(mp.mu-ciK*sd));ctx.strokeStyle=h2r('#22d3ee',.35);ctx.lineWidth=lw;ctx.stroke();}});}
if(showObs){r.X.forEach(function(x,i){var px=tx(x),py2=ty(r.y[i]);if(px<pd.l-15||px>pd.l+cw+15)return;if(ptR>0){ctx.beginPath();ctx.arc(px,py2,ptR,0,6.283);ctx.fillStyle=c;ctx.fill();ctx.strokeStyle=bg;ctx.lineWidth=1.5*scale;ctx.stroke();ctx.shadowColor=h2r(c,.5);ctx.shadowBlur=6*scale;ctx.beginPath();ctx.arc(px,py2,ptR,0,6.283);ctx.fill();ctx.shadowBlur=0;}else{ctx.beginPath();ctx.moveTo(px-2.5*scale,py2);ctx.lineTo(px+2.5*scale,py2);ctx.moveTo(px,py2-2.5*scale);ctx.lineTo(px,py2+2.5*scale);ctx.strokeStyle=c;ctx.lineWidth=1.5*scale;ctx.stroke();}if(showAnnot&&ptR>2){ctx.fillStyle=c;ctx.font=Math.round(9*scale)+'px Inconsolata,monospace';ctx.textAlign='center';ctx.fillText(r.y[i].toFixed(1),px,py2-ptR-2);}});}
if(showResid&&r.mu&&r.va){r.X.forEach(function(x,i){if(!inV(x))return;var idx=0,bd=1e9;for(var j=0;j<Xs.length;j++){var dd=Math.abs(Xs[j]-x);if(dd<bd){bd=dd;idx=j;}}var fitted=mu[idx],px=tx(x),pyObs=ty(r.y[i]),pyFit=ty(fitted);ctx.beginPath();ctx.moveTo(px,pyObs);ctx.lineTo(px,pyFit);ctx.strokeStyle=h2r('#ef4444',.4);ctx.lineWidth=lw;ctx.setLineDash([2,3]);ctx.stroke();ctx.setLineDash([]);});}
});
ctx.strokeStyle=bdr;ctx.lineWidth=lw;ctx.setLineDash([]);ctx.strokeRect(pd.l,pd.t,cw,ch);
var zi=isFs?$g('fsZI'):$g('mainZI');if(zi)zi.textContent='Z:'+v.zoom.toFixed(2)+'√ó X:['+v.x0.toFixed(1)+','+v.x1.toFixed(1)+'] Y:['+v.y0.toFixed(1)+','+v.y1.toFixed(1)+']';$g('zTxt').textContent=v.zoom.toFixed(2)+'√ó';}

function togOn(id){var el=$g(id);return el&&el.classList.contains('on');}

// ZOOM & PAN
function zV(v,f,cx,cy){var xr=v.x1-v.x0,yr=v.y1-v.y0,fx=cx!=null?(cx-v.x0)/xr:.5,fy=cy!=null?1-(cy-v.y0)/yr:.5,nxr=xr*f,nyr=yr*f;v.x0=cx!=null?cx-fx*nxr:v.x0+(xr-nxr)/2;v.x1=v.x0+nxr;v.y0=cy!=null?cy-fy*nyr:v.y0+(yr-nyr)/2;v.y1=v.y0+nyr;v.zoom=v.zoom/f;}
function pV(v,dx,dy){v.x0+=dx;v.x1+=dx;v.y0+=dy;v.y1+=dy;}
function resetV(){if(!gprResult||!gprResult.length)return;var xa=[],ya=[];gprResult.forEach(function(r){xa=xa.concat(r.X);ya=ya.concat(r.mu);r.y.forEach(function(v){ya.push(v);});if(r.ensF)r.ensF.forEach(function(v){ya.push(v);});if(r.xFut)xa=xa.concat(r.xFut);});var xn=Math.min.apply(null,xa),xx=Math.max.apply(null,xa),yn=Math.min.apply(null,ya),yx=Math.max.apply(null,ya),xp=(xx-xn)*.12||.5,yp=(yx-yn)*.2||1;view={x0:xn-xp,x1:xx+xp*.3,y0:yn-yp,y1:yx+yp,zoom:1};fsView={x0:view.x0,x1:view.x1,y0:view.y0,y1:view.y1,zoom:1};schedR();}

function setupC(canvas,v,chiId){
canvas.addEventListener('wheel',function(e){e.preventDefault();var r=canvas.getBoundingClientRect(),cx=canvas._txi?canvas._txi(e.clientX-r.left):(v.x0+v.x1)/2,cy=canvas._tyi?canvas._tyi(e.clientY-r.top):(v.y0+v.y1)/2;zV(v,e.deltaY>0?1.08:.926,cx,cy);schedR();},{passive:false});
var dr=false,last={x:0,y:0};
canvas.addEventListener('mousedown',function(e){dr=true;last={x:e.clientX,y:e.clientY};canvas.style.cursor='grabbing';e.preventDefault();});
window.addEventListener('mousemove',function(e){
if(dr){var r=canvas.getBoundingClientRect(),cW=r.width,dx=(e.clientX-last.x)/cW*(v.x1-v.x0),dy=(e.clientY-last.y)/r.height*(v.y1-v.y0);pV(v,-dx,dy);last={x:e.clientX,y:e.clientY};schedR();}
if(canvas._txi&&gprResult&&gprResult.length){var r2=canvas.getBoundingClientRect();if(e.clientX<r2.left||e.clientX>r2.right||e.clientY<r2.top||e.clientY>r2.bottom)return;var cx2=canvas._txi(e.clientX-r2.left);var rr=gprResult[0],bi=-1,bd=1e9;for(var i=0;i<rr.Xs.length;i++){var dd=Math.abs(rr.Xs[i]-cx2);if(dd<bd){bd=dd;bi=i;}}if(bi>=0&&chiId){var mu=rr.mu[bi],sd=Math.sqrt(rr.va[bi]),ciK2=parseFloat($g('pci').value),chi=$g(chiId);chi.style.display='block';chi.textContent='x='+cx2.toFixed(3)+' Œº='+mu.toFixed(3)+' œÉ='+sd.toFixed(3)+' CI:['+( mu-ciK2*sd).toFixed(2)+','+( mu+ciK2*sd).toFixed(2)+']';}}});
window.addEventListener('mouseup',function(){dr=false;canvas.style.cursor='crosshair';});
canvas.addEventListener('dblclick',resetV);
if(chiId)canvas.addEventListener('mouseleave',function(){var ch=$g(chiId);if(ch)ch.style.display='none';});
var td=0;
canvas.addEventListener('touchstart',function(e){e.preventDefault();if(e.touches.length===1){dr=true;last={x:e.touches[0].clientX,y:e.touches[0].clientY};}else if(e.touches.length===2){dr=false;td=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}},{passive:false});
canvas.addEventListener('touchmove',function(e){e.preventDefault();if(e.touches.length===1&&dr){var r=canvas.getBoundingClientRect(),dx=(e.touches[0].clientX-last.x)/r.width*(v.x1-v.x0),dy=(e.touches[0].clientY-last.y)/r.height*(v.y1-v.y0);pV(v,-dx,dy);last={x:e.touches[0].clientX,y:e.touches[0].clientY};schedR();}else if(e.touches.length===2){var nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(td)zV(v,td/nd,(v.x0+v.x1)/2,(v.y0+v.y1)/2);td=nd;schedR();}},{passive:false});
canvas.addEventListener('touchend',function(){dr=false;});}

// AUTO OPTIMIZE ‚Äî full grid search over ‚Ñì, œÉ_n (+ p for periodic) for CURRENT kernel
function autoOpt(){
var d=getD();if(d.y.length<3)return;
var X=d.X,y=d.y,k=$g('kernelSel').value,pp=parseFloat($g('pp').value||3),aa=parseFloat($g('pa').value||1),deg=parseInt($g('pd').value||2);
var Ls=[0.1,0.3,0.5,1,1.5,2,3,5,8],Ns=[0.001,0.01,0.05,0.1,0.3,0.5];
var best=-Infinity,bL=1.5,bN=0.1,ym=y.reduce(function(a,b){return a+b;},0)/y.length,yv=y.reduce(function(a,b){return a+Math.pow(b-ym,2);},0)/y.length,sf=Math.sqrt(yv)||1;
Ls.forEach(function(l){Ns.forEach(function(sn){try{var K=bK(X,X,l,sf,k,pp,aa,deg);for(var i=0;i<K.length;i++)K[i][i]+=sn*sn;var v2=cLML(y,K);if(!isNaN(v2)&&v2>best){best=v2;bL=l;bN=sn;}}catch(e){}});});
setSP('pl','pl_n','lv',bL,2);setSP('pn','pn_n','nv',bN,3);
$g('optRes').textContent='GRID: ‚Ñì='+bL+' œÉ_n='+bN+' LML='+best.toFixed(3);
log('GridSearch ‚Ñì='+bL+' œÉ_n='+bN,'ok');runGPR();}

// BEST LML ‚Äî for current kernel, optimize ALL relevant params
function bestLML(){
var d=getD();if(d.y.length<3)return;
var X=d.X,y=d.y,k=$g('kernelSel').value;
var Ls=[0.05,0.1,0.2,0.5,0.8,1,1.5,2,3,5,8,10];
var Ns=[0.001,0.005,0.01,0.05,0.1,0.2,0.5,1];
var Ps=k==='periodic'||k==='spectral'?[1,2,3,5,7,10]:[3];
var As=k==='rq'?[0.1,0.5,1,2,5]:[1];
var Ds=k==='poly'?[1,2,3]:[2];
var best=-Infinity,bL=1.5,bN=0.1,bP=3,bA=1,bD=2;
var ym=y.reduce(function(a,b){return a+b;},0)/y.length,yv=y.reduce(function(a,b){return a+Math.pow(b-ym,2);},0)/y.length,sf=Math.sqrt(yv)||1;
Ls.forEach(function(l){Ns.forEach(function(sn){Ps.forEach(function(pp){As.forEach(function(aa){Ds.forEach(function(deg){
try{var K=bK(X,X,l,sf,k,pp,aa,deg);for(var i=0;i<K.length;i++)K[i][i]+=sn*sn;var v2=cLML(y,K);if(!isNaN(v2)&&v2>best){best=v2;bL=l;bN=sn;bP=pp;bA=aa;bD=deg;}}catch(e){}});});});});});
setSP('pl','pl_n','lv',bL,2);setSP('pn','pn_n','nv',bN,3);
if(k==='periodic'||k==='spectral')setSP('pp','pp_n','ppv',bP,1);
if(k==='rq')setSP('pa','pa_n','av',bA,1);
if(k==='poly')setSP('pd','pd_n','dv',bD,0);
$g('optRes').textContent='BEST LML ['+k+']: ‚Ñì='+bL+' œÉ_n='+bN+(bP!==3?' p='+bP:'')+(bA!==1?' Œ±='+bA:'')+(bD!==2?' d='+bD:'')+' ‚Üí LML='+best.toFixed(3);
log('BEST LML ['+k+'] ‚Ñì='+bL+' œÉ_n='+bN,'ok');runGPR();}

function setSP(sid,nid,did,val,dec){var s=$g(sid),n=$g(nid),d=$g(did);if(s)s.value=val;if(n)n.value=val;if(d)d.textContent=parseFloat(val).toFixed(dec);}

function exportCSV(){
var d=getD();if(!gprResult||!gprResult.length)return;
var rows=[['x','type','series','mu','lower','upper']];
d.X.forEach(function(x,i){rows.push([x,'observed','aktif',d.y[i],'','']);});
gprResult.forEach(function(r){if(r.xFut)r.xFut.forEach(function(x,i){var sd=Math.sqrt(Math.max(0,r.ensV[i])),ciK=parseFloat($g('pci').value);rows.push([x,'forecast',r.name,r.ensF[i].toFixed(4),(r.ensF[i]-ciK*sd).toFixed(4),(r.ensF[i]+ciK*sd).toFixed(4)]);});});
var csv=rows.map(function(r){return r.join(',');}).join('\n');
var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='gpr_export.csv';a.click();}

function runGPR(){
var btn=$g('runBtn');btn.disabled=true;btn.textContent='[ √áALI≈ûIYOR... ]';setSt('WORKING');prog(3);
setTimeout(function(){try{computeGPR();}catch(e){log('Hata: '+e.message,'er');}btn.disabled=false;btn.textContent='[ HESAPLA ]';setSt('TAMAM');},60);}

function openFs(){
$g('fsO').classList.add('on');
fsView={x0:view.x0,x1:view.x1,y0:view.y0,y1:view.y1,zoom:view.zoom};
setTimeout(function(){var fc=$g('fsC'),fca=$g('fsCA');fc.width=0;fc.height=0;setupC(fc,fsView,'fsCHI');renderCon(fc,fsView,true);},60);}
function closeFs(){$g('fsO').classList.remove('on');}

// SYNC slider ‚Üî number inputs
function syncPair(sliderId,numId,dispId,fmt){
var s=$g(sliderId),n=$g(numId),disp=dispId?$g(dispId):null;
if(!s||!n)return;
function upd(v){v=parseFloat(v);if(isNaN(v))return;s.value=v;n.value=v;if(disp)disp.textContent=v.toFixed(fmt===undefined?2:fmt);}
s.addEventListener('input',function(){upd(this.value);schedR();});
n.addEventListener('input',function(){upd(this.value);schedR();});}

var rTO=null;
window.addEventListener('resize',function(){clearTimeout(rTO);rTO=setTimeout(function(){schedR();},100);});

document.addEventListener('DOMContentLoaded',function(){
initBlocks();initPopups();
syncPair('pl','pl_n','lv',2);syncPair('pn','pn_n','nv',3);syncPair('pp','pp_n','ppv',1);syncPair('pa','pa_n','av',1);syncPair('pd','pd_n','dv',0);
syncPair('pst','pst_n','stv',0);syncPair('pci','pci_n','civ',2);syncPair('pres','pres_n','resv',0);
syncPair('wg','wg_n','wgv',2);syncPair('wk','wk_n','wkv',2);syncPair('wa','wa_n','wav',2);syncPair('wr','wr_n','wrv',2);syncPair('we','we_n','wev',2);syncPair('wl','wl_n','wlv',2);
$g('kernelSel').addEventListener('change',updKI);
$g('runBtn').addEventListener('click',runGPR);
$g('autoOptBtn').addEventListener('click',autoOpt);
$g('bestLMLBtn').addEventListener('click',bestLML);
$g('addSerBtn').addEventListener('click',addSer);
$g('refreshBtn').addEventListener('click',function(){parseTA();analyzeData();log('Yenilendi','ok');});
$g('confirmPt').addEventListener('click',addXY);
$g('csvFile').addEventListener('change',impCSV);
$g('exportBtn').addEventListener('click',exportCSV);
$g('analyzeBtn').addEventListener('click',function(){analyzeData();log('Analiz yapƒ±ldƒ±','ok');});
$g('snapBtn').addEventListener('click',snapPNG);
$g('togPtBtn').addEventListener('click',function(){var el=$g('xyf'),on=el.style.display==='flex';el.style.display=on?'none':'flex';this.classList.toggle('act',!on);if(!on)$g('addX').focus();});
$g('themeBtn').addEventListener('click',function(){document.body.classList.toggle('light');this.textContent=document.body.classList.contains('light')?'‚òÄ':'‚òæ';schedR();});
$g('fsBtn').addEventListener('click',openFs);
$g('fsBtn2').addEventListener('click',openFs);
$g('fsClose').addEventListener('click',closeFs);
$g('zInBtn').addEventListener('click',function(){zV(view,.75);schedR();});
$g('zOutBtn').addEventListener('click',function(){zV(view,1.33);schedR();});
$g('zReset').addEventListener('click',resetV);
$g('fsZIn').addEventListener('click',function(){zV(fsView,.75);renderCon($g('fsC'),fsView,true);});
$g('fsZOut').addEventListener('click',function(){zV(fsView,1.33);renderCon($g('fsC'),fsView,true);});
$g('fsZReset').addEventListener('click',function(){fsView={x0:view.x0,x1:view.x1,y0:view.y0,y1:view.y1,zoom:view.zoom};renderCon($g('fsC'),fsView,true);});
document.querySelectorAll('.tab').forEach(function(t){t.addEventListener('click',function(){var tab=this.dataset.tab;document.querySelectorAll('.tab').forEach(function(x){x.classList.remove('act');});document.querySelectorAll('.tab-content').forEach(function(x){x.classList.remove('act');});this.classList.add('act');$g('tab-'+tab).classList.add('act');});});
document.querySelectorAll('.tog').forEach(function(t){t.addEventListener('click',function(){this.classList.toggle('on');schedR();});});
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeFs();if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();runGPR();}if(!e.ctrlKey&&!e.metaKey&&e.target.tagName!=='INPUT'&&e.target.tagName!=='TEXTAREA'){if(e.key==='+')zV(view,.8),schedR();if(e.key==='-')zV(view,1.25),schedR();if(e.key==='r')resetV();}});
updKI();parseTA();renderSL();analyzeData();setSt('HAZIR');
log('GPR¬∑PRO ¬∑ Ctrl+Enter=hesapla ¬∑ dbl=reset ¬∑ drag=pan ¬∑ scroll=zoom','inf');
var mc=$g('mainC');
setupC(mc,view,'mainCHI');schedR();
setTimeout(runGPR,700);});
})();
</script></body></html>
