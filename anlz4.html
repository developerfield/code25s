<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seri Analiz & Tahmin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&display=swap');

:root {
  --bg:     #f4efe4;
  --paper:  #faf6ed;
  --ink:    #1c1710;
  --ink2:   #3a3228;
  --ink3:   #6e6050;
  --rule:   #d6c9b4;
  --red:    #b83232;
  --blue:   #1a5c8a;
  --green:  #1f7a45;
  --amber:  #c07a00;
  --purple: #6b3fa0;
  --band:   rgba(31,122,69,0.10);
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
  background:var(--bg);
  color:var(--ink);
  font-family:'Space Mono',monospace;
  min-height:100vh;
}

/* lined-paper bg */
body::before{
  content:'';
  position:fixed;inset:0;
  background-image:repeating-linear-gradient(
    transparent,transparent 27px,
    rgba(180,158,130,.22) 27px,rgba(180,158,130,.22) 28px
  );
  pointer-events:none;z-index:0;
}

.wrap{
  position:relative;z-index:1;
  max-width:1280px;margin:0 auto;padding:28px 22px 60px;
}

/* ── HEADER ── */
header{
  border-bottom:3px solid var(--ink);
  padding-bottom:18px;margin-bottom:30px;
}
.eyebrow{font-size:10px;letter-spacing:4px;color:var(--ink3);text-transform:uppercase;margin-bottom:4px;}
h1{
  font-family:'Bebas Neue',sans-serif;
  font-size:clamp(34px,5.5vw,66px);
  letter-spacing:3px;line-height:.95;color:var(--ink);
}
h1 em{color:var(--blue);font-style:normal;}
h1 strong{color:var(--red);}
.sub{margin-top:8px;font-size:11px;color:var(--ink3);line-height:1.85;max-width:560px;}

/* ── TWO-COL ENTRY ── */
.entry-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;margin-bottom:22px;
}
@media(max-width:820px){.entry-grid{grid-template-columns:1fr;}}

.panel{
  background:var(--paper);
  border:2px solid var(--ink);
  padding:20px;
  position:relative;
}
.panel::before{
  content:attr(data-lbl);
  position:absolute;top:-12px;left:12px;
  background:var(--paper);padding:0 8px;
  font-size:10px;letter-spacing:3px;text-transform:uppercase;font-weight:700;
  border:2px solid var(--ink);
}
.panel.blue-lbl::before{color:var(--blue);border-color:var(--blue);}
.panel.red-lbl::before{color:var(--red);border-color:var(--red);}

.panel-hint{font-size:10px;color:var(--ink3);margin-top:7px;line-height:1.75;}
.panel-hint b{color:var(--blue);}

textarea{
  width:100%;height:110px;
  background:transparent;border:1px solid var(--rule);
  color:var(--ink);font-family:'Space Mono',monospace;font-size:12px;
  padding:9px 10px;resize:vertical;outline:none;line-height:1.75;
}
textarea:focus{border-color:var(--ink);}

/* step-set tags */
#tagWrap{
  display:flex;flex-wrap:wrap;gap:6px;
  min-height:34px;padding:6px;
  border:1px solid var(--rule);background:transparent;
  margin-bottom:8px;cursor:text;
}
.tag{
  display:inline-flex;align-items:center;gap:5px;
  background:rgba(26,92,138,.1);border:1px solid rgba(26,92,138,.35);
  color:var(--blue);padding:3px 9px;font-size:11px;
  border-radius:0;animation:tagIn .15s ease;
}
@keyframes tagIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.tag-del{
  cursor:pointer;font-size:13px;color:var(--blue);opacity:.6;
  line-height:1;border:none;background:none;font-family:inherit;
}
.tag-del:hover{opacity:1;color:var(--red);}
#tagInput{
  border:none;outline:none;background:transparent;
  font-family:'Space Mono',monospace;font-size:12px;
  color:var(--ink);min-width:80px;flex:1;
}

/* ── CONTROLS ROW ── */
.ctrl-row{
  display:flex;gap:10px;flex-wrap:wrap;align-items:center;
  margin-bottom:22px;padding:14px 18px;
  background:var(--paper);border:2px solid var(--ink);
}
.ctrl{display:flex;flex-direction:column;gap:4px;}
.ctrl label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);}
.ctrl .v{font-size:14px;font-weight:700;color:var(--ink);}
.ctrl input[type=range]{
  -webkit-appearance:none;width:110px;height:3px;
  background:var(--rule);outline:none;cursor:pointer;
}
.ctrl input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:13px;height:13px;
  background:var(--ink);border-radius:50%;cursor:pointer;
}
.ctrl select{
  background:transparent;border:1px solid var(--rule);
  color:var(--ink);padding:5px 8px;
  font-family:'Space Mono',monospace;font-size:11px;outline:none;cursor:pointer;
}
.ctrl select:focus{border-color:var(--ink);}

.btn{
  padding:9px 18px;
  background:var(--ink);color:var(--bg);
  border:2px solid var(--ink);
  font-family:'Space Mono',monospace;font-size:11px;
  letter-spacing:2px;text-transform:uppercase;
  cursor:pointer;transition:all .15s;white-space:nowrap;
}
.btn:hover{background:transparent;color:var(--ink);}
.btn.b-blue{background:var(--blue);border-color:var(--blue);}
.btn.b-blue:hover{background:transparent;color:var(--blue);}
.btn.b-green{background:var(--green);border-color:var(--green);}
.btn.b-green:hover{background:transparent;color:var(--green);}
.btn.b-red{background:var(--red);border-color:var(--red);}
.btn.b-red:hover{background:transparent;color:var(--red);}
.btn:disabled{opacity:.38;cursor:not-allowed;}

/* ── STAT BAR ── */
.stat-bar{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:0;margin-bottom:22px;
  border:2px solid var(--ink);overflow:hidden;
}
.si{
  padding:11px 14px;background:var(--paper);
  border-right:1px solid var(--rule);
}
.si:last-child{border-right:none;}
.si-lbl{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);margin-bottom:3px;}
.si-val{font-size:19px;font-weight:700;color:var(--ink);}
.si-val.ok{color:var(--green);}
.si-val.warn{color:var(--amber);}
.si-val.err{color:var(--red);}
.si-sub{font-size:10px;color:var(--ink3);margin-top:2px;}

/* ── CHART ── */
.chart-card{
  background:var(--paper);border:2px solid var(--ink);
  padding:18px 20px;margin-bottom:20px;
}
.chart-card.fullscreen{
  position:fixed!important;inset:0!important;z-index:9999!important;
  margin:0!important;border:none!important;
  display:flex;flex-direction:column;padding:16px 20px;
  background:var(--paper)!important;
}
.chart-card.fullscreen .chart-wrap{flex:1;height:auto!important;}

.chart-top{
  display:flex;align-items:center;justify-content:space-between;
  flex-wrap:wrap;gap:8px;margin-bottom:6px;
}
.chart-title-txt{
  font-family:'Bebas Neue',sans-serif;
  font-size:20px;letter-spacing:2px;
}
.chart-btns{display:flex;gap:5px;}
.cc-btn{
  background:var(--paper);border:2px solid var(--ink);
  color:var(--ink);font-family:'Space Mono',monospace;
  font-size:14px;width:30px;height:30px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  padding:0;transition:all .12s;line-height:1;
}
.cc-btn:hover{background:var(--ink);color:var(--bg);}

.legend{display:flex;gap:16px;flex-wrap:wrap;font-size:10px;margin-bottom:10px;}
.leg{display:flex;align-items:center;gap:5px;}
.leg-line{width:22px;height:3px;border-radius:1px;}

.chart-wrap{position:relative;width:100%;height:340px;}
.chart-wrap canvas{position:absolute;inset:0;width:100%!important;height:100%!important;}

/* ── RESULTS ── */
.results-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:18px;margin-bottom:18px;
}
@media(max-width:700px){.results-grid{grid-template-columns:1fr;}}

.rc{background:var(--paper);border:2px solid var(--ink);padding:18px;}
.rc-title{
  font-family:'Bebas Neue',sans-serif;
  font-size:17px;letter-spacing:2px;
  border-bottom:1px solid var(--rule);padding-bottom:7px;margin-bottom:12px;
}
.fr{
  display:flex;justify-content:space-between;align-items:baseline;
  padding:5px 0;border-bottom:1px dotted var(--rule);font-size:11px;
}
.fr:last-child{border-bottom:none;}
.fr-l{color:var(--ink3);}
.fr-r{font-weight:700;}
.fr-r.ok{color:var(--green);}
.fr-r.warn{color:var(--amber);}
.fr-r.err{color:var(--red);}

/* pred table */
.pred-table{width:100%;border-collapse:collapse;font-size:11px;}
.pred-table th{
  text-align:left;padding:5px 8px;
  border-bottom:2px solid var(--ink);
  font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);
}
.pred-table td{padding:5px 8px;border-bottom:1px dotted var(--rule);}
.pb{width:70px;}
.pbar{height:6px;background:var(--rule);border-radius:2px;overflow:hidden;}
.pbar-fill{height:100%;border-radius:2px;}

/* info box */
.info-box{
  background:var(--paper);border-left:4px solid var(--ink);
  padding:14px 18px;margin-bottom:18px;
  font-size:11px;line-height:1.9;color:var(--ink2);
}

/* progress */
.prog-wrap{
  display:none;background:var(--paper);border:2px solid var(--ink);
  padding:14px 18px;margin-bottom:18px;
}
.prog-lbl{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--ink3);margin-bottom:6px;}
.prog-outer{width:100%;height:5px;background:var(--rule);}
.prog-inner{height:100%;background:var(--green);transition:width .1s;}
.prog-txt{font-size:13px;font-weight:700;margin-top:5px;}

/* allowed-set badge */
.set-badge{
  display:inline-block;padding:2px 8px;
  background:rgba(26,92,138,.1);border:1px solid rgba(26,92,138,.3);
  color:var(--blue);font-size:10px;letter-spacing:1px;
  margin-bottom:8px;
}
</style>
</head>
<body>
<div class="wrap">

<header>
  <div class="eyebrow">// Seri Analiz · Adım Kümesi · Tahmin</div>
  <h1><em>SERİ</em><br><strong>TAHMİN</strong></h1>
  <p class="sub">
    İzin verilen saat-başı değerleri tanımla · Veri serisini gir<br>
    ARIMA + Monte Carlo ile n adım ilerisi tahmin edilsin
  </p>
</header>

<!-- ENTRY -->
<div class="entry-grid">

  <!-- Step set -->
  <div class="panel blue-lbl" data-lbl="izin verilen değerler (adım kümesi)">
    <div id="tagWrap" onclick="document.getElementById('tagInput').focus()">
      <input id="tagInput" placeholder="3.2 gir, Enter'a bas…" autocomplete="off">
    </div>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <button class="btn b-blue" style="padding:6px 12px;font-size:10px;" onclick="addTagFromInput()">+ EKLE</button>
      <button class="btn" style="padding:6px 12px;font-size:10px;background:transparent;color:var(--ink3);border-color:var(--rule);" onclick="clearTags()">TEMİZLE</button>
    </div>
    <div class="panel-hint">Her saat bu değerlerden biri olabilir. <b>Örnek: 3, 3.2, 3.4</b><br>Gir ve Enter'a bas ya da + Ekle butonunu kullan.</div>
  </div>

  <!-- Series data -->
  <div class="panel red-lbl" data-lbl="veri serisi">
    <textarea id="seriesInput" placeholder="3,3,3,3.2,3.2,3.4,3.2,3,3,3.2,3.4,3.4,3.2,3,3,3.2&#10;&#10;Virgül, noktalı virgül veya yeni satırla ayırın.&#10;Değerler adım kümesindeki sayılardan oluşmalı."></textarea>
    <div class="panel-hint">Kümülatif olmayan, ham saat başı değerleri girin.</div>
  </div>
</div>

<!-- CONTROLS -->
<div class="ctrl-row">
  <div class="ctrl">
    <label>Tahmin Adımı (n)</label>
    <span class="v" id="vN">12</span>
    <input type="range" id="rN" min="1" max="72" value="12" oninput="document.getElementById('vN').textContent=this.value">
  </div>
  <div class="ctrl">
    <label>Yöntem</label>
    <select id="method">
      <option value="arima">ARIMA-lite</option>
      <option value="mc" selected>Monte Carlo</option>
      <option value="combined">Birleşik (ARIMA+MC)</option>
    </select>
  </div>
  <div class="ctrl">
    <label>MC Tekrar</label>
    <span class="v" id="vMC">1000</span>
    <input type="range" id="rMC" min="200" max="5000" step="200" value="1000" oninput="document.getElementById('vMC').textContent=this.value">
  </div>
  <div class="ctrl">
    <label>Güven Bandı</label>
    <select id="bandConf">
      <option value="0.8">%80</option>
      <option value="0.9" selected>%90</option>
      <option value="0.95">%95</option>
    </select>
  </div>
  <div style="flex:1"></div>
  <button class="btn b-green" onclick="runAnalysis()">▶ ANALİZ ET</button>
  <button class="btn b-red" onclick="loadExample()">ÖRNEK</button>
</div>

<!-- STAT BAR -->
<div class="stat-bar" id="statBar">
  <div class="si"><div class="si-lbl">Veri Uzunluğu</div><div class="si-val" id="stLen">—</div></div>
  <div class="si"><div class="si-lbl">Adım Kümesi</div><div class="si-val" id="stSet">—</div></div>
  <div class="si"><div class="si-lbl">Geçersiz Nokta</div><div class="si-val" id="stBad">—</div></div>
  <div class="si"><div class="si-lbl">Seri Ort.</div><div class="si-val" id="stMean">—</div></div>
  <div class="si"><div class="si-lbl">Seri Std</div><div class="si-val" id="stStd">—</div></div>
  <div class="si"><div class="si-lbl">ACF Lag-1</div><div class="si-val" id="stAcf">—</div></div>
  <div class="si"><div class="si-lbl">Trend</div><div class="si-val" id="stTrend">—</div></div>
</div>

<!-- CHART -->
<div class="chart-card" id="chartCard">
  <div class="chart-top">
    <div class="chart-title-txt">VERİ + TAHMİN</div>
    <div class="chart-btns">
      <button class="cc-btn" onclick="zoomIn()" title="Yakınlaştır">＋</button>
      <button class="cc-btn" onclick="zoomOut()" title="Uzaklaştır">－</button>
      <button class="cc-btn" onclick="resetZoom()" title="Sıfırla">⊙</button>
      <button class="cc-btn" id="fsBtn" onclick="toggleFS()" title="Tam Ekran">⛶</button>
    </div>
  </div>
  <div class="legend">
    <div class="leg"><div class="leg-line" style="background:var(--blue)"></div>Gözlem</div>
    <div class="leg"><div class="leg-line" style="background:var(--green);border-top:2px dashed var(--green);height:0"></div>Tahmin (median)</div>
    <div class="leg"><div class="leg-line" style="background:var(--band);height:10px;width:22px;border:1px solid rgba(31,122,69,.3)"></div>Güven bandı</div>
    <div class="leg"><div class="leg-line" style="background:var(--red);border-top:2px dotted var(--red);height:0"></div>Geçersiz nokta</div>
    <span style="font-size:9px;color:var(--ink3);margin-left:auto;">scroll / pinch zoom · sürükle pan</span>
  </div>
  <div class="chart-wrap" id="chartWrap">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<!-- PROGRESS -->
<div class="prog-wrap" id="progWrap">
  <div class="prog-lbl" id="progLbl">Hesaplanıyor…</div>
  <div class="prog-outer"><div class="prog-inner" id="progBar" style="width:0%"></div></div>
  <div class="prog-txt" id="progTxt">0%</div>
</div>

<!-- RESULTS -->
<div id="resultsArea" style="display:none">
  <div class="results-grid">
    <div class="rc">
      <div class="rc-title">ANALİZ BULGULARI</div>
      <div id="findings"></div>
    </div>
    <div class="rc">
      <div class="rc-title">TAHMİN ÖZETİ</div>
      <div id="predSummary"></div>
    </div>
  </div>
  <div class="rc" style="margin-bottom:18px;">
    <div class="rc-title">ADIM ADIM TAHMİN TABLOSU</div>
    <div id="predTable" style="overflow-x:auto;"></div>
  </div>
  <div class="info-box" id="infoBox"></div>
</div>

</div><!-- .wrap -->

<script>
// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
let allowedSet = [];
let seriesData = [];
let mainChart  = null;

// ═══════════════════════════════════════════
// TAG SYSTEM
// ═══════════════════════════════════════════
const tagInput = document.getElementById('tagInput');
tagInput.addEventListener('keydown', e => {
  if(e.key === 'Enter' || e.key === ',') { e.preventDefault(); addTagFromInput(); }
  if(e.key === 'Backspace' && tagInput.value === '') removeLastTag();
});

function addTagFromInput() {
  const raw = tagInput.value.trim().replace(',','.');
  const v = parseFloat(raw);
  if(isNaN(v)) { tagInput.value=''; return; }
  if(allowedSet.includes(v)) { tagInput.value=''; return; }
  allowedSet.push(v);
  allowedSet.sort((a,b)=>a-b);
  renderTags();
  tagInput.value='';
}

function removeTag(v) {
  allowedSet = allowedSet.filter(x=>x!==v);
  renderTags();
}

function removeLastTag() {
  if(!allowedSet.length) return;
  allowedSet.pop();
  renderTags();
}

function clearTags() { allowedSet=[]; renderTags(); }

function renderTags() {
  const wrap = document.getElementById('tagWrap');
  // remove existing tags
  [...wrap.querySelectorAll('.tag')].forEach(t=>t.remove());
  // insert before input
  allowedSet.forEach(v => {
    const t = document.createElement('span');
    t.className='tag';
    t.innerHTML=`${v}<button class="tag-del" onclick="removeTag(${v})">×</button>`;
    wrap.insertBefore(t, tagInput);
  });
  document.getElementById('stSet').textContent = allowedSet.length ? allowedSet.join(', ') : '—';
}

// ═══════════════════════════════════════════
// PARSE SERIES
// ═══════════════════════════════════════════
function parseSeries() {
  const raw = document.getElementById('seriesInput').value;
  return raw.split(/[\n,;]+/)
    .map(v=>v.trim().replace(',','.'))
    .map(v=>parseFloat(v))
    .filter(v=>!isNaN(v));
}

// ═══════════════════════════════════════════
// STATS
// ═══════════════════════════════════════════
function mean(a){ return a.reduce((s,v)=>s+v,0)/a.length; }
function std(a){
  const m=mean(a);
  return Math.sqrt(a.reduce((s,v)=>s+(v-m)**2,0)/a.length);
}
function acf1(a){
  const m=mean(a), n=a.length;
  const num = a.slice(1).reduce((s,v,i)=>(s+(v-m)*(a[i]-m)),0);
  const den = a.reduce((s,v)=>s+(v-m)**2,0);
  return num/den;
}
function pct(a,p){
  const s=[...a].sort((x,y)=>x-y);
  return s[Math.floor(p*(s.length-1))];
}
function linTrend(a){
  const n=a.length, xs=Array.from({length:n},(_,i)=>i);
  const mx=mean(xs),my=mean(a);
  const num=xs.reduce((s,x,i)=>s+(x-mx)*(a[i]-my),0);
  const den=xs.reduce((s,x)=>s+(x-mx)**2,0);
  return num/den; // slope per step
}

// ═══════════════════════════════════════════
// SNAP TO SET
// ═══════════════════════════════════════════
function snapToSet(v, set){
  if(!set.length) return v;
  return set.reduce((best,x)=>Math.abs(x-v)<Math.abs(best-v)?x:best, set[0]);
}

// ═══════════════════════════════════════════
// AR MODEL (simple AR(p))
// ═══════════════════════════════════════════
function fitAR(data, p=3){
  const n=data.length;
  if(n<=p) return Array(p).fill(0);
  // Yule-Walker (simplified)
  const m=mean(data);
  const c=Array.from({length:p+1},(_,k)=>{
    let s=0; for(let i=k;i<n;i++) s+=(data[i]-m)*(data[i-k]-m);
    return s/(n-k);
  });
  // solve c[0..p-1] * phi = c[1..p] via Levinson-Durbin
  let phi=[c[1]/c[0]];
  let V=c[0]*(1-phi[0]**2);
  for(let lag=2;lag<=p;lag++){
    const num=c[lag]-phi.reduce((s,ph,j)=>s+ph*c[lag-1-j],0);
    const kk=num/V;
    const phi2=[...phi.map((ph,j)=>ph-kk*phi[lag-2-j])];
    phi2.push(kk);
    phi=phi2;
    V*=(1-kk**2);
    if(isNaN(V)||V<=0) break;
  }
  return phi;
}

function arPredict(data, phi, steps, noise_std, set){
  const p=phi.length;
  const m=mean(data);
  let history=[...data].map(v=>v-m);
  const path=[];
  for(let s=0;s<steps;s++){
    let pred=phi.reduce((sum,ph,j)=>sum+ph*history[history.length-1-j],0);
    pred+=m;
    pred+=noise_std*gaussRand();
    if(set.length) pred=snapToSet(pred,set);
    path.push(pred);
    history.push(pred-m);
  }
  return path;
}

function gaussRand(){
  let u=0,v=0;
  while(!u) u=Math.random();
  while(!v) v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}

// ═══════════════════════════════════════════
// MAIN ANALYSIS
// ═══════════════════════════════════════════
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function setP(pct,lbl,txt){
  document.getElementById('progBar').style.width=pct+'%';
  document.getElementById('progTxt').textContent=txt||Math.round(pct)+'%';
  if(lbl) document.getElementById('progLbl').textContent=lbl;
}

async function runAnalysis(){
  seriesData = parseSeries();
  if(seriesData.length<8){ alert('En az 8 nokta gerekli'); return; }

  const nPred  = +document.getElementById('rN').value;
  const method = document.getElementById('method').value;
  const mcRep  = +document.getElementById('rMC').value;
  const conf   = +document.getElementById('bandConf').value;
  const alpha  = (1-conf)/2;

  // Validate against set
  const bad = allowedSet.length
    ? seriesData.filter(v=>!allowedSet.includes(v)).length
    : 0;

  // Stats
  const m   = mean(seriesData);
  const s   = std(seriesData);
  const a1  = acf1(seriesData);
  const trn = linTrend(seriesData);

  document.getElementById('stLen').textContent  = seriesData.length;
  document.getElementById('stSet').textContent  = allowedSet.length ? allowedSet.join(', ') : 'Tanımsız';
  const badEl = document.getElementById('stBad');
  badEl.textContent = bad;
  badEl.className = 'si-val' + (bad>0?' err':'');
  document.getElementById('stMean').textContent = m.toFixed(3);
  document.getElementById('stStd').textContent  = s.toFixed(3);
  document.getElementById('stAcf').textContent  = a1.toFixed(3);
  const trendEl = document.getElementById('stTrend');
  if(Math.abs(trn)<0.0005) { trendEl.textContent='→ Sabit'; trendEl.className='si-val'; }
  else if(trn>0)            { trendEl.textContent='↑ Yükselen'; trendEl.className='si-val ok'; }
  else                      { trendEl.textContent='↓ Düşen'; trendEl.className='si-val err'; }

  // Progress
  document.getElementById('progWrap').style.display='block';
  document.getElementById('resultsArea').style.display='none';
  setP(5,'Analiz başlıyor…');
  await sleep(20);

  // Fit AR model
  const p = Math.min(6, Math.floor(seriesData.length*0.3));
  const phi = fitAR(seriesData, p);
  const noiseStd = s * Math.max(0.05, 1-Math.abs(a1));

  setP(15,'AR modeli hazır, tahmin koşuluyor…');
  await sleep(10);

  // Run predictions
  const simPaths=[];
  const batchSz=100;

  for(let i=0;i<mcRep;i+=batchSz){
    const nb=Math.min(batchSz,mcRep-i);
    for(let b=0;b<nb;b++){
      let path;
      if(method==='arima'){
        path=arPredict(seriesData,phi,nPred,noiseStd*0.3,allowedSet);
      } else if(method==='mc'){
        path=mcPredict(seriesData,nPred,allowedSet);
      } else {
        // combined: average ARIMA + MC
        const pa=arPredict(seriesData,phi,nPred,noiseStd*0.3,allowedSet);
        const pm=mcPredict(seriesData,nPred,allowedSet);
        path=pa.map((v,j)=>snapToSet((v+pm[j])/2, allowedSet.length?allowedSet:[v]));
      }
      simPaths.push(path);
    }
    setP(15+((i+batchSz)/mcRep)*75, `Simülasyon: ${Math.min(i+batchSz,mcRep)}/${mcRep}`);
    await sleep(0);
  }

  setP(92,'Sonuçlar hesaplanıyor…');
  await sleep(10);

  // Compute percentiles
  const predMed=[], predLo=[], predHi=[];
  for(let s2=0;s2<nPred;s2++){
    const vals=simPaths.map(p=>p[s2]);
    predMed.push(pct(vals,0.5));
    predLo.push(pct(vals,alpha));
    predHi.push(pct(vals,1-alpha));
  }

  drawChart(predMed,predLo,predHi,bad);
  showResults(predMed,predLo,predHi,nPred,bad,m,s,a1,trn,method,mcRep,conf);

  setP(100,'Tamamlandı ✔','100%');
  document.getElementById('resultsArea').style.display='block';
}

// ═══════════════════════════════════════════
// MC PREDICT (transition-matrix based)
// ═══════════════════════════════════════════
function mcPredict(data, steps, set){
  if(!set.length){
    // fallback: gaussian walk
    const s2=std(data), m2=mean(data), a2=acf1(data);
    let last=data[data.length-1];
    return Array.from({length:steps},()=>{
      last = last*a2 + m2*(1-Math.abs(a2)) + s2*gaussRand()*(1-Math.abs(a2));
      return last;
    });
  }

  // Build empirical transition matrix from data
  const n=set.length;
  const idx=v=>set.findIndex(x=>Math.abs(x-v)<1e-9);
  const trans=Array.from({length:n},()=>Array(n).fill(0));
  for(let i=1;i<data.length;i++){
    const fi=idx(data[i-1]), ti=idx(data[i]);
    if(fi>=0&&ti>=0) trans[fi][ti]++;
  }
  // Normalize rows (Laplace smoothing)
  for(let r=0;r<n;r++){
    const sum=trans[r].reduce((a,b)=>a+b,0)+(n*0.1);
    trans[r]=trans[r].map(v=>(v+0.1)/sum);
  }

  // Sample path
  let cur=idx(data[data.length-1]);
  if(cur<0) cur=0;
  const path=[];
  for(let s3=0;s3<steps;s3++){
    const row=trans[cur];
    const r=Math.random();
    let cum2=0;
    for(let j=0;j<n;j++){
      cum2+=row[j];
      if(r<=cum2){ cur=j; break; }
    }
    path.push(set[cur]);
  }
  return path;
}

// ═══════════════════════════════════════════
// CHART
// ═══════════════════════════════════════════
function drawChart(predMed, predLo, predHi, badCount){
  if(mainChart) mainChart.destroy();
  const ctx=document.getElementById('mainChart').getContext('2d');

  const obsLen=seriesData.length;
  const totLen=obsLen+predMed.length;
  const labels=Array.from({length:totLen},(_,i)=>i);

  // Mark invalid points
  const invalids=allowedSet.length
    ? seriesData.map((v,i)=>allowedSet.includes(v)?null:{x:i,y:v})
      .filter(Boolean)
    : [];

  // Build series
  const obsSeries=[...seriesData,...Array(predMed.length).fill(null)];

  // Pred — connect from last observation
  const predMedS=[...Array(obsLen-1).fill(null),seriesData[obsLen-1],...predMed];
  const predLoS =[...Array(obsLen-1).fill(null),seriesData[obsLen-1],...predLo];
  const predHiS =[...Array(obsLen-1).fill(null),seriesData[obsLen-1],...predHi];

  const datasets=[
    // Band high
    {label:'Band Hi',data:predHiS,borderColor:'transparent',
     backgroundColor:'rgba(31,122,69,0.10)',pointRadius:0,fill:'+1',tension:0.35},
    // Band low
    {label:'Band Lo',data:predLoS,borderColor:'rgba(31,122,69,0.25)',
     borderWidth:1,borderDash:[3,2],backgroundColor:'rgba(31,122,69,0.10)',
     pointRadius:0,fill:false,tension:0.35},
    // Median prediction
    {label:'Tahmin',data:predMedS,borderColor:'#1f7a45',
     borderWidth:2.5,borderDash:[6,3],pointRadius:0,fill:false,tension:0.35},
    // Observation
    {label:'Gözlem',data:obsSeries,borderColor:'#1a5c8a',
     borderWidth:2,pointRadius:2.5,pointBackgroundColor:'#1a5c8a',
     fill:false,tension:0.2},
  ];

  // Invalid scatter
  if(invalids.length){
    datasets.push({
      label:'Geçersiz',
      data: labels.map((l,i)=>invalids.find(p=>p.x===i)?.y??null),
      borderColor:'transparent',
      backgroundColor:'rgba(184,50,50,0.7)',
      pointRadius:5,pointStyle:'crossRot',
      type:'scatter',fill:false
    });
  }

  mainChart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets},
    options:{
      animation:false,
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          mode:'index',intersect:false,
          callbacks:{
            label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y?.toFixed(3)??''}`
          }
        },
        zoom:{
          pan:{enabled:true,mode:'x'},
          zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'}
        }
      },
      scales:{
        x:{
          grid:{color:'rgba(0,0,0,0.04)'},
          ticks:{color:'#6e6050',font:{family:'Space Mono',size:9},maxTicksLimit:14},
          title:{display:true,text:'Adım (saat)',color:'#6e6050',font:{family:'Space Mono',size:9}}
        },
        y:{
          grid:{color:'rgba(0,0,0,0.04)'},
          ticks:{color:'#6e6050',font:{family:'Space Mono',size:9},maxTicksLimit:8}
        }
      },
      elements:{point:{radius:0}}
    }
  });
}

function zoomIn() { if(mainChart) mainChart.zoom(1.35); }
function zoomOut(){ if(mainChart) mainChart.zoom(0.75); }
function resetZoom(){ if(mainChart) mainChart.resetZoom(); }
function toggleFS(){
  const c=document.getElementById('chartCard');
  const b=document.getElementById('fsBtn');
  const isFs=c.classList.toggle('fullscreen');
  b.textContent=isFs?'✕':'⛶';
  setTimeout(()=>{ if(mainChart) mainChart.resize(); },50);
}
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    const c=document.getElementById('chartCard');
    if(c.classList.contains('fullscreen')){
      c.classList.remove('fullscreen');
      document.getElementById('fsBtn').textContent='⛶';
      setTimeout(()=>{ if(mainChart) mainChart.resize(); },50);
    }
  }
});

// ═══════════════════════════════════════════
// SHOW RESULTS
// ═══════════════════════════════════════════
function showResults(predMed,predLo,predHi,nPred,bad,m,s,a1,trn,method,mcRep,conf){
  const last=seriesData[seriesData.length-1];
  const fMed=predMed[predMed.length-1];
  const fLo =predLo[predLo.length-1];
  const fHi =predHi[predHi.length-1];

  // Frequency count in series
  const freq={};
  seriesData.forEach(v=>{ freq[v]=(freq[v]||0)+1; });
  const mostFreq=Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
  const freqStr=mostFreq ? `${mostFreq[0]} (${((mostFreq[1]/seriesData.length)*100).toFixed(1)}%)` : '—';

  // ACF interpretation
  const acfInterp=Math.abs(a1)>0.5?'Güçlü otokorelasyon':Math.abs(a1)>0.2?'Orta otokorelasyon':'Zayıf / yok';

  document.getElementById('findings').innerHTML=`
    <div class="fr"><span class="fr-l">En sık değer</span><span class="fr-r ok">${freqStr}</span></div>
    <div class="fr"><span class="fr-l">ACF(1)</span><span class="fr-r ${Math.abs(a1)>0.3?'ok':'warn'}">${a1.toFixed(4)} — ${acfInterp}</span></div>
    <div class="fr"><span class="fr-l">Trend eğimi</span><span class="fr-r">${trn.toFixed(5)}/adım</span></div>
    <div class="fr"><span class="fr-l">Geçersiz nokta</span><span class="fr-r ${bad>0?'err':''}">${bad} ${bad>0?'⚠':''}</span></div>
    <div class="fr"><span class="fr-l">Yöntem</span><span class="fr-r">${method.toUpperCase()} · ${mcRep} sim</span></div>
    <div class="fr"><span class="fr-l">Güven bandı</span><span class="fr-r">${(conf*100).toFixed(0)}%</span></div>
  `;

  document.getElementById('predSummary').innerHTML=`
    <div class="fr"><span class="fr-l">Son gözlem</span><span class="fr-r">${last}</span></div>
    <div class="fr"><span class="fr-l">t+${nPred} median</span><span class="fr-r ok">${fMed.toFixed ? fMed.toFixed(4) : fMed}</span></div>
    <div class="fr"><span class="fr-l">t+${nPred} alt band</span><span class="fr-r warn">${fLo.toFixed?fLo.toFixed(4):fLo}</span></div>
    <div class="fr"><span class="fr-l">t+${nPred} üst band</span><span class="fr-r warn">${fHi.toFixed?fHi.toFixed(4):fHi}</span></div>
    <div class="fr"><span class="fr-l">Yön</span>
      <span class="fr-r ${fMed>last?'ok':fMed<last?'err':''}">${fMed>last?'↑ Yükselen':fMed<last?'↓ Düşen':'→ Sabit'}</span>
    </div>
    <div class="fr"><span class="fr-l">Belirsizlik ±</span><span class="fr-r">${((fHi-fLo)/2).toFixed(4)}</span></div>
  `;

  // Table
  let rows='';
  for(let i=0;i<nPred;i++){
    const med=predMed[i], lo=predLo[i], hi=predHi[i];
    const dir=med>last?'↑':med<last?'↓':'→';
    const spread=hi-lo;
    const conf2=Math.max(15,Math.min(95,Math.round((1-(spread/(s*2||0.01)))*100)));
    const clr=med>last?'#1f7a45':med<last?'#b83232':'#1a5c8a';
    rows+=`<tr>
      <td>t+${i+1}</td>
      <td>${med.toFixed?med.toFixed(4):med}</td>
      <td>[${lo.toFixed?lo.toFixed(4):lo}, ${hi.toFixed?hi.toFixed(4):hi}]</td>
      <td style="color:${clr};font-weight:700">${dir}</td>
      <td class="pb"><div class="pbar"><div class="pbar-fill" style="width:${conf2}%;background:${clr}"></div></div></td>
      <td>${conf2}%</td>
    </tr>`;
  }
  document.getElementById('predTable').innerHTML=`
    <table class="pred-table">
      <thead><tr><th>Adım</th><th>Median</th><th>${(+document.getElementById('bandConf').value*100).toFixed(0)}% Aralık</th><th>Yön</th><th colspan="2">Güven</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;

  // Info
  const bestMethod=Math.abs(a1)>0.4?'ARIMA-lite (güçlü otokorelasyon)':allowedSet.length?'Monte Carlo geçiş matrisi':'Birleşik (ARIMA+MC)';
  document.getElementById('infoBox').innerHTML=`
    <strong>Yöntem Notu:</strong> Seri <strong>${seriesData.length}</strong> nokta içeriyor.
    ${allowedSet.length?`İzin verilen <strong>${allowedSet.length}</strong> değer var — Monte Carlo tahminleri geçiş matrisi kullanır.`:'Adım kümesi tanımlanmamış — sürekli değer tahmini yapılıyor.'}
    ACF(1) = <strong>${a1.toFixed(3)}</strong> → önerilen yöntem: <strong>${bestMethod}</strong>.
    ${bad>0?`<span style="color:var(--red)">⚠ ${bad} nokta adım kümesi dışında.</span>`:''}
  `;
}

// ═══════════════════════════════════════════
// EXAMPLE
// ═══════════════════════════════════════════
function loadExample(){
  clearTags();
  [3, 3.2, 3.4, 3.6].forEach(v=>{ allowedSet.push(v); });
  renderTags();
  document.getElementById('seriesInput').value=
    '3,3,3.2,3.2,3.4,3.4,3.4,3.2,3.2,3,3,3,3.2,3.4,3.6,3.6,3.4,3.4,3.2,3.2,3,3,3.2,3.2,3.4,3.4,3.6,3.6,3.4,3.2,3,3,3.2,3.4,3.4,3.2,3.2,3,3,3.2';
  document.getElementById('rN').value=12;
  document.getElementById('vN').textContent='12';
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
renderTags();
</script>
</body>
</html>
