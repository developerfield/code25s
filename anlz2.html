<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sensör Gap Analizi + MC-LSTM Tahmin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&display=swap');

:root {
  --bg: #f5f0e8;
  --paper: #faf7f0;
  --ink: #1a1410;
  --ink2: #3d3530;
  --ink3: #6b5f55;
  --rule: #d4c8b8;
  --sensor: #c0392b;
  --manual: #2471a3;
  --gap: #d4ac0d;
  --pred: #1e8449;
  --warn: #e67e22;
  --accent-light: rgba(192,57,43,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Space Mono', monospace;
  min-height: 100vh;
}

/* Ruled paper texture */
body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image: repeating-linear-gradient(
    transparent, transparent 27px,
    rgba(180,160,140,0.25) 27px, rgba(180,160,140,0.25) 28px
  );
  pointer-events:none;
  z-index:0;
}

.container {
  position:relative;
  z-index:1;
  max-width:1320px;
  margin:0 auto;
  padding:32px 24px;
}

header {
  margin-bottom:40px;
  border-bottom: 3px solid var(--ink);
  padding-bottom:20px;
}

.header-eyebrow {
  font-size:10px;
  letter-spacing:4px;
  color:var(--ink3);
  text-transform:uppercase;
  margin-bottom:6px;
}

h1 {
  font-family:'Bebas Neue', sans-serif;
  font-size:clamp(36px,6vw,72px);
  letter-spacing:3px;
  color:var(--ink);
  line-height:0.95;
}

h1 .red { color: var(--sensor); }
h1 .blue { color: var(--manual); }

.tagline {
  margin-top:10px;
  font-size:11px;
  color:var(--ink3);
  line-height:1.8;
  max-width:600px;
}

/* Data Entry Zone */
.entry-zone {
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:20px;
  margin-bottom:28px;
}

@media(max-width:900px){.entry-zone{grid-template-columns:1fr;}}

.entry-panel {
  background:var(--paper);
  border:2px solid var(--ink);
  padding:20px;
  position:relative;
}

.entry-panel::before {
  content:attr(data-label);
  position:absolute;
  top:-12px; left:12px;
  background:var(--paper);
  padding:0 8px;
  font-size:10px;
  letter-spacing:3px;
  text-transform:uppercase;
  font-weight:700;
  border:2px solid var(--ink);
}

.entry-panel.sensor-panel::before { color:var(--sensor); border-color:var(--sensor); background:var(--paper); }
.entry-panel.manual-panel::before { color:var(--manual); border-color:var(--manual); }
.entry-panel.gap-panel::before { color:var(--gap); border-color:var(--gap); }

textarea {
  width:100%;
  height:130px;
  background:transparent;
  border:1px solid var(--rule);
  border-radius:0;
  color:var(--ink);
  font-family:'Space Mono',monospace;
  font-size:12px;
  padding:10px;
  resize:vertical;
  outline:none;
  line-height:1.7;
}
textarea:focus { border-color:var(--ink); }

.entry-hint {
  font-size:10px;
  color:var(--ink3);
  margin-top:6px;
  line-height:1.7;
}

.entry-hint b { color:var(--sensor); }
.entry-panel.manual-panel .entry-hint b { color:var(--manual); }
.entry-panel.gap-panel .entry-hint b { color:var(--ink3); }

/* Manual row inputs */
.man-row {
  display:flex;
  gap:6px;
  align-items:center;
  animation: rowIn 0.15s ease;
}
@keyframes rowIn {
  from { opacity:0; transform:translateY(-4px); }
  to   { opacity:1; transform:translateY(0); }
}
.man-row-num {
  font-size:9px;
  color:var(--ink3);
  width:18px;
  text-align:right;
  flex-shrink:0;
  letter-spacing:1px;
}
.man-inp {
  flex:1;
  background:transparent;
  border:1px solid var(--rule);
  color:var(--ink);
  font-family:'Space Mono',monospace;
  font-size:12px;
  padding:5px 8px;
  outline:none;
  min-width:0;
  height:30px;
}
.man-inp:focus { border-color:var(--manual); }
.man-inp.x-inp { border-color:rgba(36,113,163,0.4); }
.man-inp-label {
  font-size:9px;
  color:var(--ink3);
  letter-spacing:1px;
  flex-shrink:0;
  width:12px;
  text-align:center;
}
.man-del {
  background:transparent;
  border:1px solid var(--rule);
  color:var(--ink3);
  font-family:'Space Mono',monospace;
  font-size:11px;
  width:24px;
  height:24px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  padding:0;
  transition:all 0.1s;
}
.man-del:hover { border-color:var(--sensor); color:var(--sensor); }

/* scrollbar for rows */
#manualRows::-webkit-scrollbar { width:4px; }
#manualRows::-webkit-scrollbar-track { background:transparent; }
#manualRows::-webkit-scrollbar-thumb { background:var(--rule); }

/* Controls Row */
.controls-row {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:28px;
  padding:16px 20px;
  background:var(--paper);
  border:2px solid var(--ink);
}

.ctrl {
  display:flex;
  flex-direction:column;
  gap:4px;
}

.ctrl label {
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--ink3);
}

.ctrl input[type=range] {
  -webkit-appearance:none;
  width:120px;
  height:3px;
  background:var(--rule);
  outline:none;
  cursor:pointer;
}

.ctrl input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none;
  width:13px; height:13px;
  background:var(--ink);
  border-radius:50%;
  cursor:pointer;
}

.ctrl .val {
  font-size:13px;
  font-weight:700;
  color:var(--ink);
}

.btn {
  padding:10px 22px;
  background:var(--ink);
  color:var(--bg);
  border:2px solid var(--ink);
  font-family:'Space Mono',monospace;
  font-size:11px;
  letter-spacing:2px;
  text-transform:uppercase;
  cursor:pointer;
  transition:all 0.15s;
}
.btn:hover { background:transparent; color:var(--ink); }
.btn.red { background:var(--sensor); border-color:var(--sensor); }
.btn.red:hover { background:transparent; color:var(--sensor); }
.btn.blue { background:var(--manual); border-color:var(--manual); }
.btn.blue:hover { background:transparent; color:var(--manual); }
.btn.green { background:var(--pred); border-color:var(--pred); }
.btn.green:hover { background:transparent; color:var(--pred); }
.btn:disabled { opacity:0.4; cursor:not-allowed; }

/* Status Bar */
.status-bar {
  display:flex;
  gap:0;
  margin-bottom:28px;
  border:2px solid var(--ink);
  overflow:hidden;
}

.status-item {
  flex:1;
  padding:12px 16px;
  border-right:1px solid var(--rule);
  background:var(--paper);
}
.status-item:last-child { border-right:none; }

.si-label {
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--ink3);
  margin-bottom:4px;
}

.si-val {
  font-size:18px;
  font-weight:700;
  color:var(--ink);
}

.si-val.ok { color:var(--pred); }
.si-val.warn { color:var(--warn); }
.si-val.err { color:var(--sensor); }

/* Main Chart */
.chart-big {
  background:var(--paper);
  border:2px solid var(--ink);
  padding:20px;
  margin-bottom:20px;
  position:relative;
}

.chart-title {
  font-family:'Bebas Neue',sans-serif;
  font-size:22px;
  letter-spacing:2px;
  margin-bottom:4px;
}

.chart-legend {
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  margin-bottom:12px;
  font-size:10px;
  letter-spacing:1px;
}

.leg-item {
  display:flex;
  align-items:center;
  gap:6px;
}

.leg-dot {
  width:20px;
  height:3px;
  border-radius:2px;
}

/* Progress bar */
.progress-wrap {
  display:none;
  margin-bottom:20px;
  background:var(--paper);
  border:2px solid var(--ink);
  padding:16px 20px;
}

.progress-label {
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  margin-bottom:8px;
  color:var(--ink3);
}

.progress-bar-outer {
  width:100%;
  height:6px;
  background:var(--rule);
}

.progress-bar-inner {
  height:100%;
  background:var(--pred);
  transition:width 0.1s;
}

.progress-text {
  font-size:13px;
  font-weight:700;
  margin-top:6px;
}

/* Results Grid */
.results-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-bottom:20px;
}
@media(max-width:800px){.results-grid{grid-template-columns:1fr;}}

.result-card {
  background:var(--paper);
  border:2px solid var(--ink);
  padding:20px;
}

.rc-title {
  font-family:'Bebas Neue',sans-serif;
  font-size:18px;
  letter-spacing:2px;
  margin-bottom:12px;
  border-bottom:1px solid var(--rule);
  padding-bottom:8px;
}

.finding-row {
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  padding:6px 0;
  border-bottom:1px dotted var(--rule);
  font-size:11px;
}

.finding-row:last-child { border-bottom:none; }
.fr-label { color:var(--ink3); }
.fr-val { font-weight:700; }
.fr-val.ok { color:var(--pred); }
.fr-val.warn { color:var(--warn); }
.fr-val.err { color:var(--sensor); }

/* Gap feasibility indicator */
.feasibility-box {
  padding:14px;
  border:2px solid;
  margin-bottom:16px;
  font-size:11px;
  line-height:1.8;
}
.feasibility-box.ok { border-color:var(--pred); background:rgba(30,132,73,0.06); }
.feasibility-box.warn { border-color:var(--warn); background:rgba(230,126,34,0.06); }
.feasibility-box.err { border-color:var(--sensor); background:rgba(192,57,43,0.06); }

/* Probability table */
.prob-table {
  width:100%;
  border-collapse:collapse;
  font-size:11px;
  margin-top:8px;
}

.prob-table th {
  text-align:left;
  padding:5px 8px;
  border-bottom:2px solid var(--ink);
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--ink3);
}

.prob-table td {
  padding:5px 8px;
  border-bottom:1px dotted var(--rule);
}

.prob-bar-cell { width:100px; }

.prob-bar {
  height:8px;
  background:var(--rule);
  border-radius:2px;
  overflow:hidden;
}

.prob-fill {
  height:100%;
  border-radius:2px;
  background:var(--manual);
  transition:width 0.5s;
}

/* Explanation box */
.explanation {
  background:var(--paper);
  border-left:4px solid var(--ink);
  padding:16px 20px;
  margin-bottom:20px;
  font-size:11px;
  line-height:1.9;
  color:var(--ink2);
}

.explanation strong { color:var(--ink); }
</style>
</head>
<body>
<div class="container">

<header>
  <div class="header-eyebrow">// Sensör · Gap İmputation · MC-Dropout Tahmin</div>
  <h1><span class="red">SENSOR</span><br><span class="blue">GAP</span> ANALİZİ</h1>
  <p class="tagline">
    Sensör verisi, elle ölçüm ve aradaki boşluğu birleştir.<br>
    Olası yolları simüle et · MC-Dropout LSTM ile tahmin üret.
  </p>
</header>

<!-- Entry Zone -->
<div class="entry-zone">
  <div class="entry-panel sensor-panel" data-label="sensör verisi (kümülatif Y)">
    <textarea id="sensorData" placeholder="0, -2.5, -5, -8.1, -11, -14.2, -18, -22, -26, -29.5, -31&#10;&#10;Virgülle veya yeni satırla ayırın.&#10;İlk değer başlangıç noktanız olur."></textarea>
    <div class="entry-hint"><b>Kırmızı</b> olarak gösterilecek. Sensörün topladığı kümülatif veriler.</div>
  </div>
  <div class="entry-panel gap-panel" data-label="boşluk (gap) bilgisi">
    <div style="display:flex;flex-direction:column;gap:12px;padding-top:8px;">
      <div class="ctrl" style="flex-direction:row;align-items:center;gap:12px;">
        <div>
          <label style="display:block;">Gap Uzunluğu (x adım)</label>
          <span class="val" id="gapLenVal">15</span>
        </div>
        <input type="range" id="gapLen" min="1" max="60" value="15"
          oninput="document.getElementById('gapLenVal').textContent=this.value; updateFeasibility()">
      </div>
      <div class="ctrl" style="flex-direction:row;align-items:center;gap:12px;">
        <div>
          <label style="display:block;">Simülasyon Sayısı</label>
          <span class="val" id="simCountVal">5000</span>
        </div>
        <input type="range" id="simCount" min="500" max="20000" step="500" value="5000"
          oninput="document.getElementById('simCountVal').textContent=this.value">
      </div>
      <div id="feasibilityMini" class="feasibility-box ok" style="margin-bottom:0;">
        Gap uygunluğu hesaplanıyor…
      </div>
    </div>
    <div class="entry-hint">Sensör bozulmasından elle ölçüme geçişe kadar kaç x adımı geçti?</div>
  </div>
  <div class="entry-panel manual-panel" data-label="elle ölçüm (x → y)">
    <div id="manualRows" style="display:flex;flex-direction:column;gap:6px;max-height:160px;overflow-y:auto;padding-right:4px;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn blue" style="padding:7px 14px;font-size:10px;" onclick="addManualRow()">+ SATIR EKLE</button>
      <button class="btn" style="padding:7px 14px;font-size:10px;background:transparent;color:var(--ink3);border-color:var(--rule);" onclick="clearManualRows()">TEMİZLE</button>
      <span id="manRowCount" style="font-size:10px;color:var(--ink3);margin-left:auto;">0 nokta</span>
    </div>
    <div class="entry-hint" style="margin-top:8px;"><b>Mavi</b> olarak gösterilecek. X ve karşılık gelen kümülatif Y değerini girin.</div>
  </div>
</div>

<!-- Controls -->
<div class="controls-row">
  <div class="ctrl">
    <label>δ Max Sınır</label>
    <span class="val" id="deltaMaxVal">2.0</span>
    <input type="range" id="deltaMax" min="0.5" max="4" step="0.1" value="2"
      oninput="document.getElementById('deltaMaxVal').textContent=parseFloat(this.value).toFixed(1); updateFeasibility()">
  </div>
  <div class="ctrl">
    <label>MC-LSTM Tekrar</label>
    <span class="val" id="mcRepVal">200</span>
    <input type="range" id="mcRep" min="50" max="500" step="50" value="200"
      oninput="document.getElementById('mcRepVal').textContent=this.value">
  </div>
  <div class="ctrl">
    <label>Tahmin Adımı</label>
    <span class="val" id="predStepVal">7</span>
    <input type="range" id="predStep" min="1" max="30" value="7"
      oninput="document.getElementById('predStepVal').textContent=this.value">
  </div>
  <div style="flex:1"></div>
  <button class="btn" onclick="runGapSim()">▶ GAP SİMÜLE ET</button>
  <button class="btn green" id="lstmBtn" onclick="runMCLSTM()" disabled>▶ MC-LSTM TAHMİN</button>
  <button class="btn red" onclick="loadExample()">ÖRNEK VERİ YÜKLE</button>
</div>

<!-- Status Bar -->
<div class="status-bar">
  <div class="status-item">
    <div class="si-label">Sensör Noktası</div>
    <div class="si-val" id="stSensor">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Gap Uzunluğu</div>
    <div class="si-val" id="stGap">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Elle Ölçüm</div>
    <div class="si-val" id="stManual">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Max Fiziksel Δ</div>
    <div class="si-val" id="stFeasDelta">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Gap Durumu</div>
    <div class="si-val" id="stFeas">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Geçerli Yol</div>
    <div class="si-val" id="stPaths">—</div>
  </div>
</div>

<!-- Main Chart -->
<div class="chart-big">
  <div class="chart-title">TAM VERİ HARİTASI</div>
  <div class="chart-legend">
    <div class="leg-item"><div class="leg-dot" style="background:var(--sensor)"></div> Sensör Verisi</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--gap); height:2px; border-top:2px dashed var(--gap)"></div> Gap (Simüle)</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--manual)"></div> Elle Ölçüm</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--pred); border-top:2px dashed"></div> MC-LSTM Tahmin</div>
    <div class="leg-item"><div class="leg-dot" style="background:rgba(30,132,73,0.2); height:8px"></div> %80 Güven Bandı</div>
  </div>
  <canvas id="mainChart" style="max-height:320px;"></canvas>
</div>

<!-- Progress -->
<div class="progress-wrap" id="progressWrap">
  <div class="progress-label" id="progressLabel">İşleniyor…</div>
  <div class="progress-bar-outer"><div class="progress-bar-inner" id="progressBar" style="width:0%"></div></div>
  <div class="progress-text" id="progressText">0%</div>
</div>

<!-- Results -->
<div class="results-grid" id="resultsGrid" style="display:none">
  <div class="result-card">
    <div class="rc-title">GAP ANALİZİ</div>
    <div id="gapResults"></div>
  </div>
  <div class="result-card">
    <div class="rc-title">MC-LSTM TAHMİN SONUÇLARI</div>
    <div id="lstmResults"><div style="color:var(--ink3);font-size:11px;">MC-LSTM henüz çalıştırılmadı.</div></div>
  </div>
</div>

<div class="result-card" id="probCard" style="display:none; margin-bottom:20px;">
  <div class="rc-title">OLASILIK TABLOSU — TAHMİN ADIMI BAŞINA</div>
  <div id="probTable"></div>
</div>

<div class="explanation" id="explanationBox" style="display:none">
  <strong>Yöntem Notu:</strong> Gap simülasyonu δ ∈ [-dMax, +dMax] kısıtlı Constrained Random Walk kullanır.
  Başlangıç ve bitiş noktaları sabit tutularak <strong id="expSimCount">5000</strong> yol üretilir,
  fiziksel olarak imkânsız olanlar (ulaşılamaz noktalar) elenir. Gösterilen bant geçerli yolların
  %10–%90 aralığıdır.<br><br>
  <strong>MC-Dropout LSTM:</strong> TensorFlow.js ile eğitilen küçük bir LSTM ağı, test zamanında dropout
  <em>açık</em> bırakılarak <strong id="expMCRep">200</strong> kez forward pass yapılır. Her pass farklı bir
  ağırlık maskesi demektir — bu yaklaşık Bayesian çıkarım verir. Median tahmin + %10/%90 bantları raporlanır.
</div>

</div>

<script>
// ======= STATE =======
let sensorY=[], manualY=[], gapPaths=[], lstmPredictions=[];
let mainChart = null;

// ======= UTILS =======
function parseInput(id) {
  return document.getElementById(id).value
    .split(/[\n,;]+/).map(v=>parseFloat(v.trim())).filter(v=>!isNaN(v));
}
function pct(arr, p) {
  const s=[...arr].sort((a,b)=>a-b);
  const i=Math.floor(p*(s.length-1));
  return s[i];
}
function linspace(a,b,n){return Array.from({length:n},(_,i)=>a+(b-a)*i/(n-1));}
function setProgress(pct,label='',text=''){
  document.getElementById('progressBar').style.width=pct+'%';
  document.getElementById('progressText').textContent=text||Math.round(pct)+'%';
  if(label) document.getElementById('progressLabel').textContent=label;
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// ======= MANUAL ROW SYSTEM =======
let rowCounter = 0;

function addManualRow(xVal='', yVal='') {
  rowCounter++;
  const id = rowCounter;
  const container = document.getElementById('manualRows');
  const rowCount = container.children.length + 1;

  const div = document.createElement('div');
  div.className = 'man-row';
  div.id = 'mrow-' + id;
  div.innerHTML = `
    <span class="man-row-num">${rowCount}</span>
    <span class="man-inp-label" style="color:var(--ink3);font-size:10px;">x</span>
    <input class="man-inp x-inp" type="number" placeholder="234" value="${xVal}"
      onchange="reNumberRows(); updateFeasibility()" step="any">
    <span class="man-inp-label" style="color:var(--manual);font-size:10px;">y</span>
    <input class="man-inp" type="number" placeholder="-15" value="${yVal}"
      onchange="updateFeasibility()" step="any">
    <button class="man-del" onclick="deleteManualRow('mrow-${id}')" title="Sil">×</button>
  `;
  container.appendChild(div);
  reNumberRows();
  updateRowCount();
  // focus the x input of the new row
  div.querySelector('.x-inp').focus();
  container.scrollTop = container.scrollHeight;
}

function deleteManualRow(id) {
  const el = document.getElementById(id);
  if(el) { el.remove(); reNumberRows(); updateFeasibility(); updateRowCount(); }
}

function clearManualRows() {
  document.getElementById('manualRows').innerHTML = '';
  rowCounter = 0;
  updateRowCount();
  updateFeasibility();
}

function reNumberRows() {
  const rows = document.querySelectorAll('#manualRows .man-row');
  rows.forEach((r, i) => {
    const num = r.querySelector('.man-row-num');
    if(num) num.textContent = i + 1;
  });
}

function updateRowCount() {
  const n = document.querySelectorAll('#manualRows .man-row').length;
  document.getElementById('manRowCount').textContent = n + ' nokta';
}

function getManualXY() {
  const rows = document.querySelectorAll('#manualRows .man-row');
  const pts = [];
  rows.forEach(r => {
    const inputs = r.querySelectorAll('input');
    const x = parseFloat(inputs[0].value);
    const y = parseFloat(inputs[1].value);
    if(!isNaN(x) && !isNaN(y)) pts.push({x, y});
  });
  pts.sort((a,b) => a.x - b.x);
  return pts;
}

function getManualY() {
  return getManualXY().map(p => p.y);
}


function updateFeasibility() {
  const sensor = parseInput('sensorData');
  const manual = getManualY();
  const gapLen = +document.getElementById('gapLen').value;
  const dmax = +document.getElementById('deltaMax').value;

  if(!sensor.length || !manual.length) {
    setFeas('—','—','—','Veri yok','warn');
    return;
  }
  const startY = sensor[sensor.length-1];
  const endY = manual[0];
  const diff = Math.abs(endY - startY);
  const maxReach = gapLen * dmax;
  const minStepNeeded = diff / gapLen;
  const feasible = diff <= maxReach;

  document.getElementById('stSensor').textContent = sensor.length + ' pt';
  document.getElementById('stGap').textContent = gapLen + ' adım';
  document.getElementById('stManual').textContent = manual.length + ' pt';
  document.getElementById('stFeasDelta').textContent = minStepNeeded.toFixed(2) + '/adım';

  const box = document.getElementById('feasibilityMini');
  if (feasible) {
    box.className = 'feasibility-box ok';
    box.innerHTML = `✔ Gap fiziksel olarak <strong>mümkün</strong><br>Gereken min δ/adım: ${minStepNeeded.toFixed(3)} ≤ ${dmax}`;
    document.getElementById('stFeas').textContent = '✔ Mümkün';
    document.getElementById('stFeas').className = 'si-val ok';
  } else {
    box.className = 'feasibility-box err';
    box.innerHTML = `✘ Gap <strong>imkânsız</strong> — ${gapLen} adımda ${diff.toFixed(1)} birim fark δMax=${dmax} ile geçilemez!<br>Ya gap uzunluğunu artırın, ya δMax'ı yükseltin.`;
    document.getElementById('stFeas').textContent = '✘ İmkânsız';
    document.getElementById('stFeas').className = 'si-val err';
  }
}

// ======= GAP SIMULATION =======
async function runGapSim() {
  sensorY = parseInput('sensorData');
  manualY = getManualY();
  if(!sensorY.length||!manualY.length){alert('Sensör verisi ve en az 1 elle ölçüm noktası gerekli');return;}

  const gapLen = +document.getElementById('gapLen').value;
  const simCount = +document.getElementById('simCount').value;
  const dmax = +document.getElementById('deltaMax').value;
  const startY = sensorY[sensorY.length-1];
  const endY = manualY[0];
  const diff = endY - startY;

  document.getElementById('progressWrap').style.display='block';
  document.getElementById('resultsGrid').style.display='none';
  setProgress(0,'Gap simülasyonu çalışıyor…');
  await sleep(20);

  gapPaths = [];
  const batchSize = 500;
  let attempts = 0;

  while(gapPaths.length < simCount && attempts < simCount * 20) {
    const batch = Math.min(batchSize, simCount - gapPaths.length);
    for(let i=0;i<batch*4 && gapPaths.length<simCount;i++) {
      attempts++;
      // Constrained random walk: bias toward endpoint
      let y = startY;
      const path = [y];
      let feasible = true;
      for(let step=1;step<=gapLen;step++){
        const remaining = gapLen - step;
        const needed = endY - y;
        const minD = remaining>0 ? Math.max(-dmax, needed - remaining*dmax) : needed;
        const maxD = remaining>0 ? Math.min(dmax, needed + remaining*dmax) : needed;
        if(minD > maxD){ feasible=false; break; }
        const d = minD + Math.random()*(maxD-minD);
        y += d;
        path.push(y);
      }
      if(feasible && Math.abs(path[path.length-1]-endY)<0.01) gapPaths.push(path);
    }
    setProgress(Math.min(95, gapPaths.length/simCount*100), 'Gap simülasyonu…', `${gapPaths.length}/${simCount} geçerli yol`);
    await sleep(0);
  }

  document.getElementById('stPaths').textContent = gapPaths.length + ' geçerli';
  updateFeasibility();
  drawMainChart();
  showGapResults();

  setProgress(100,'Tamamlandı','Hazır');
  document.getElementById('resultsGrid').style.display='grid';
  document.getElementById('explanationBox').style.display='block';
  document.getElementById('expSimCount').textContent = simCount;
  document.getElementById('lstmBtn').disabled = false;
}

// ======= CHART =======
function buildXLabels() {
  const sLen = sensorY.length;
  const gLen = +document.getElementById('gapLen').value;
  const mLen = manualY.length;
  const total = sLen + gLen + mLen - 1;
  return Array.from({length:total},(_,i)=>i);
}

function drawMainChart(predMed=[], predLow=[], predHigh=[]) {
  if(mainChart) mainChart.destroy();
  const ctx = document.getElementById('mainChart').getContext('2d');
  const gapLen = +document.getElementById('gapLen').value;
  const sLen = sensorY.length;
  const mLen = manualY.length;
  const total = sLen + gapLen + mLen - 1;
  const labels = Array.from({length:total+(predMed.length||0)},(_,i)=>i);

  // Sensor series
  const sensorSeries = [...sensorY, ...Array(total-sLen+(predMed.length||0)).fill(null)];

  // Gap percentile paths (10th / 50th / 90th)
  let gapP10=[], gapP50=[], gapP90=[];
  if(gapPaths.length>0){
    for(let t=0;t<=gapLen;t++){
      const vals = gapPaths.map(p=>p[t]);
      gapP10.push(pct(vals,0.1));
      gapP50.push(pct(vals,0.5));
      gapP90.push(pct(vals,0.9));
    }
  }
  const gapOffset = sLen-1;
  const gapP50Series = Array(gapOffset).fill(null).concat(gapP50).concat(Array(mLen-1+(predMed.length||0)).fill(null));
  const gapP10Series = Array(gapOffset).fill(null).concat(gapP10).concat(Array(mLen-1+(predMed.length||0)).fill(null));
  const gapP90Series = Array(gapOffset).fill(null).concat(gapP90).concat(Array(mLen-1+(predMed.length||0)).fill(null));

  // Manual series
  const manOffset = sLen + gapLen - 1;
  const manSeries = Array(manOffset).fill(null).concat(manualY).concat(Array(predMed.length||0).fill(null));

  // Prediction
  const predOffset = sLen + gapLen + mLen - 2;
  const predMedSeries = predMed.length ? Array(predOffset).fill(null).concat([manualY[manualY.length-1],...predMed]) : [];
  const predLowSeries = predLow.length ? Array(predOffset).fill(null).concat([manualY[manualY.length-1],...predLow]) : [];
  const predHighSeries = predHigh.length ? Array(predOffset).fill(null).concat([manualY[manualY.length-1],...predHigh]) : [];

  const datasets = [
    // Gap band
    {label:'Gap %90',data:gapP90Series,borderColor:'transparent',backgroundColor:'rgba(212,172,13,0.12)',pointRadius:0,fill:'+1',tension:0.3},
    {label:'Gap %10',data:gapP10Series,borderColor:'transparent',backgroundColor:'rgba(212,172,13,0.12)',pointRadius:0,fill:false,tension:0.3},
    {label:'Gap Median',data:gapP50Series,borderColor:'rgba(212,172,13,0.8)',borderWidth:2,borderDash:[6,3],pointRadius:0,fill:false,tension:0.3},
    // Sensor
    {label:'Sensör',data:sensorSeries,borderColor:'#c0392b',borderWidth:2.5,pointRadius:3,pointBackgroundColor:'#c0392b',fill:false,tension:0.2},
    // Manual
    {label:'Elle Ölçüm',data:manSeries,borderColor:'#2471a3',borderWidth:2.5,pointRadius:3,pointBackgroundColor:'#2471a3',fill:false,tension:0.2},
  ];

  if(predMed.length){
    datasets.push({label:'Pred %90',data:predHighSeries,borderColor:'transparent',backgroundColor:'rgba(30,132,73,0.12)',pointRadius:0,fill:'+1',tension:0.3});
    datasets.push({label:'Pred %10',data:predLowSeries,borderColor:'transparent',backgroundColor:'rgba(30,132,73,0.12)',pointRadius:0,fill:false,tension:0.3});
    datasets.push({label:'MC Median',data:predMedSeries,borderColor:'#1e8449',borderWidth:2,borderDash:[4,3],pointRadius:0,fill:false,tension:0.3});
  }

  mainChart = new Chart(ctx, {
    type:'line',
    data:{labels, datasets},
    options:{
      animation:false,
      responsive:true,
      maintainAspectRatio:true,
      plugins:{legend:{display:false}},
      scales:{
        x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'#6b5f55',font:{family:'Space Mono',size:9},maxTicksLimit:12}},
        y:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'#6b5f55',font:{family:'Space Mono',size:9},maxTicksLimit:8}}
      },
      elements:{point:{radius:0}}
    }
  });
}

// ======= GAP RESULTS =======
function showGapResults() {
  const gapLen = +document.getElementById('gapLen').value;
  const startY = sensorY[sensorY.length-1];
  const endY = manualY[0];
  const midPaths = gapPaths.map(p=>p[Math.floor(gapLen/2)]);
  const midP10=pct(midPaths,0.1).toFixed(2), midP50=pct(midPaths,0.5).toFixed(2), midP90=pct(midPaths,0.9).toFixed(2);

  document.getElementById('gapResults').innerHTML = `
    <div class="feasibility-box ${gapPaths.length>100?'ok':'warn'}">
      <strong>${gapPaths.length.toLocaleString()}</strong> geçerli yol bulundu
      (${((gapPaths.length/+document.getElementById('simCount').value)*100).toFixed(1)}% kabul oranı)
    </div>
    <div class="finding-row"><span class="fr-label">Başlangıç → Bitiş</span><span class="fr-val">${startY.toFixed(2)} → ${endY.toFixed(2)}</span></div>
    <div class="finding-row"><span class="fr-label">Toplam Δ</span><span class="fr-val">${(endY-startY).toFixed(2)}</span></div>
    <div class="finding-row"><span class="fr-label">Gap ortası %10</span><span class="fr-val">${midP10}</span></div>
    <div class="finding-row"><span class="fr-label">Gap ortası Median</span><span class="fr-val ok">${midP50}</span></div>
    <div class="finding-row"><span class="fr-label">Gap ortası %90</span><span class="fr-val">${midP90}</span></div>
    <div class="finding-row"><span class="fr-label">Bant genişliği (orta)</span><span class="fr-val warn">${(parseFloat(midP90)-parseFloat(midP10)).toFixed(2)}</span></div>
  `;
}

// ======= MC-LSTM =======
async function runMCLSTM() {
  const allY = [...sensorY, ...manualY.slice(1)];
  if(allY.length < 15) { alert('En az 15 birleşik nokta gerekli (sensör + elle)'); return; }

  document.getElementById('progressWrap').style.display='block';
  document.getElementById('lstmBtn').disabled=true;
  const mcRep = +document.getElementById('mcRep').value;
  const predSteps = +document.getElementById('predStep').value;
  document.getElementById('expMCRep').textContent = mcRep;

  // Normalize
  const mn = Math.min(...allY), mx = Math.max(...allY);
  const range = mx - mn || 1;
  const norm = allY.map(v=>(v-mn)/range);

  const seqLen = Math.min(20, Math.floor(allY.length*0.6));

  // Build sequences
  const Xs=[], Ys=[];
  for(let i=0;i<norm.length-seqLen;i++){
    Xs.push(norm.slice(i,i+seqLen));
    Ys.push(norm[i+seqLen]);
  }
  if(Xs.length<5){alert('Yeterli veri yok LSTM için');document.getElementById('lstmBtn').disabled=false;return;}

  setProgress(5,'LSTM modeli oluşturuluyor…');
  await sleep(20);

  // TF model — small LSTM with dropout
  const model = tf.sequential();
  model.add(tf.layers.lstm({units:24, inputShape:[seqLen,1], returnSequences:false, dropout:0.2, recurrentDropout:0.1}));
  model.add(tf.layers.dropout({rate:0.2}));
  model.add(tf.layers.dense({units:16, activation:'relu'}));
  model.add(tf.layers.dropout({rate:0.15}));
  model.add(tf.layers.dense({units:1}));
  model.compile({optimizer:tf.train.adam(0.01), loss:'mse'});

  // Prepare tensors
  const xTensor = tf.tensor3d(Xs.map(s=>s.map(v=>[v])));
  const yTensor = tf.tensor2d(Ys.map(v=>[v]));

  setProgress(10,'Eğitim başlıyor…');
  await model.fit(xTensor, yTensor, {
    epochs:60, batchSize:Math.min(16,Xs.length), shuffle:true,
    callbacks:{
      onEpochEnd: async (ep)=>{
        const p = 10 + (ep/60)*40;
        setProgress(p,`LSTM eğitim — Epoch ${ep+1}/60`);
        await sleep(0);
      }
    }
  });

  xTensor.dispose(); yTensor.dispose();

  setProgress(55,`MC-Dropout: ${mcRep} forward pass çalışıyor…`);
  await sleep(20);

  // MC Dropout inference
  // Use last seqLen points as seed
  const seedNorm = norm.slice(-seqLen);
  lstmPredictions = [];

  const batchMC = 20;
  for(let rep=0; rep<mcRep; rep+=batchMC){
    const thisBatch = Math.min(batchMC, mcRep-rep);
    for(let b=0;b<thisBatch;b++){
      let seq = [...seedNorm];
      const path = [];
      for(let s=0;s<predSteps;s++){
        const inp = tf.tensor3d([seq.slice(-seqLen).map(v=>[v])]);
        const out = model.predict(inp, {training:true}); // training:true = dropout ON
        const val = (await out.data())[0];
        inp.dispose(); out.dispose();
        path.push(val*range+mn);
        seq.push(val);
      }
      lstmPredictions.push(path);
    }
    const p = 55 + ((rep+batchMC)/mcRep)*40;
    setProgress(Math.min(95,p),`MC-Dropout: ${Math.min(rep+batchMC,mcRep)}/${mcRep} pass`);
    await sleep(0);
  }

  model.dispose();

  // Compute percentiles
  const predMed=[], predLow=[], predHigh=[];
  for(let s=0;s<predSteps;s++){
    const vals = lstmPredictions.map(p=>p[s]);
    predMed.push(pct(vals,0.5));
    predLow.push(pct(vals,0.1));
    predHigh.push(pct(vals,0.9));
  }

  drawMainChart(predMed, predLow, predHigh);
  showLSTMResults(predMed, predLow, predHigh, predSteps);

  setProgress(100,'MC-LSTM tamamlandı','✔ Hazır');
  document.getElementById('lstmBtn').disabled=false;
  document.getElementById('probCard').style.display='block';
  showProbTable(predMed, predLow, predHigh, predSteps);
}

function showLSTMResults(med, low, high, steps) {
  const lastActual = manualY[manualY.length-1];
  const finalMed = med[med.length-1];
  const finalLow = low[low.length-1];
  const finalHigh = high[high.length-1];
  const spread = finalHigh - finalLow;

  document.getElementById('lstmResults').innerHTML = `
    <div class="feasibility-box ok">
      <strong>${lstmPredictions.length.toLocaleString()}</strong> MC-Dropout forward pass tamamlandı
    </div>
    <div class="finding-row"><span class="fr-label">Son gözlem</span><span class="fr-val">${lastActual.toFixed(2)}</span></div>
    <div class="finding-row"><span class="fr-label">t+${steps} %10</span><span class="fr-val">${finalLow.toFixed(2)}</span></div>
    <div class="finding-row"><span class="fr-label">t+${steps} Median</span><span class="fr-val ok">${finalMed.toFixed(2)}</span></div>
    <div class="finding-row"><span class="fr-label">t+${steps} %90</span><span class="fr-val">${finalHigh.toFixed(2)}</span></div>
    <div class="finding-row"><span class="fr-label">Belirsizlik bandı</span><span class="fr-val warn">±${(spread/2).toFixed(2)}</span></div>
    <div class="finding-row"><span class="fr-label">Momentum</span>
      <span class="fr-val ${finalMed>lastActual?'ok':'err'}">${finalMed>lastActual?'↑ Yukarı':'↓ Aşağı'}</span>
    </div>
  `;
}

function showProbTable(med, low, high, steps) {
  const lastActual = manualY[manualY.length-1];
  let rows = '';
  for(let s=0;s<steps;s++){
    const dir = med[s]>lastActual?'↑':'↓';
    const conf = Math.round(100 - (high[s]-low[s])/(Math.abs(med[s]-lastActual)||1)*10);
    const clampedConf = Math.max(20,Math.min(95,conf));
    rows += `
      <tr>
        <td>t+${s+1}</td>
        <td>${med[s].toFixed(2)}</td>
        <td>[${low[s].toFixed(2)}, ${high[s].toFixed(2)}]</td>
        <td>${dir}</td>
        <td class="prob-bar-cell">
          <div class="prob-bar"><div class="prob-fill" style="width:${clampedConf}%; background:${med[s]>lastActual?'var(--pred)':'var(--sensor)'}"></div></div>
        </td>
        <td>${clampedConf}%</td>
      </tr>
    `;
  }
  document.getElementById('probTable').innerHTML = `
    <table class="prob-table">
      <thead><tr><th>Adım</th><th>Median</th><th>%80 Aralık</th><th>Yön</th><th colspan="2">Güven</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// ======= EXAMPLE =======
function loadExample() {
  document.getElementById('sensorData').value = '0, -1.8, -3.5, -6.2, -9.1, -11.4, -14.8, -17.2, -19.6, -22.3, -24.1, -26.8, -29.2, -31.5, -28.9, -26.1, -23.4, -20.8, -18.2, -15.6, -13.1, -10.9, -8.4, -6.2, -3.8, -1.4, 1.2, 3.6, 6.1, 8.8';
  clearManualRows();
  const exampleManual = [
    {x:43, y:-4.2},{x:44, y:-6.8},{x:45, y:-9.1},{x:46, y:-11.6},
    {x:47, y:-14.2},{x:48, y:-16.8},{x:49, y:-19.3},{x:50, y:-21.5},
    {x:51, y:-18.9},{x:52, y:-16.2}
  ];
  exampleManual.forEach(p => addManualRow(p.x, p.y));
  document.getElementById('gapLen').value = 12;
  document.getElementById('gapLenVal').textContent = '12';
  updateFeasibility();
}

// ======= INIT =======
updateFeasibility();
// Draw empty chart placeholder
sensorY=[0]; manualY=[0];
drawMainChart();
sensorY=[]; manualY=[];
// Add one empty row to hint the user
addManualRow();
</script>
</body>
</html>
