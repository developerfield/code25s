<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GeliÅŸmiÅŸ Alan GÃ¶rselleÅŸtirici V8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: block; touch-action: none; }

        #hud {
            position: fixed; top: 15px; left: 15px;
            background: rgba(0, 0, 0, 0.85);
            padding: 12px; border-radius: 10px;
            font-family: 'Courier New', monospace; font-size: 13px;
            border: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(8px); pointer-events: none; z-index: 100;
        }
        #hud span { color: #00ffcc; font-weight: bold; }
        #hud .equation-display { color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; font-style: italic; display: block; }

        .ui-panel {
            position: fixed; top: 15px; right: 15px;
            display: flex; flex-direction: column; gap: 10px; z-index: 101;
        }

        .btn {
            background: rgba(40, 40, 40, 0.85); border: 1px solid rgba(255,255,255,0.25);
            color: white; width: 50px; height: 50px; border-radius: 12px;
            cursor: pointer; font-size: 22px; backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn.active { background: #007bff; border-color: #fff; }
        .btn.locked { background: #dc3545; border-color: #fff; }

        #settings {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(15, 15, 15, 0.98); padding: 20px; border-radius: 20px;
            border: 1px solid #333; width: 95%; max-width: 420px;
            display: none; z-index: 1000; box-shadow: 0 20px 50px rgba(0,0,0,1);
            max-height: 90vh; overflow-y: auto;
        }

        .param-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .param-row input[type="number"] { flex: 1; background: #222; border: 1px solid #444; color: #0f0; padding: 8px; border-radius: 5px; }
        .param-row input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
        label { font-size: 12px; color: #aaa; min-width: 90px; }

        input[type="text"] { width: 100%; background: #222; border: 1px solid #444; padding: 10px; color: #fff; border-radius: 8px; margin: 5px 0; font-family: monospace; }
        .apply-btn { width: 100%; background: #28a745; color: white; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 15px; cursor: pointer; }
        
        .origin-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .origin-inputs div { display: flex; flex-direction: column; }
        .origin-inputs label { font-size: 10px; margin-bottom: 2px; }

        select { background: #222; color: #fff; border: 1px solid #444; padding: 5px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>

<div id="hud">
    <span id="modeTxt" style="color:#ffcc00; font-size:10px; display:block; margin-bottom:5px; letter-spacing:1px;">NAVÄ°GASYON</span>
    <span class="equation-display" id="eqDisplay">f(x,y) = sqrt(x^2 + y^2)</span>
    <b>FPS:</b> <span id="fpsDisplay">60</span><br>
    <b>Orijin:</b> (<span id="hx">0.00</span>, <span id="hy">0.00</span>)<br>
    <b>Renk Merkezi:</b> (<span id="cx" style="color:#0f0">0.00</span>, <span id="cy" style="color:#0f0">0.00</span>)
    <div id="targetStats" style="display:none; border-top: 1px solid #444; margin-top: 5px; padding-top: 5px;">
        <b>Ä°mleÃ§ X:</b> <span id="tx">0.00</span> | <b>Y:</b> <span id="ty">0.00</span><br>
        <b>DeÄŸer:</b> <span id="tv">0.00</span>
    </div>
</div>

<div class="ui-panel">
    <button class="btn" onclick="toggleMenu()">âš™</button>
    <button class="btn" onclick="manualZoom(1.4)">+</button>
    <button class="btn" onclick="manualZoom(0.7)">-</button>
    <button class="btn" id="targetBtn" onclick="toggleTargetMode()">ðŸŽ¯</button>
    <button class="btn" id="masterLockBtn" onclick="toggleMasterLock()">ðŸ”’</button>
</div>

<div id="settings">
    <h3 style="margin:0 0 10px 0; border-bottom:1px solid #333; padding-bottom:5px;">Parametreler</h3>
    
    <label>Denklem f(x, y):</label>
    <input type="text" id="eqInput" value="sqrt(x^2 + y^2)">

    <div id="colorParams">
        <div class="param-row"><input type="checkbox" id="en_i3"><label>i3 (Siyah)</label><input type="number" id="i3" value="0"></div>
        <div class="param-row"><input type="checkbox" id="en_i2" checked><label>i2 (K.KÄ±rmÄ±zÄ±)</label><input type="number" id="i2" value="3"></div>
        <div class="param-row"><input type="checkbox" id="en_i1" checked><label>i1 (SarÄ±)</label><input type="number" id="i1" value="7"></div>
        <div class="param-row"><input type="checkbox" id="en_h0" checked><label>h0 (YeÅŸil)</label><input type="number" id="h0" value="11"></div>
        <div class="param-row"><input type="checkbox" id="en_h1" checked><label>h1 (Mavi)</label><input type="number" id="h1" value="15"></div>
        <div class="param-row"><input type="checkbox" id="en_h2" checked><label>h2 (Mor)</label><input type="number" id="h2" value="19"></div>
        <div class="param-row"><input type="checkbox" id="en_h3"><label>h3 (Siyah)</label><input type="number" id="h3" value="23"></div>
    </div>

    <div style="border-top:1px solid #333; margin-top:10px; padding-top:10px;">
        <div class="param-row">
            <input type="checkbox" id="boxEnable">
            <label>Alan Maskesi:</label>
            <select id="maskType">
                <option value="rect">DikdÃ¶rtgen</option>
                <option value="circle">Daire</option>
                <option value="diamond">Elmas</option>
            </select>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
            <input type="number" id="bx1" placeholder="x1 / r" value="-2">
            <input type="number" id="bx2" placeholder="x2" value="2">
            <input type="number" id="by1" placeholder="y1" value="-2">
            <input type="number" id="by2" placeholder="y2" value="2">
        </div>
    </div>

    <div class="origin-inputs">
        <div><label>Renk Orijini X:</label><input type="number" id="origX" value="0" step="0.1"></div>
        <div><label>Renk Orijini Y:</label><input type="number" id="origY" value="0" step="0.1"></div>
    </div>
    
    <button class="apply-btn" onclick="applySettings()">UYGULA</button>
</div>

<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    
    let config = { 
        eq: "sqrt(x^2 + y^2)", 
        colorOrigin: { x: 0, y: 0 },
        params: {
            i3: { val: 0,  en: false, color: [0, 0, 0] },
            i2: { val: 3,  en: true,  color: [130, 0, 0] },
            i1: { val: 7,  en: true,  color: [255, 255, 0] },
            h0: { val: 11, en: true,  color: [0, 255, 0] },
            h1: { val: 15, en: true,  color: [0, 0, 255] },
            h2: { val: 19, en: true,  color: [150, 0, 255] },
            h3: { val: 23, en: false, color: [0, 0, 0] }
        },
        box: { enabled: false, type: 'rect', x1: -2, x2: 2, y1: -2, y2: 2 }
    };
    
    let view = { x: 0, y: 0, zoom: 40, isMoving: false, isTargetMode: false, isMasterLocked: false, target: { x: 0, y: 0 } };
    let compiledEq = math.compile(config.eq);
    let renderTimer, lastFrameTime = performance.now();

    function interpolate(c1, c2, t) {
        return [
            Math.floor(c1[0] + (c2[0] - c1[0]) * t),
            Math.floor(c1[1] + (c2[1] - c1[1]) * t),
            Math.floor(c1[2] + (c2[2] - c1[2]) * t)
        ];
    }

    function getRGB(val) {
        const p = config.params;
        const keys = ['i3', 'i2', 'i1', 'h0', 'h1', 'h2', 'h3'];
        for (let j = 0; j < keys.length - 1; j++) {
            const k1 = keys[j], k2 = keys[j+1];
            if (p[k1].en && p[k2].en) {
                if (val >= p[k1].val && val <= p[k2].val) {
                    const t = (val - p[k1].val) / (p[k2].val - p[k1].val);
                    return interpolate(p[k1].color, p[k2].color, t);
                }
            }
        }
        return [0, 0, 0];
    }

    function render(step = 2) {
        const w = canvas.width, h = canvas.height, z = view.zoom;
        const ox = config.colorOrigin.x;
        const oy = config.colorOrigin.y;

        for (let px = 0; px < w; px += step) {
            for (let py = 0; py < h; py += step) {
                const wx = (px - w / 2) / z + view.x;
                const wy = -(py - h / 2) / z + view.y;
                
                try {
                    // Renk hesabÄ± iÃ§in orijine gÃ¶re x ve y'yi kaydÄ±rÄ±yoruz
                    const val = compiledEq.evaluate({ x: wx - ox, y: wy - oy });
                    const [r, g, b] = getRGB(val);
                    ctx.fillStyle = `rgb(${r},${g},${b})`;
                    ctx.fillRect(px, py, step, step);
                } catch(e) {
                    ctx.fillStyle = "#000";
                    ctx.fillRect(px, py, step, step);
                }
            }
        }
        drawUIOverlay();
        updateHUD();
    }

    function drawUIOverlay() {
        const w = canvas.width, h = canvas.height, z = view.zoom;
        if (config.box.enabled) {
            ctx.strokeStyle = "rgba(255,255,255,0.6)"; ctx.lineWidth = 1.5;
            ctx.setLineDash([5, 5]);
            
            const b = config.box;
            const x1 = (b.x1 - view.x) * z + w / 2;
            const y1 = -(b.y1 - view.y) * z + h / 2;
            const x2 = (b.x2 - view.x) * z + w / 2;
            const y2 = -(b.y2 - view.y) * z + h / 2;

            if (b.type === 'rect') {
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
            } else if (b.type === 'circle') {
                const radius = Math.abs(b.x1) * z; // x1'i yarÄ±Ã§ap olarak kullan
                ctx.beginPath();
                ctx.arc((0-view.x)*z+w/2, (0-view.y)*z+h/2, radius, 0, Math.PI*2);
                ctx.stroke();
            } else if (b.type === 'diamond') {
                const size = Math.abs(b.x1) * z;
                const cx = (0-view.x)*z+w/2, cy = (0-view.y)*z+h/2;
                ctx.beginPath();
                ctx.moveTo(cx, cy - size);
                ctx.lineTo(cx + size, cy);
                ctx.lineTo(cx, cy + size);
                ctx.lineTo(cx - size, cy);
                ctx.closePath();
                ctx.stroke();
            }
            ctx.setLineDash([]);
        }
        if (view.isTargetMode || view.isMasterLocked) {
            const tx = (view.target.x - view.x) * z + w / 2;
            const ty = -(view.target.y - view.y) * z + h / 2;
            ctx.beginPath(); ctx.arc(tx, ty, 8, 0, Math.PI * 2); ctx.fillStyle = "white"; ctx.fill();
            ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.stroke();
        }
    }

    function updateHUD() {
        const now = performance.now();
        document.getElementById('fpsDisplay').innerText = Math.round(1000 / (now - lastFrameTime));
        lastFrameTime = now;
        document.getElementById('hx').innerText = view.x.toFixed(2);
        document.getElementById('hy').innerText = view.y.toFixed(2);
        document.getElementById('cx').innerText = config.colorOrigin.x.toFixed(2);
        document.getElementById('cy').innerText = config.colorOrigin.y.toFixed(2);
        document.getElementById('eqDisplay').innerText = "f(x,y) = " + config.eq;
        if (view.isTargetMode || view.isMasterLocked) {
            try {
                const val = compiledEq.evaluate({ 
                    x: view.target.x - config.colorOrigin.x, 
                    y: view.target.y - config.colorOrigin.y 
                });
                document.getElementById('tx').innerText = view.target.x.toFixed(2);
                document.getElementById('ty').innerText = view.target.y.toFixed(2);
                document.getElementById('tv').innerText = typeof val === 'number' ? val.toFixed(4) : "N/A";
            } catch(e) {}
        }
    }

    function startMoving() {
        if (view.isMasterLocked) return;
        view.isMoving = true; clearTimeout(renderTimer);
        render(12);
        renderTimer = setTimeout(() => { view.isMoving = false; render(2); }, 150);
    }

    function toggleTargetMode() {
        if (view.isMasterLocked) return;
        view.isTargetMode = !view.isTargetMode;
        document.getElementById('targetBtn').classList.toggle('active', view.isTargetMode);
        document.getElementById('targetStats').style.display = view.isTargetMode ? 'block' : 'none';
        document.getElementById('modeTxt').innerText = view.isTargetMode ? "KONUM SEÃ‡ME" : "NAVÄ°GASYON";
        if (view.isTargetMode) { view.target.x = view.x; view.target.y = view.y; }
        render(2);
    }

    function toggleMasterLock() {
        view.isMasterLocked = !view.isMasterLocked;
        const btn = document.getElementById('masterLockBtn');
        btn.classList.toggle('locked', view.isMasterLocked);
        btn.innerText = view.isMasterLocked ? "ðŸ”“" : "ðŸ”’";
        document.getElementById('modeTxt').innerText = view.isMasterLocked ? "TAM KÄ°LÄ°T" : (view.isTargetMode ? "KONUM SEÃ‡ME" : "NAVÄ°GASYON");
        render(2);
    }

    let isDown = false, lastMouse = { x: 0, y: 0 }, initialPinchDist = null;

    function handleInput(ex, ey) {
        if (view.isMasterLocked || !isDown) return;
        const w = canvas.width, h = canvas.height, z = view.zoom;
        if (view.isTargetMode) {
            view.target.x = (ex - w / 2) / z + view.x;
            view.target.y = -(ey - h / 2) / z + view.y;
            render(2);
        } else {
            view.x -= (ex - lastMouse.x) / z;
            view.y += (ey - lastMouse.y) / z;
            lastMouse = { x: ex, y: ey };
            startMoving();
        }
    }

    canvas.addEventListener('mousedown', e => { isDown = true; lastMouse = { x: e.clientX, y: e.clientY }; handleInput(e.clientX, e.clientY); });
    window.addEventListener('mouseup', () => isDown = false);
    window.addEventListener('mousemove', e => handleInput(e.clientX, e.clientY));

    canvas.addEventListener('touchstart', e => {
        if (e.touches.length === 1) {
            isDown = true;
            lastMouse = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        } else if (e.touches.length === 2 && !view.isTargetMode && !view.isMasterLocked) {
            initialPinchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        }
    });

    canvas.addEventListener('touchmove', e => {
        if (e.touches.length === 1) {
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        } else if (e.touches.length === 2 && initialPinchDist && !view.isTargetMode && !view.isMasterLocked) {
            const currentDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            view.zoom *= (currentDist / initialPinchDist);
            initialPinchDist = currentDist;
            startMoving();
        }
        e.preventDefault();
    }, { passive: false });

    window.addEventListener('touchend', () => { isDown = false; initialPinchDist = null; });

    function manualZoom(f) { if (!view.isMasterLocked && !view.isTargetMode) { view.zoom *= f; startMoving(); } }
    canvas.addEventListener('wheel', e => { manualZoom(e.deltaY > 0 ? 0.8 : 1.25); e.preventDefault(); }, { passive: false });

    function toggleMenu() { const s = document.getElementById('settings'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }
    
    function applySettings() {
        try {
            config.eq = document.getElementById('eqInput').value; 
            compiledEq = math.compile(config.eq);
            
            const keys = ['i3', 'i2', 'i1', 'h0', 'h1', 'h2', 'h3'];
            keys.forEach(k => {
                config.params[k].val = parseFloat(document.getElementById(k).value);
                config.params[k].en = document.getElementById('en_' + k).checked;
            });

            config.box.enabled = document.getElementById('boxEnable').checked;
            config.box.type = document.getElementById('maskType').value;
            config.box.x1 = parseFloat(document.getElementById('bx1').value); 
            config.box.x2 = parseFloat(document.getElementById('bx2').value);
            config.box.y1 = parseFloat(document.getElementById('by1').value); 
            config.box.y2 = parseFloat(document.getElementById('by2').value);

            config.colorOrigin.x = parseFloat(document.getElementById('origX').value);
            config.colorOrigin.y = parseFloat(document.getElementById('origY').value);

            toggleMenu(); 
            render(2);
        } catch(e) { alert("Hata: " + e.message); }
    }

    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; render(2); });
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    render(2);
</script>
</body>
</html>

