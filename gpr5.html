<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPR Pro v4</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#0c0c10;--surface:#13131a;--surface2:#1e1e2a;--border:#2a2a3a;--accent:#7c6af7;--accent2:#e97bff;--green:#3df5b0;--red:#ff6b6b;--yellow:#ffd166;--text:#e8e8f0;--text2:#8888aa;}
body.light{--bg:#f0f0f8;--surface:#fff;--surface2:#eaeaf5;--border:#d0d0e8;--text:#1a1a2e;--text2:#5a5a80;}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Space Mono',monospace;min-height:100vh;transition:background .3s,color .3s;}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:200;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.2rem;letter-spacing:-.5px;}
.logo span{color:var(--accent);}
.logo small{color:var(--text2);font-size:.65rem;font-family:'Space Mono',monospace;font-weight:400;display:block;}
.hactions{display:flex;gap:8px;align-items:center;}
.bico{background:var(--surface2);border:1px solid var(--border);color:var(--text);width:34px;height:34px;border-radius:7px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:background .2s,transform .15s;}
.bico:hover{background:var(--accent);transform:scale(1.08);}
.main{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 61px);}
.sidebar{background:var(--surface);border-right:1px solid var(--border);padding:18px 16px;overflow-y:auto;display:flex;flex-direction:column;gap:14px;}
.slbl{font-size:.6rem;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:6px;display:block;}
.card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;}
.card h3{font-family:'Syne',sans-serif;font-size:.82rem;font-weight:600;margin-bottom:10px;color:var(--accent);}
textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:.72rem;padding:8px;border-radius:6px;resize:vertical;min-height:72px;transition:border .2s;outline:none;}
textarea:focus{border-color:var(--accent);}
select{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:.72rem;padding:7px 9px;border-radius:6px;cursor:pointer;margin-bottom:9px;outline:none;}
select:focus{border-color:var(--accent);}
input[type=text],input[type=number]{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:.72rem;padding:6px 8px;border-radius:6px;outline:none;width:100%;}
input[type=text]:focus,input[type=number]:focus{border-color:var(--accent);}
.sg{margin-bottom:11px;}
.sh{display:flex;justify-content:space-between;font-size:.7rem;color:var(--text2);margin-bottom:3px;}
.sh span:last-child{color:var(--accent);font-weight:700;}
input[type=range]{width:100%;accent-color:var(--accent);height:4px;cursor:pointer;background:transparent;}
.brun{width:100%;padding:11px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-family:'Syne',sans-serif;font-size:.88rem;font-weight:600;cursor:pointer;transition:opacity .2s,transform .15s;}
.brun:hover:not(:disabled){opacity:.88;transform:translateY(-1px);}
.brun:disabled{opacity:.5;cursor:not-allowed;}
.bsm{padding:5px 11px;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;font-family:'Space Mono',monospace;font-size:.68rem;cursor:pointer;transition:background .2s;white-space:nowrap;}
.bsm:hover{background:var(--border);}
.bsm.active{background:var(--accent);border-color:var(--accent);color:#fff;}
.si{display:flex;align-items:center;gap:7px;margin-bottom:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:5px 9px;font-size:.7rem;}
.sdot{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.snm{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sdel{background:none;border:none;color:var(--red);cursor:pointer;font-size:13px;padding:0 3px;line-height:1;}
.content{padding:24px 28px;display:flex;flex-direction:column;gap:20px;}
.srow{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.sc{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 14px;position:relative;overflow:hidden;}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);}
.sc.gr::before{background:var(--green);}
.sc.rd::before{background:var(--red);}
.sc.yl::before{background:var(--yellow);}
.sc.pu::before{background:var(--accent2);}
.sv{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;line-height:1;margin-bottom:3px;}
.slb2{font-size:.6rem;color:var(--text2);letter-spacing:1px;text-transform:uppercase;}
.cc{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;position:relative;}
.ctbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.ctitle{font-family:'Syne',sans-serif;font-size:.88rem;font-weight:600;}
.cacts{display:flex;gap:7px;}
canvas{max-height:440px;width:100%!important;}
.pw{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;}
.pw h3{font-family:'Syne',sans-serif;font-size:.88rem;font-weight:600;margin-bottom:12px;}
.pt{width:100%;border-collapse:collapse;font-size:.74rem;}
.pt th{text-align:left;padding:7px 10px;color:var(--text2);font-size:.6rem;letter-spacing:1px;text-transform:uppercase;border-bottom:1px solid var(--border);}
.pt td{padding:8px 10px;border-bottom:1px solid var(--border);}
.pt tr:last-child td{border-bottom:none;}
.pt tr:hover td{background:var(--surface2);}
.cbw{display:inline-block;width:80px;background:var(--border);border-radius:3px;height:5px;vertical-align:middle;}
.cb{height:100%;border-radius:3px;background:var(--accent);}
.lp{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px 18px;}
.lp h3{font-family:'Syne',sans-serif;font-size:.82rem;font-weight:600;margin-bottom:8px;}
.ll{font-size:.66rem;color:var(--text2);max-height:110px;overflow-y:auto;display:flex;flex-direction:column;gap:3px;}
.ln{display:flex;gap:9px;}
.ln .ts{color:var(--border);flex-shrink:0;}
.ln .ok{color:var(--green);}
.ln .warn{color:var(--yellow);}
.ln .err{color:var(--red);}
.ln .info{color:var(--text2);}
.kbd{display:inline-block;padding:2px 7px;background:var(--accent);color:#fff;border-radius:4px;font-size:.62rem;margin-left:5px;}
.lmld{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:.7rem;color:var(--text2);margin-top:7px;}
.lmld strong{color:var(--accent);}
.lov{position:absolute;inset:0;background:rgba(12,12,16,.78);display:none;align-items:center;justify-content:center;border-radius:12px;z-index:10;}
.spin{width:30px;height:30px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.twrap{display:flex;align-items:center;gap:8px;font-size:.7rem;margin-top:7px;}
.tog{width:36px;height:20px;background:var(--border);border-radius:10px;position:relative;cursor:pointer;transition:background .25s;flex-shrink:0;border:none;}
.tog.on{background:var(--accent);}
.tog::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform .2s;}
.tog.on::after{transform:translateX(16px);}
.xyadd{display:none;gap:8px;margin-top:9px;align-items:flex-end;}
.xyadd .xyfield{flex:1;}
.xyadd label{font-size:.6rem;color:var(--text2);display:block;margin-bottom:3px;}
.dplist{max-height:170px;overflow-y:auto;margin-top:8px;}
.dpt{display:flex;align-items:center;gap:4px;padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:5px;font-size:.67rem;margin-bottom:4px;}
.dpt .dx{color:var(--accent);font-weight:700;min-width:32px;}
.dpt .dy{flex:1;}
.dpt .dact{display:flex;gap:3px;margin-left:auto;}
.dpt .dact button{background:none;border:none;color:var(--text2);cursor:pointer;font-size:12px;padding:1px 3px;line-height:1;}
.dpt .dact button:hover{color:var(--text);}
.dpt .dact .ddel{color:var(--red);}
.fsoverlay{position:fixed;inset:0;background:var(--bg);z-index:1000;display:none;flex-direction:column;padding:18px;}
.fsoverlay.active{display:flex;}
.fstbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
#fsChart{flex:1;width:100%!important;height:calc(100vh - 90px)!important;max-height:none!important;}
.row2{display:flex;gap:7px;margin-top:7px;}
.row2 .bsm{flex:1;text-align:center;}
.irow{display:flex;gap:7px;align-items:center;margin-top:6px;}
input[type=file]{display:none;}
.flbl{flex:1;padding:7px 9px;background:var(--bg);border:1px dashed var(--border);border-radius:6px;font-size:.68rem;color:var(--text2);cursor:pointer;text-align:center;transition:border-color .2s,color .2s;}
.flbl:hover{border-color:var(--accent);color:var(--accent);}
.up{color:var(--green);}
.down{color:var(--red);}
@media(max-width:900px){.main{grid-template-columns:1fr;}.sidebar{border-right:none;border-bottom:1px solid var(--border);}.srow{grid-template-columns:repeat(2,1fr);}}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
</style>
</head>
<body>

<div class="header">
  <div class="logo">GPR<span>Pro</span><small>v4 ‚Äî Hibrit Ensemble Tahmin</small></div>
  <div class="hactions">
    <button type="button" class="bico" id="themeBtn" title="Tema Deƒüi≈ütir">üåô</button>
    <button type="button" class="bico" id="exportCsvBtn" title="CSV Dƒ±≈üa Aktar">‚¨á</button>
    <button type="button" class="bico" id="exportPngBtn" title="Grafik PNG">üì∑</button>
    <button type="button" class="bico" id="fsBtn" title="Tam Ekran">‚õ∂</button>
  </div>
</div>

<div class="fsoverlay" id="fsOverlay">
  <div class="fstbar">
    <div class="ctitle" style="font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;">GPR Pro ‚Äî Tam Ekran</div>
    <button type="button" class="bsm" id="fsCloseBtn">‚úï Kapat</button>
  </div>
  <canvas id="fsChart"></canvas>
</div>

<div class="main">
<div class="sidebar">

  <div class="card">
    <h3>üìä Veri Noktalarƒ±</h3>
    <span class="slbl">Y deƒüerleri (virg√ºlle ayrƒ±lmƒ±≈ü)</span>
    <textarea id="dataInput">2.1, 2.9, 3.8, 5.1, 5.8, 7.2, 8.5</textarea>
    <div class="row2" style="margin-top:8px;">
      <input type="text" id="seriesName" placeholder="Seri adƒ±..." style="flex:1;">
      <button type="button" class="bsm" id="addSeriesBtn">+ Seri</button>
    </div>
    <div class="row2">
      <button type="button" class="bsm" id="toggleAddPointBtn">+ Nokta Ekle</button>
      <button type="button" class="bsm" id="refreshBtn">‚Ü∫ Yenile</button>
    </div>
    <div class="xyadd" id="xyAdd">
      <div class="xyfield"><label>X Deƒüeri</label><input type="number" id="addX" placeholder="x..." step="any"></div>
      <div class="xyfield"><label>Y Deƒüeri</label><input type="number" id="addY" placeholder="y..." step="any"></div>
      <button type="button" class="bsm" id="confirmAddPointBtn" style="height:34px;align-self:flex-end;">‚úì Ekle</button>
    </div>
    <div class="dplist" id="dpList"></div>
  </div>

  <div class="card">
    <h3>üìà Seriler</h3>
    <div id="seriesList"><div style="font-size:.68rem;color:var(--text2);">Seri eklenmedi; aktif veri kullanƒ±lƒ±r.</div></div>
  </div>

  <div class="card">
    <h3>üîÆ Kernel</h3>
    <select id="kernelSelect">
      <option value="rbf">RBF (Radial Basis Function)</option>
      <option value="matern">Mat√©rn 3/2</option>
      <option value="periodic">Periodic (Periyodik)</option>
      <option value="linear">Linear (Doƒürusal)</option>
      <option value="rq">Rational Quadratic</option>
    </select>
    <div id="kernelInfo" style="font-size:.66rem;color:var(--text2);padding:5px 7px;background:var(--bg);border-radius:5px;margin-bottom:9px;line-height:1.4;"></div>
    <div class="sg"><div class="sh"><span>Length Scale (‚Ñì)</span><span id="l_val">2.0</span></div><input type="range" id="param_l" min=".1" max="10" step=".1" value="2.0"></div>
    <div class="sg"><div class="sh"><span>G√ºr√ºlt√º (œÉ_n)</span><span id="n_val">0.10</span></div><input type="range" id="param_n" min=".01" max="2" step=".01" value="0.1"></div>
    <div class="sg" id="periodSW" style="display:none;"><div class="sh"><span>Periyot (p)</span><span id="p_val">3.0</span></div><input type="range" id="param_p" min=".5" max="10" step=".1" value="3.0"></div>
    <div class="sg" id="alphaSW" style="display:none;"><div class="sh"><span>Alpha (Œ±)</span><span id="a_val">1.0</span></div><input type="range" id="param_a" min=".1" max="5" step=".1" value="1.0"></div>
    <div class="lmld" id="lmlDisplay">LML: <strong>‚Äî</strong></div>
  </div>

  <div class="card">
    <h3>üéØ Tahmin Ayarlarƒ±</h3>
    <div class="sg"><div class="sh"><span>ƒ∞leri Adƒ±m (N)</span><span id="steps_val">8</span></div><input type="range" id="param_steps" min="1" max="30" step="1" value="8"></div>
    <div class="sg"><div class="sh"><span>G√ºven Aralƒ±ƒüƒ± (k¬∑œÉ)</span><span id="ci_val">1.96</span></div><input type="range" id="param_ci" min="1" max="3" step=".01" value="1.96"></div>
    <span class="slbl" style="margin-top:4px;">Ensemble Aƒüƒ±rlƒ±klarƒ±</span>
    <div class="sg"><div class="sh"><span>GPR</span><span id="wgpr_val">0.50</span></div><input type="range" id="w_gpr" min="0" max="1" step=".05" value=".5"></div>
    <div class="sg"><div class="sh"><span>AR(p)</span><span id="war_val">0.25</span></div><input type="range" id="w_ar" min="0" max="1" step=".05" value=".25"></div>
    <div class="sg"><div class="sh"><span>ETS</span><span id="wets_val">0.25</span></div><input type="range" id="w_ets" min="0" max="1" step=".05" value=".25"></div>
    <div class="twrap"><button type="button" class="tog on" id="toggleCI"></button><span>G√ºven Bandƒ± G√∂ster</span></div>
    <div class="twrap"><button type="button" class="tog on" id="toggleSamples"></button><span>GP √ñrnekleri √áiz</span></div>
    <div class="twrap"><button type="button" class="tog on" id="toggleEnsemble"></button><span>AR &amp; ETS Bile≈üenlerini G√∂ster</span></div>
  </div>

  <div class="card">
    <h3>‚öôÔ∏è Oto Optimizasyon</h3>
    <button type="button" class="bsm" id="autoOptBtn" style="width:100%;padding:8px;text-align:center;">üîç Grid Search (LML)</button>
    <div id="optResult" style="font-size:.66rem;color:var(--text2);margin-top:7px;line-height:1.4;"></div>
    <span class="slbl" style="margin-top:10px;">CSV ƒ∞√ße Aktar</span>
    <div class="irow">
      <label for="csvFile" class="flbl">üìÅ CSV dosyasƒ± se√ß</label>
      <input type="file" id="csvFile" accept=".csv,.txt">
    </div>
  </div>

  <button type="button" class="brun" id="runBtn">‚ñ∂ Hesapla &amp; Tahmin Et</button>

</div>

<div class="content">
  <div class="srow">
    <div class="sc"><div class="sv" id="stat-n">‚Äî</div><div class="slb2">Veri Noktasƒ±</div></div>
    <div class="sc gr"><div class="sv" id="stat-mean">‚Äî</div><div class="slb2">Ortalama</div></div>
    <div class="sc yl"><div class="sv" id="stat-std">‚Äî</div><div class="slb2">Std Sapma</div></div>
    <div class="sc rd"><div class="sv" id="stat-range">‚Äî</div><div class="slb2">Aralƒ±k</div></div>
    <div class="sc pu"><div class="sv" id="stat-trend">‚Äî</div><div class="slb2">Trend</div></div>
  </div>

  <div class="cc">
    <div class="lov" id="loadingOverlay"><div class="spin"></div></div>
    <div class="ctbar">
      <div class="ctitle">Gaussian Process Regression <span id="kernelBadge" class="kbd">RBF</span></div>
      <div class="cacts">
        <button type="button" class="bsm" id="gridToggleBtn">Grid</button>
        <button type="button" class="bsm" id="fullscreenChartBtn">‚õ∂ Tam Ekran</button>
      </div>
    </div>
    <canvas id="gprChart"></canvas>
  </div>

  <div class="pw">
    <h3>üî≠ Ensemble Tahmin Tablosu</h3>
    <div style="overflow-x:auto;">
      <table class="pt">
        <thead><tr><th>X</th><th>Seri</th><th>Ensemble Œº</th><th>GPR Œº</th><th>AR Œº</th><th>ETS Œº</th><th>Alt Sƒ±nƒ±r</th><th>√úst Sƒ±nƒ±r</th><th>G√ºven</th></tr></thead>
        <tbody id="predTableBody"><tr><td colspan="9" style="color:var(--text2);padding:14px;font-size:.73rem;">Hen√ºz hesaplama yapƒ±lmadƒ±‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="lp"><h3>üóí ƒ∞≈ülem G√ºnl√ºƒü√º</h3><div class="ll" id="logLines"></div></div>
</div>
</div>

<script>
(function() {
'use strict';

var chartInstance = null;
var fsChartInstance = null;
var isDark = true;
var showGrid = true;
var series = [];
var dataPoints = [];
var COLORS = ['#7c6af7','#3df5b0','#e97bff','#ffd166','#ff6b6b','#4ecdc4'];

function $(id){ return document.getElementById(id); }

function log(msg, type) {
  type = type || 'info';
  var el = $('logLines');
  var d = new Date();
  var ts = d.toTimeString().slice(0,8);
  var div = document.createElement('div');
  div.className = 'ln';
  div.innerHTML = '<span class="ts">'+ts+'</span><span class="'+type+'">'+msg+'</span>';
  el.insertBefore(div, el.firstChild);
  while(el.children.length > 60) el.removeChild(el.lastChild);
}

function hexToRgba(hex, a) {
  var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return 'rgba('+r+','+g+','+b+','+a+')';
}

function parseTextareaPoints() {
  var raw = $('dataInput').value;
  var ys = raw.split(',').map(Number).filter(function(n){ return !isNaN(n); });
  dataPoints = ys.map(function(y,i){ return {x:i+1, y:y}; });
  renderDataPoints();
  log('Textarea verisi y√ºklendi: '+dataPoints.length+' nokta', 'ok');
}

function renderDataPoints() {
  var el = $('dpList');
  if(!dataPoints.length){ el.innerHTML = ''; return; }
  el.innerHTML = dataPoints.map(function(p,i){
    return '<div class="dpt"><span class="dx">x='+p.x+'</span><span class="dy">y='+p.y+'</span><div class="dact"><button type="button" onclick="GPR.movePoint('+i+',-1)">‚Üë</button><button type="button" onclick="GPR.movePoint('+i+',1)">‚Üì</button><button type="button" class="ddel" onclick="GPR.deletePoint('+i+')" style="color:var(--red)">‚úï</button></div></div>';
  }).join('');
}

function movePoint(i, dir) {
  var ni = i + dir;
  if(ni < 0 || ni >= dataPoints.length) return;
  var tmp = dataPoints[i]; dataPoints[i] = dataPoints[ni]; dataPoints[ni] = tmp;
  dataPoints = dataPoints.map(function(p,idx){ return {x:idx+1, y:p.y}; });
  renderDataPoints();
}

function deletePoint(i) {
  dataPoints.splice(i,1);
  dataPoints = dataPoints.map(function(p,idx){ return {x:idx+1, y:p.y}; });
  renderDataPoints();
  log('Nokta silindi. Toplam: '+dataPoints.length, 'warn');
}

function addXYPoint() {
  var xv = parseFloat($('addX').value);
  var yv = parseFloat($('addY').value);
  if(isNaN(xv) || isNaN(yv)){ alert('Ge√ßerli X ve Y deƒüeri girin.'); return; }
  dataPoints.push({x:xv, y:yv});
  dataPoints.sort(function(a,b){ return a.x-b.x; });
  $('addX').value = '';
  $('addY').value = '';
  renderDataPoints();
  log('Nokta eklendi: x='+xv+', y='+yv, 'ok');
}

function getActiveData() {
  if(dataPoints.length >= 2) return {X: dataPoints.map(function(p){ return p.x; }), y: dataPoints.map(function(p){ return p.y; })};
  var raw = $('dataInput').value;
  var ys = raw.split(',').map(Number).filter(function(n){ return !isNaN(n); });
  return {X: ys.map(function(_,i){ return i+1; }), y: ys};
}

function addSeries() {
  var d = getActiveData();
  if(d.y.length < 2){ alert('En az 2 veri noktasƒ± gerekli.'); return; }
  var name = $('seriesName').value.trim() || ('Seri '+(series.length+1));
  series.push({name:name, X:d.X, y:d.y});
  $('seriesName').value = '';
  renderSeriesList();
  log('Seri eklendi: "'+name+'" ('+d.y.length+' nokta)', 'ok');
}

function removeSeries(i) {
  log('Seri silindi: "'+series[i].name+'"', 'warn');
  series.splice(i,1);
  renderSeriesList();
}

function renderSeriesList() {
  var el = $('seriesList');
  if(!series.length){ el.innerHTML = '<div style="font-size:.68rem;color:var(--text2);">Seri eklenmedi; aktif veri kullanƒ±lƒ±r.</div>'; return; }
  el.innerHTML = series.map(function(s,i){
    return '<div class="si"><div class="sdot" style="background:'+COLORS[i%COLORS.length]+'"></div><div class="snm">'+s.name+'</div><button type="button" class="sdel" onclick="GPR.removeSeries('+i+')">‚úï</button></div>';
  }).join('');
}

function importCSV(evt) {
  var file = evt.target.files[0];
  if(!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    var lines = e.target.result.trim().split('\n');
    var nums = [];
    lines.forEach(function(line){
      var parts = line.split(/[,;\t]/);
      for(var k=0;k<parts.length;k++){
        var n = parseFloat(parts[k].replace(',','.'));
        if(!isNaN(n)){ nums.push(n); break; }
      }
    });
    if(nums.length < 2){ alert('CSV dosyasƒ±ndan sayƒ± okunamadƒ±.'); return; }
    $('dataInput').value = nums.join(', ');
    dataPoints = nums.map(function(y,i){ return {x:i+1,y:y}; });
    renderDataPoints();
    log('CSV i√ße aktarƒ±ldƒ±: '+file.name+' ('+nums.length+' satƒ±r)', 'ok');
  };
  reader.readAsText(file);
}

function updateKernelInfo() {
  var k = $('kernelSelect').value;
  var infos = {
    rbf:'Sonsuz t√ºrevlenebilir, d√ºzg√ºn tahminler. Genel ama√ßlƒ± ideal ba≈ülangƒ±√ß noktasƒ±.',
    matern:'2 kez t√ºrevlenebilir. Ger√ßek d√ºnya verilerine daha doƒüal uyum saƒülar.',
    periodic:'D√∂ng√ºsel veya mevsimsel veriler i√ßin. Periyot parametresiyle ayarlayƒ±n.',
    linear:'Doƒürusal trend modelleme. Basit artƒ±≈ü/azalƒ±≈ü veriler i√ßin.',
    rq:'√áok √∂l√ßekli. RBF\'nin genelle≈ütirilmi≈ü hali, daha esnek.'
  };
  $('kernelInfo').textContent = infos[k] || '';
  $('periodSW').style.display = k==='periodic' ? 'block' : 'none';
  $('alphaSW').style.display = k==='rq' ? 'block' : 'none';
  $('kernelBadge').textContent = k.toUpperCase();
}

function kfn(x1,x2,l,sf,kname,params) {
  var d=x1-x2, r=Math.abs(d);
  if(kname==='rbf') return sf*sf*Math.exp(-d*d/(2*l*l));
  if(kname==='matern'){ var s=Math.sqrt(3)*r/l; return sf*sf*(1+s)*Math.exp(-s); }
  if(kname==='periodic'){ var p=params.p||3, sv=Math.sin(Math.PI*r/p); return sf*sf*Math.exp(-2*sv*sv/(l*l)); }
  if(kname==='linear') return sf*sf*(x1*x2+l*l);
  if(kname==='rq'){ var a=params.alpha||1; return sf*sf*Math.pow(1+d*d/(2*a*l*l),-a); }
  return sf*sf*Math.exp(-d*d/(2*l*l));
}

function buildCov(X1,X2,l,sf,kname,params) {
  return X1.map(function(a){ return X2.map(function(b){ return kfn(a,b,l,sf,kname,params); }); });
}

function lml(y,K) {
  try {
    var n=y.length, Ki=math.inv(K), alpha=math.multiply(Ki,y);
    var fit=-0.5*math.dot(y,alpha);
    var eigs=math.eigs(K).values;
    var logdet=eigs.reduce(function(a,v){ return a+Math.log(Math.max(v,1e-12)); },0);
    return fit-0.5*logdet-0.5*n*Math.log(2*Math.PI);
  } catch(e){ return NaN; }
}

function gprPredict(X,y,Xstar,l,sn,sf,kname,params) {
  var K=buildCov(X,X,l,sf,kname,params);
  for(var i=0;i<K.length;i++) K[i][i]+=sn*sn;
  var Ki=math.inv(K);
  var Ks=buildCov(Xstar,X,l,sf,kname,params);
  var Kss=buildCov(Xstar,Xstar,l,sf,kname,params);
  var KsKi=math.multiply(Ks,Ki);
  return {mu:math.multiply(KsKi,y), cov:math.subtract(Kss,math.multiply(KsKi,math.transpose(Ks)))};
}

function arForecast(y,steps,order) {
  var n=y.length, p=Math.min(order,n-1);
  if(p<1) return Array(steps).fill(y[n-1]);
  var A=[],b=[];
  for(var i=p;i<n;i++){
    var row=[];
    for(var j=1;j<=p;j++) row.push(y[i-j]);
    A.push(row); b.push(y[i]);
  }
  try {
    var At=math.transpose(A);
    var coef=math.multiply(math.inv(math.multiply(At,A)),math.multiply(At,b));
    var hist=y.slice(), preds=[];
    for(var s=0;s<steps;s++){
      var x=[];
      for(var j=0;j<p;j++) x.push(hist[hist.length-1-j]);
      var pred=math.dot(coef,x);
      preds.push(pred); hist.push(pred);
    }
    return preds;
  } catch(e){ return Array(steps).fill(y[n-1]); }
}

function etsForecast(y,steps) {
  var n=y.length, alpha=0.3, beta=0.1;
  var level=y[0], trend=(y[n-1]-y[0])/(n-1)||0;
  for(var i=1;i<n;i++){
    var pl=level;
    level=alpha*y[i]+(1-alpha)*(level+trend);
    trend=beta*(level-pl)+(1-beta)*trend;
  }
  var preds=[];
  for(var s=1;s<=steps;s++) preds.push(level+trend*s);
  return preds;
}

function computeStats(y) {
  var n=y.length, mean=y.reduce(function(a,b){return a+b;},0)/n;
  var std=Math.sqrt(y.reduce(function(a,b){return a+Math.pow(b-mean,2);},0)/n);
  var X=y.map(function(_,i){return i+1;}), xm=(n+1)/2;
  var slope=X.reduce(function(a,x,i){return a+(x-xm)*(y[i]-mean);},0)/X.reduce(function(a,x){return a+Math.pow(x-xm,2);},0);
  return {n:n, mean:mean, std:std, range:Math.max.apply(null,y)-Math.min.apply(null,y), slope:slope};
}

function updateStats(y) {
  var s=computeStats(y);
  $('stat-n').textContent=s.n;
  $('stat-mean').textContent=s.mean.toFixed(2);
  $('stat-std').textContent=s.std.toFixed(2);
  $('stat-range').textContent=s.range.toFixed(2);
  var se=$('stat-trend');
  se.textContent=(s.slope>=0?'+':'')+s.slope.toFixed(3);
  se.className='sv '+(s.slope>=0?'up':'down');
}

function runGPR() {
  var btn=$('runBtn');
  btn.disabled=true; btn.textContent='‚è≥ Hesaplanƒ±yor‚Ä¶';
  $('loadingOverlay').style.display='flex';
  setTimeout(function(){
    try{ _runGPR(); } catch(e){ log('Hata: '+e.message,'err'); console.error(e); }
    btn.disabled=false; btn.textContent='‚ñ∂ Hesapla & Tahmin Et';
    $('loadingOverlay').style.display='none';
  },60);
}

function _runGPR() {
  var d=getActiveData();
  if(d.y.length<3){ alert('En az 3 veri noktasƒ± gerekli.'); return; }
  var plotSeries=series.length>0?series:[{name:'Aktif Seri',X:d.X,y:d.y}];
  var l=parseFloat($('param_l').value);
  var sn=parseFloat($('param_n').value);
  var steps=parseInt($('param_steps').value);
  var ciK=parseFloat($('param_ci').value);
  var showCI=$('toggleCI').classList.contains('on');
  var showSamp=$('toggleSamples').classList.contains('on');
  var showEns=$('toggleEnsemble').classList.contains('on');
  var pp=parseFloat($('param_p').value||3);
  var aa=parseFloat($('param_a').value||1);
  var params={p:pp,alpha:aa};
  var kname=$('kernelSelect').value;
  var wG=parseFloat($('w_gpr').value);
  var wA=parseFloat($('w_ar').value);
  var wE=parseFloat($('w_ets').value);
  var ws=wG+wA+wE||1;
  var W={g:wG/ws,a:wA/ws,e:wE/ws};
  updateStats(plotSeries[0].y);
  var tableRows=[], chartDatasets=[], lmlTotal=0;

  plotSeries.forEach(function(ser,si){
    var y=ser.y, X=ser.X||y.map(function(_,i){return i+1;}), color=COLORS[si%COLORS.length], n=y.length;
    var last_x=X[X.length-1];
    var ym=y.reduce(function(a,b){return a+b;},0)/n;
    var yv=y.reduce(function(a,b){return a+Math.pow(b-ym,2);},0)/n;
    var sf=Math.sqrt(yv)||1;

    var ss=Math.max((last_x-X[0])/(Math.max(n-1,1)*5),0.2);
    var X_obs=[];
    for(var v=X[0];v<=last_x+0.01;v+=ss) X_obs.push(parseFloat(v.toFixed(3)));
    var X_fut=Array.from({length:steps},function(_,i){return last_x+i+1;});
    var X_star=X_obs.concat(X_fut);

    var gprMu=Array(X_star.length).fill(0), gprCov=null, lv=NaN;
    try{
      var K=buildCov(X,X,l,sf,kname,params);
      for(var i=0;i<K.length;i++) K[i][i]+=sn*sn;
      lv=lml(y,K); lmlTotal+=isNaN(lv)?0:lv;
      var res=gprPredict(X,y,X_star,l,sn,sf,kname,params);
      gprMu=res.mu; gprCov=res.cov;
    } catch(e){ log('[GPR] Matris hatasƒ±: '+e.message,'err'); }

    var arO=Math.min(5,Math.floor(n/2));
    var arF=arForecast(y,steps,arO);
    var etsF=etsForecast(y,steps);
    var gprF=X_fut.map(function(_,i){
      var idx=X_star.indexOf(X_fut[i]);
      return idx>=0?gprMu[idx]:NaN;
    });
    var ensF=X_fut.map(function(_,i){ return W.g*gprF[i]+W.a*arF[i]+W.e*etsF[i]; });

    var fCIu=[], fCIl=[];
    X_fut.forEach(function(_,i){
      var idx=X_star.indexOf(X_fut[i]);
      if(idx>=0&&gprCov){ var sd=Math.sqrt(Math.max(0,gprCov[idx][idx])); fCIu.push(ensF[i]+ciK*sd); fCIl.push(ensF[i]-ciK*sd); }
      else{ fCIu.push(ensF[i]*1.1); fCIl.push(ensF[i]*0.9); }
    });

    var oU=[], oL=[];
    X_obs.forEach(function(_,i){
      if(gprCov){ var sd=Math.sqrt(Math.max(0,gprCov[i][i])); oU.push(gprMu[i]+ciK*sd); oL.push(gprMu[i]-ciK*sd); }
      else{ oU.push(gprMu[i]); oL.push(gprMu[i]); }
    });

    chartDatasets.push({label:ser.name+' (Veri)',data:X.map(function(x,i){return{x:x,y:y[i]};}),type:'scatter',backgroundColor:color,borderColor:color,pointRadius:6,pointHoverRadius:9,order:1});
    chartDatasets.push({label:ser.name+' GPR',data:X_obs.map(function(x,i){return{x:x,y:gprMu[i]};}),borderColor:color,backgroundColor:'transparent',borderWidth:2.5,pointRadius:0,tension:0.4,order:2});
    if(showCI){
      chartDatasets.push({label:ser.name+' CI+',data:X_obs.map(function(x,i){return{x:x,y:oU[i]};}),borderColor:hexToRgba(color,.22),backgroundColor:'transparent',borderWidth:1,borderDash:[4,4],pointRadius:0,tension:0.4,order:3});
      chartDatasets.push({label:'_lo'+si,data:X_obs.map(function(x,i){return{x:x,y:oL[i]};}),borderColor:hexToRgba(color,.1),backgroundColor:hexToRgba(color,.07),fill:'-1',borderWidth:1,borderDash:[4,4],pointRadius:0,tension:0.4,order:3});
    }
    chartDatasets.push({label:ser.name+' Ensemble ‚ñ≤',data:X_fut.map(function(x,i){return{x:x,y:ensF[i]};}),type:'scatter',backgroundColor:hexToRgba(color,.92),borderColor:'#fff',pointRadius:8,pointHoverRadius:10,pointStyle:'triangle',borderWidth:2,order:0});
    chartDatasets.push({label:ser.name+' Ens √áizgi',data:[{x:last_x,y:y[n-1]}].concat(X_fut.map(function(x,i){return{x:x,y:ensF[i]};})),borderColor:hexToRgba(color,.65),backgroundColor:'transparent',borderWidth:2,borderDash:[6,3],pointRadius:0,tension:0.3,order:1});
    if(showCI){
      chartDatasets.push({label:ser.name+' FCI+',data:X_fut.map(function(x,i){return{x:x,y:fCIu[i]};}),borderColor:hexToRgba(color,.18),backgroundColor:'transparent',borderWidth:1,borderDash:[3,3],pointRadius:0,tension:0.3,order:3});
      chartDatasets.push({label:'_flo'+si,data:X_fut.map(function(x,i){return{x:x,y:fCIl[i]};}),borderColor:hexToRgba(color,.08),backgroundColor:hexToRgba(color,.06),fill:'-1',borderWidth:1,borderDash:[3,3],pointRadius:0,tension:0.3,order:3});
    }
    if(showEns){
      chartDatasets.push({label:ser.name+' AR',data:[{x:last_x,y:y[n-1]}].concat(X_fut.map(function(x,i){return{x:x,y:arF[i]};})),borderColor:hexToRgba('#ffd166',.65),backgroundColor:'transparent',borderWidth:1.2,borderDash:[2,4],pointRadius:3,tension:0.3,order:0});
      chartDatasets.push({label:ser.name+' ETS',data:[{x:last_x,y:y[n-1]}].concat(X_fut.map(function(x,i){return{x:x,y:etsF[i]};})),borderColor:hexToRgba('#3df5b0',.65),backgroundColor:'transparent',borderWidth:1.2,borderDash:[2,4],pointRadius:3,tension:0.3,order:0});
    }
    if(showSamp&&si===0&&gprCov){
      for(var s=0;s<3;s++){
        (function(s2){
          var samp=X_obs.map(function(_,i){var v=Math.max(0,gprCov[i][i]);return gprMu[i]+Math.sqrt(v)*(Math.random()*2-1)*1.1;});
          chartDatasets.push({label:'_samp'+s2,data:X_obs.map(function(x,i){return{x:x,y:samp[i]};}),borderColor:hexToRgba(color,.18),backgroundColor:'transparent',borderWidth:1,pointRadius:0,tension:0.4,borderDash:[1,3],order:0});
        })(s);
      }
    }

    X_fut.forEach(function(tx,i){
      var mu=ensF[i],lo=fCIl[i],hi=fCIu[i],bw=hi-lo;
      var conf=Math.max(0,Math.min(100,100*(1-bw/Math.max(Math.abs(mu)*4,1))));
      tableRows.push({tx:tx,serName:ser.name,mu:mu.toFixed(3),gm:isNaN(gprF[i])?'‚Äî':gprF[i].toFixed(3),am:arF[i].toFixed(3),em:etsF[i].toFixed(3),lo:lo.toFixed(3),hi:hi.toFixed(3),conf:conf.toFixed(0),color:color});
    });

    log('['+ser.name+'] kn='+kname+' LML='+(isNaN(lv)?'‚Äî':lv.toFixed(2))+' W(g='+W.g.toFixed(2)+',a='+W.a.toFixed(2)+',e='+W.e.toFixed(2)+')','ok');
  });

  $('lmlDisplay').innerHTML='LML: <strong>'+lmlTotal.toFixed(4)+'</strong> <span style="color:var(--text2);font-size:.62rem">(y√ºksek = iyi uyum)</span>';
  drawChart(chartDatasets, plotSeries[0].X||plotSeries[0].y.map(function(_,i){return i+1;}));

  var tbody=$('predTableBody');
  if(!tableRows.length){ tbody.innerHTML='<tr><td colspan="9" style="color:var(--text2);padding:12px">Tahmin noktasƒ± bulunamadƒ±.</td></tr>'; return; }
  tbody.innerHTML=tableRows.map(function(r){
    return '<tr><td><strong>'+r.tx+'</strong></td>'
      +'<td><span style="display:inline-block;width:7px;height:7px;border-radius:50%;background:'+r.color+';margin-right:5px;vertical-align:middle;"></span>'+r.serName+'</td>'
      +'<td><strong>'+r.mu+'</strong></td>'
      +'<td style="color:var(--accent)">'+r.gm+'</td>'
      +'<td style="color:var(--yellow)">'+r.am+'</td>'
      +'<td style="color:var(--green)">'+r.em+'</td>'
      +'<td style="color:var(--red)">'+r.lo+'</td>'
      +'<td style="color:var(--green)">'+r.hi+'</td>'
      +'<td><div class="cbw"><div class="cb" style="width:'+r.conf+'%;background:'+r.color+'"></div></div>'
      +'<span style="font-size:.62rem;color:var(--text2);margin-left:5px;">'+r.conf+'%</span></td></tr>';
  }).join('');
  log(tableRows.length+' tahmin satƒ±rƒ± olu≈üturuldu.','ok');
}

function buildChartConfig(datasets, X) {
  var lastX = Math.max.apply(null, X);
  var darkMode = !document.body.classList.contains('light');
  var gridColor = darkMode ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.07)';
  var tickColor = darkMode ? '#8888aa' : '#666';
  var legendColor = darkMode ? '#e8e8f0' : '#1a1a2e';
  var tooltipBg = darkMode ? '#1e1e2a' : '#fff';
  var tooltipBorder = darkMode ? '#2a2a3a' : '#ddd';

  var annotPlugin = {
    id:'ann',
    afterDraw: function(chart){
      var ctx=chart.ctx, top=chart.chartArea.top, bottom=chart.chartArea.bottom;
      var xPx=chart.scales.x.getPixelForValue(lastX);
      ctx.save();
      ctx.beginPath(); ctx.moveTo(xPx,top); ctx.lineTo(xPx,bottom);
      ctx.strokeStyle=darkMode?'rgba(255,255,255,0.18)':'rgba(0,0,0,0.15)';
      ctx.lineWidth=1.5; ctx.setLineDash([5,4]); ctx.stroke();
      ctx.fillStyle=darkMode?'rgba(255,255,255,0.5)':'rgba(0,0,0,0.4)';
      ctx.font='9px Space Mono,monospace';
      ctx.fillText('‚ñ∂ TAHMƒ∞N', xPx+5, top+13);
      ctx.restore();
    }
  };

  return {
    type:'line',
    data:{datasets:datasets},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      animation:{duration:550,easing:'easeOutCubic'},
      interaction:{mode:'index',intersect:false},
      scales:{
        x:{type:'linear',grid:{color:showGrid?gridColor:'transparent',display:showGrid},ticks:{color:tickColor,font:{family:'Space Mono,monospace',size:10}},title:{display:true,text:'X / Zaman Adƒ±mƒ±',color:tickColor}},
        y:{grid:{color:showGrid?gridColor:'transparent',display:showGrid},ticks:{color:tickColor,font:{family:'Space Mono,monospace',size:10}},title:{display:true,text:'Deƒüer',color:tickColor}}
      },
      plugins:{
        legend:{labels:{color:legendColor,font:{family:'Space Mono,monospace',size:10},filter:function(item){return !item.text.startsWith('_');}}},
        tooltip:{backgroundColor:tooltipBg,borderColor:tooltipBorder,borderWidth:1,titleColor:legendColor,bodyColor:tickColor,titleFont:{family:'Syne,sans-serif',size:12},bodyFont:{family:'Space Mono,monospace',size:10},callbacks:{label:function(item){if(item.dataset.label.startsWith('_'))return null;var v=item.raw&&item.raw.y!=null?item.raw.y:item.raw;return item.dataset.label+': '+parseFloat(v).toFixed(4);}}}
      }
    },
    plugins:[annotPlugin]
  };
}

function drawChart(datasets, X) {
  if(chartInstance){ chartInstance.destroy(); chartInstance=null; }
  var ctx=$('gprChart').getContext('2d');
  chartInstance=new Chart(ctx, buildChartConfig(datasets,X));
}

function openFullscreen() {
  if(!chartInstance){ alert('√ñnce hesaplama yapƒ±n.'); return; }
  $('fsOverlay').classList.add('active');
  var ctx=$('fsChart').getContext('2d');
  if(fsChartInstance){ fsChartInstance.destroy(); fsChartInstance=null; }
  var cfg=buildChartConfig(chartInstance.data.datasets, chartInstance.data.datasets.reduce(function(all,ds){return all.concat(ds.data.map(function(p){return p&&p.x!=null?p.x:0;}));},[]));
  cfg.options.maintainAspectRatio=false;
  fsChartInstance=new Chart(ctx,cfg);
}

function closeFullscreen() {
  $('fsOverlay').classList.remove('active');
  if(fsChartInstance){ fsChartInstance.destroy(); fsChartInstance=null; }
}

function autoOptimize() {
  var d=getActiveData();
  if(d.y.length<2){ alert('Veri girin.'); return; }
  var X=d.X, y=d.y;
  var kname=$('kernelSelect').value;
  var pp=parseFloat($('param_p').value||3), aa=parseFloat($('param_a').value||1);
  var params={p:pp,alpha:aa};
  var Ls=[0.3,0.5,1,1.5,2,3,5,7,10], Ns=[0.01,0.05,0.1,0.3,0.5,1];
  var bestLML=-Infinity, bestL=2, bestN=0.1;
  var ym=y.reduce(function(a,b){return a+b;},0)/y.length;
  var yv=y.reduce(function(a,b){return a+Math.pow(b-ym,2);},0)/y.length;
  var sf=Math.sqrt(yv)||1;
  Ls.forEach(function(l){
    Ns.forEach(function(sn){
      try{
        var K=buildCov(X,X,l,sf,kname,params);
        for(var i=0;i<K.length;i++) K[i][i]+=sn*sn;
        var v=lml(y,K);
        if(!isNaN(v)&&v>bestLML){ bestLML=v; bestL=l; bestN=sn; }
      }catch(e){}
    });
  });
  $('param_l').value=bestL; $('l_val').textContent=bestL.toFixed(1);
  $('param_n').value=bestN; $('n_val').textContent=bestN.toFixed(2);
  var msg='En iyi: ‚Ñì='+bestL+', œÉ_n='+bestN+' ‚Üí LML='+bestLML.toFixed(3);
  $('optResult').textContent=msg;
  log('Grid Search: '+msg,'ok');
  runGPR();
}

function exportCSV() {
  var d=getActiveData();
  var rows=[['x','t√ºr','deƒüer']];
  d.X.forEach(function(x,i){ rows.push([x,'g√∂zlem',d.y[i]]); });
  document.querySelectorAll('#predTableBody tr').forEach(function(tr){
    var tds=tr.querySelectorAll('td');
    if(tds.length>=3) rows.push([tds[0].textContent.trim(),'tahmin',tds[2].textContent.trim()]);
  });
  var csv=rows.map(function(r){return r.join(',');}).join('\n');
  var blob=new Blob([csv],{type:'text/csv'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='gpr_export.csv';
  a.click();
  URL.revokeObjectURL(a.href);
  log('CSV dƒ±≈üa aktarƒ±ldƒ±.','ok');
}

function exportPNG() {
  if(!chartInstance){ alert('√ñnce hesaplama yapƒ±n.'); return; }
  var a=document.createElement('a');
  a.href=chartInstance.toBase64Image('image/png',1);
  a.download='gpr_chart.png';
  a.click();
  log('PNG dƒ±≈üa aktarƒ±ldƒ±.','ok');
}

function toggleTheme() {
  isDark=!isDark;
  document.body.classList.toggle('light',!isDark);
  $('themeBtn').textContent=isDark?'üåô':'‚òÄÔ∏è';
  if(chartInstance) runGPR();
}

window.GPR={movePoint:movePoint,deletePoint:deletePoint,removeSeries:removeSeries};

document.addEventListener('DOMContentLoaded', function(){
  $('param_l').addEventListener('input',function(){ $('l_val').textContent=parseFloat(this.value).toFixed(1); });
  $('param_n').addEventListener('input',function(){ $('n_val').textContent=parseFloat(this.value).toFixed(2); });
  $('param_p').addEventListener('input',function(){ $('p_val').textContent=parseFloat(this.value).toFixed(1); });
  $('param_a').addEventListener('input',function(){ $('a_val').textContent=parseFloat(this.value).toFixed(1); });
  $('param_steps').addEventListener('input',function(){ $('steps_val').textContent=this.value; });
  $('param_ci').addEventListener('input',function(){ $('ci_val').textContent=parseFloat(this.value).toFixed(2); });
  $('w_gpr').addEventListener('input',function(){ $('wgpr_val').textContent=parseFloat(this.value).toFixed(2); });
  $('w_ar').addEventListener('input',function(){ $('war_val').textContent=parseFloat(this.value).toFixed(2); });
  $('w_ets').addEventListener('input',function(){ $('wets_val').textContent=parseFloat(this.value).toFixed(2); });

  $('kernelSelect').addEventListener('change', updateKernelInfo);
  $('runBtn').addEventListener('click', runGPR);
  $('themeBtn').addEventListener('click', toggleTheme);
  $('exportCsvBtn').addEventListener('click', exportCSV);
  $('exportPngBtn').addEventListener('click', exportPNG);
  $('fsBtn').addEventListener('click', openFullscreen);
  $('fsCloseBtn').addEventListener('click', closeFullscreen);
  $('fullscreenChartBtn').addEventListener('click', openFullscreen);
  $('autoOptBtn').addEventListener('click', autoOptimize);
  $('addSeriesBtn').addEventListener('click', addSeries);
  $('refreshBtn').addEventListener('click', parseTextareaPoints);
  $('confirmAddPointBtn').addEventListener('click', addXYPoint);
  $('csvFile').addEventListener('change', importCSV);

  $('toggleAddPointBtn').addEventListener('click',function(){
    var el=$('xyAdd');
    var showing=el.style.display==='flex';
    el.style.display=showing?'none':'flex';
    this.classList.toggle('active',!showing);
    if(!showing){ $('addX').focus(); }
  });

  $('toggleCI').addEventListener('click',function(){ this.classList.toggle('on'); });
  $('toggleSamples').addEventListener('click',function(){ this.classList.toggle('on'); });
  $('toggleEnsemble').addEventListener('click',function(){ this.classList.toggle('on'); });

  $('gridToggleBtn').addEventListener('click',function(){
    showGrid=!showGrid;
    this.classList.toggle('active',showGrid);
    if(chartInstance) runGPR();
  });

  document.addEventListener('keydown',function(e){
    if(e.key==='Escape') closeFullscreen();
    if((e.ctrlKey||e.metaKey)&&e.key==='Enter') runGPR();
  });

  updateKernelInfo();
  parseTextareaPoints();
  renderSeriesList();
  log('GPR Pro v4 ba≈ülatƒ±ldƒ± ‚Äî Ctrl+Enter ile hesaplayƒ±n.','info');
  setTimeout(runGPR, 400);
});

})();
</script>
</body>
</html>
