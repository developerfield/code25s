<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sensör Gap Analizi + MC-LSTM Tahmin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&display=swap');

:root {
  --bg: #f5f0e8;
  --paper: #faf7f0;
  --ink: #1a1410;
  --ink2: #3d3530;
  --ink3: #6b5f55;
  --rule: #d4c8b8;
  --sensor: #c0392b;
  --manual: #2471a3;
  --gap: #d4ac0d;
  --pred: #1e8449;
  --warn: #e67e22;
  --accent-light: rgba(192,57,43,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'Space Mono', monospace;
  min-height: 100vh;
}

/* Ruled paper texture */
body::before {
  content:'';
  position:fixed;
  inset:0;
  background-image: repeating-linear-gradient(
    transparent, transparent 27px,
    rgba(180,160,140,0.25) 27px, rgba(180,160,140,0.25) 28px
  );
  pointer-events:none;
  z-index:0;
}

.container {
  position:relative;
  z-index:1;
  max-width:1320px;
  margin:0 auto;
  padding:32px 24px;
}

header {
  margin-bottom:40px;
  border-bottom: 3px solid var(--ink);
  padding-bottom:20px;
}

.header-eyebrow {
  font-size:10px;
  letter-spacing:4px;
  color:var(--ink3);
  text-transform:uppercase;
  margin-bottom:6px;
}

h1 {
  font-family:'Bebas Neue', sans-serif;
  font-size:clamp(36px,6vw,72px);
  letter-spacing:3px;
  color:var(--ink);
  line-height:0.95;
}

h1 .red { color: var(--sensor); }
h1 .blue { color: var(--manual); }

.tagline {
  margin-top:10px;
  font-size:11px;
  color:var(--ink3);
  line-height:1.8;
  max-width:600px;
}

/* Data Entry Zone */
.entry-zone {
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:20px;
  margin-bottom:28px;
}

@media(max-width:900px){.entry-zone{grid-template-columns:1fr;}}

.entry-panel {
  background:var(--paper);
  border:2px solid var(--ink);
  padding:20px;
  position:relative;
}

.entry-panel::before {
  content:attr(data-label);
  position:absolute;
  top:-12px; left:12px;
  background:var(--paper);
  padding:0 8px;
  font-size:10px;
  letter-spacing:3px;
  text-transform:uppercase;
  font-weight:700;
  border:2px solid var(--ink);
}

.entry-panel.sensor-panel::before { color:var(--sensor); border-color:var(--sensor); background:var(--paper); }
.entry-panel.manual-panel::before { color:var(--manual); border-color:var(--manual); }
.entry-panel.gap-panel::before { color:var(--gap); border-color:var(--gap); }

textarea {
  width:100%;
  height:130px;
  background:transparent;
  border:1px solid var(--rule);
  border-radius:0;
  color:var(--ink);
  font-family:'Space Mono',monospace;
  font-size:12px;
  padding:10px;
  resize:vertical;
  outline:none;
  line-height:1.7;
}
textarea:focus { border-color:var(--ink); }

.entry-hint {
  font-size:10px;
  color:var(--ink3);
  margin-top:6px;
  line-height:1.7;
}

.entry-hint b { color:var(--sensor); }
.entry-panel.manual-panel .entry-hint b { color:var(--manual); }
.entry-panel.gap-panel .entry-hint b { color:var(--ink3); }

/* Manual row inputs */
.man-row {
  display:flex;
  gap:6px;
  align-items:center;
  animation: rowIn 0.15s ease;
}
@keyframes rowIn {
  from { opacity:0; transform:translateY(-4px); }
  to   { opacity:1; transform:translateY(0); }
}
.man-row-num {
  font-size:9px;
  color:var(--ink3);
  width:18px;
  text-align:right;
  flex-shrink:0;
  letter-spacing:1px;
}
.man-inp {
  flex:1;
  background:transparent;
  border:1px solid var(--rule);
  color:var(--ink);
  font-family:'Space Mono',monospace;
  font-size:12px;
  padding:5px 8px;
  outline:none;
  min-width:0;
  height:30px;
}
.man-inp:focus { border-color:var(--manual); }
.man-inp.x-inp { border-color:rgba(36,113,163,0.4); }
.man-inp-label {
  font-size:9px;
  color:var(--ink3);
  letter-spacing:1px;
  flex-shrink:0;
  width:12px;
  text-align:center;
}
.man-del {
  background:transparent;
  border:1px solid var(--rule);
  color:var(--ink3);
  font-family:'Space Mono',monospace;
  font-size:11px;
  width:24px;
  height:24px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  padding:0;
  transition:all 0.1s;
}
.man-del:hover { border-color:var(--sensor); color:var(--sensor); }

/* scrollbar for rows */
#manualRows::-webkit-scrollbar { width:4px; }
#manualRows::-webkit-scrollbar-track { background:transparent; }
#manualRows::-webkit-scrollbar-thumb { background:var(--rule); }

/* Chart controls */
.chart-ctrl-btn {
  background: var(--paper);
  border: 2px solid var(--ink);
  color: var(--ink);
  font-family: 'Space Mono', monospace;
  font-size: 14px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.1s;
  padding: 0;
  line-height: 1;
}
.chart-ctrl-btn:hover { background: var(--ink); color: var(--bg); }

/* Fullscreen chart */
.chart-big.fullscreen {
  position: fixed !important;
  inset: 0 !important;
  z-index: 9999 !important;
  margin: 0 !important;
  border: none !important;
  border-radius: 0 !important;
  display: flex;
  flex-direction: column;
  padding: 16px 20px;
  background: var(--paper);
}
.chart-big.fullscreen #chartWrap {
  flex: 1;
  height: auto !important;
}
.chart-big.fullscreen canvas {
  width: 100% !important;
  height: 100% !important;
}

/* Controls Row */
.controls-row {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:28px;
  padding:16px 20px;
  background:var(--paper);
  border:2px solid var(--ink);
}

.ctrl {
  display:flex;
  flex-direction:column;
  gap:4px;
}

.ctrl label {
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--ink3);
}

.ctrl input[type=range] {
  -webkit-appearance:none;
  width:120px;
  height:3px;
  background:var(--rule);
  outline:none;
  cursor:pointer;
}

.ctrl input[type=range]::-webkit-slider-thumb {
  -webkit-appearance:none;
  width:13px; height:13px;
  background:var(--ink);
  border-radius:50%;
  cursor:pointer;
}

.ctrl .val {
  font-size:13px;
  font-weight:700;
  color:var(--ink);
}

.btn {
  padding:10px 22px;
  background:var(--ink);
  color:var(--bg);
  border:2px solid var(--ink);
  font-family:'Space Mono',monospace;
  font-size:11px;
  letter-spacing:2px;
  text-transform:uppercase;
  cursor:pointer;
  transition:all 0.15s;
}
.btn:hover { background:transparent; color:var(--ink); }
.btn.red { background:var(--sensor); border-color:var(--sensor); }
.btn.red:hover { background:transparent; color:var(--sensor); }
.btn.blue { background:var(--manual); border-color:var(--manual); }
.btn.blue:hover { background:transparent; color:var(--manual); }
.btn.green { background:var(--pred); border-color:var(--pred); }
.btn.green:hover { background:transparent; color:var(--pred); }
.btn:disabled { opacity:0.4; cursor:not-allowed; }

/* Status Bar */
.status-bar {
  display:flex;
  gap:0;
  margin-bottom:28px;
  border:2px solid var(--ink);
  overflow:hidden;
}

.status-item {
  flex:1;
  padding:12px 16px;
  border-right:1px solid var(--rule);
  background:var(--paper);
}
.status-item:last-child { border-right:none; }

.si-label {
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--ink3);
  margin-bottom:4px;
}

.si-val {
  font-size:18px;
  font-weight:700;
  color:var(--ink);
}

.si-val.ok { color:var(--pred); }
.si-val.warn { color:var(--warn); }
.si-val.err { color:var(--sensor); }

/* Main Chart */
.chart-big {
  background:var(--paper);
  border:2px solid var(--ink);
  padding:20px;
  margin-bottom:20px;
  position:relative;
}

.chart-title {
  font-family:'Bebas Neue',sans-serif;
  font-size:22px;
  letter-spacing:2px;
  margin-bottom:4px;
}

.chart-legend {
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  margin-bottom:12px;
  font-size:10px;
  letter-spacing:1px;
}

.leg-item {
  display:flex;
  align-items:center;
  gap:6px;
}

.leg-dot {
  width:20px;
  height:3px;
  border-radius:2px;
}

/* Progress bar */
.progress-wrap {
  display:none;
  margin-bottom:20px;
  background:var(--paper);
  border:2px solid var(--ink);
  padding:16px 20px;
}

.progress-label {
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  margin-bottom:8px;
  color:var(--ink3);
}

.progress-bar-outer {
  width:100%;
  height:6px;
  background:var(--rule);
}

.progress-bar-inner {
  height:100%;
  background:var(--pred);
  transition:width 0.1s;
}

.progress-text {
  font-size:13px;
  font-weight:700;
  margin-top:6px;
}

/* Results Grid */
.results-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-bottom:20px;
}
@media(max-width:800px){.results-grid{grid-template-columns:1fr;}}

.result-card {
  background:var(--paper);
  border:2px solid var(--ink);
  padding:20px;
}

.rc-title {
  font-family:'Bebas Neue',sans-serif;
  font-size:18px;
  letter-spacing:2px;
  margin-bottom:12px;
  border-bottom:1px solid var(--rule);
  padding-bottom:8px;
}

.finding-row {
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  padding:6px 0;
  border-bottom:1px dotted var(--rule);
  font-size:11px;
}

.finding-row:last-child { border-bottom:none; }
.fr-label { color:var(--ink3); }
.fr-val { font-weight:700; }
.fr-val.ok { color:var(--pred); }
.fr-val.warn { color:var(--warn); }
.fr-val.err { color:var(--sensor); }

/* Gap feasibility indicator */
.feasibility-box {
  padding:14px;
  border:2px solid;
  margin-bottom:16px;
  font-size:11px;
  line-height:1.8;
}
.feasibility-box.ok { border-color:var(--pred); background:rgba(30,132,73,0.06); }
.feasibility-box.warn { border-color:var(--warn); background:rgba(230,126,34,0.06); }
.feasibility-box.err { border-color:var(--sensor); background:rgba(192,57,43,0.06); }

/* Probability table */
.prob-table {
  width:100%;
  border-collapse:collapse;
  font-size:11px;
  margin-top:8px;
}

.prob-table th {
  text-align:left;
  padding:5px 8px;
  border-bottom:2px solid var(--ink);
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--ink3);
}

.prob-table td {
  padding:5px 8px;
  border-bottom:1px dotted var(--rule);
}

.prob-bar-cell { width:100px; }

.prob-bar {
  height:8px;
  background:var(--rule);
  border-radius:2px;
  overflow:hidden;
}

.prob-fill {
  height:100%;
  border-radius:2px;
  background:var(--manual);
  transition:width 0.5s;
}

/* Explanation box */
.explanation {
  background:var(--paper);
  border-left:4px solid var(--ink);
  padding:16px 20px;
  margin-bottom:20px;
  font-size:11px;
  line-height:1.9;
  color:var(--ink2);
}

.explanation strong { color:var(--ink); }
</style>
</head>
<body>
<div class="container">

<header>
  <div class="header-eyebrow">// Sensör · Gap İmputation · MC-Dropout Tahmin</div>
  <h1><span class="red">SENSOR</span><br><span class="blue">GAP</span> ANALİZİ</h1>
  <p class="tagline">
    Sensör verisi, elle ölçüm ve aradaki boşluğu birleştir.<br>
    Olası yolları simüle et · MC-Dropout LSTM ile tahmin üret.
  </p>
</header>

<!-- Entry Zone -->
<div class="entry-zone">
  <div class="entry-panel sensor-panel" data-label="sensör verisi (kümülatif Y)">
    <textarea id="sensorData" placeholder="0, -2.5, -5, -8.1, -11, -14.2, -18, -22, -26, -29.5, -31&#10;&#10;Virgülle veya yeni satırla ayırın.&#10;İlk değer başlangıç noktanız olur."></textarea>
    <div class="entry-hint"><b>Kırmızı</b> olarak gösterilecek. Sensörün topladığı kümülatif veriler.</div>
  </div>
  <div class="entry-panel gap-panel" data-label="boşluk (gap) bilgisi">
    <div style="display:flex;flex-direction:column;gap:12px;padding-top:8px;">
      <div class="ctrl" style="flex-direction:row;align-items:center;gap:12px;">
        <div>
          <label style="display:block;">Gap Uzunluğu (x adım)</label>
          <span class="val" id="gapLenVal">15</span>
        </div>
        <input type="range" id="gapLen" min="1" max="60" value="15"
          oninput="document.getElementById('gapLenVal').textContent=this.value; updateFeasibility()">
      </div>
      <div class="ctrl" style="flex-direction:row;align-items:center;gap:12px;">
        <div>
          <label style="display:block;">Simülasyon Sayısı</label>
          <span class="val" id="simCountVal">5000</span>
        </div>
        <input type="range" id="simCount" min="500" max="20000" step="500" value="5000"
          oninput="document.getElementById('simCountVal').textContent=this.value">
      </div>
      <div id="feasibilityMini" class="feasibility-box ok" style="margin-bottom:0;">
        Gap uygunluğu hesaplanıyor…
      </div>
    </div>
    <div class="entry-hint">Sensör bozulmasından elle ölçüme geçişe kadar kaç x adımı geçti?</div>
  </div>
  <div class="entry-panel manual-panel" data-label="elle ölçüm (x → y)">
    <div id="manualRows" style="display:flex;flex-direction:column;gap:6px;max-height:160px;overflow-y:auto;padding-right:4px;margin-bottom:10px;"></div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn blue" style="padding:7px 14px;font-size:10px;" onclick="addManualRow()">+ SATIR EKLE</button>
      <button class="btn" style="padding:7px 14px;font-size:10px;background:transparent;color:var(--ink3);border-color:var(--rule);" onclick="clearManualRows()">TEMİZLE</button>
      <span id="manRowCount" style="font-size:10px;color:var(--ink3);margin-left:auto;">0 nokta</span>
    </div>
    <div class="entry-hint" style="margin-top:8px;"><b>Mavi</b> olarak gösterilecek. X ve karşılık gelen kümülatif Y değerini girin.</div>
  </div>
</div>

<!-- Controls -->
<div class="controls-row">
  <div class="ctrl">
    <label>δ Max Sınır</label>
    <span class="val" id="deltaMaxVal">2.0</span>
    <input type="range" id="deltaMax" min="0.5" max="4" step="0.1" value="2"
      oninput="document.getElementById('deltaMaxVal').textContent=parseFloat(this.value).toFixed(1); updateFeasibility()">
  </div>
  <div class="ctrl">
    <label>MC-LSTM Tekrar</label>
    <span class="val" id="mcRepVal">200</span>
    <input type="range" id="mcRep" min="50" max="500" step="50" value="200"
      oninput="document.getElementById('mcRepVal').textContent=this.value">
  </div>
  <div class="ctrl">
    <label>Tahmin Adımı</label>
    <span class="val" id="predStepVal">7</span>
    <input type="range" id="predStep" min="1" max="30" value="7"
      oninput="document.getElementById('predStepVal').textContent=this.value">
  </div>
  <div style="flex:1"></div>
  <button class="btn" onclick="runGapSim()">▶ GAP SİMÜLE ET</button>
  <button class="btn green" id="lstmBtn" onclick="runMCLSTM()" disabled>▶ MC-LSTM TAHMİN</button>
  <button class="btn red" onclick="loadExample()">ÖRNEK VERİ YÜKLE</button>
</div>

<!-- Status Bar -->
<div class="status-bar">
  <div class="status-item">
    <div class="si-label">Sensör Noktası</div>
    <div class="si-val" id="stSensor">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Gap Uzunluğu</div>
    <div class="si-val" id="stGap">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Elle Ölçüm</div>
    <div class="si-val" id="stManual">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Max Fiziksel Δ</div>
    <div class="si-val" id="stFeasDelta">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Gap Durumu</div>
    <div class="si-val" id="stFeas">—</div>
  </div>
  <div class="status-item">
    <div class="si-label">Geçerli Yol</div>
    <div class="si-val" id="stPaths">—</div>
  </div>
</div>

<!-- Main Chart -->
<div class="chart-big" id="chartBig">
  <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:8px;">
    <div class="chart-title" style="margin-bottom:0;">TAM VERİ HARİTASI</div>
    <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
      <button class="chart-ctrl-btn" onclick="zoomIn()" title="Yakınlaştır">＋</button>
      <button class="chart-ctrl-btn" onclick="zoomOut()" title="Uzaklaştır">－</button>
      <button class="chart-ctrl-btn" onclick="resetZoom()" title="Sıfırla">⊙</button>
      <button class="chart-ctrl-btn" id="fsBtn" onclick="toggleFullscreen()" title="Tam Ekran">⛶</button>
    </div>
  </div>
  <div class="chart-legend">
    <div class="leg-item"><div class="leg-dot" style="background:var(--sensor)"></div> Sensör</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--gap);border-top:2px dashed var(--gap);height:2px;"></div> Gap</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--manual)"></div> Elle Ölçüm</div>
    <div class="leg-item"><div class="leg-dot" style="background:var(--pred);border-top:2px dashed var(--pred);height:2px;"></div> MC-LSTM</div>
    <div class="leg-item"><div class="leg-dot" style="background:rgba(30,132,73,0.2);height:8px;"></div> %80 Bant</div>
    <span style="font-size:9px;color:var(--ink3);margin-left:auto;">↕ kaydır · pinch/scroll zoom</span>
  </div>
  <div id="chartWrap" style="position:relative;width:100%;height:360px;">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<!-- Progress -->
<div class="progress-wrap" id="progressWrap">
  <div class="progress-label" id="progressLabel">İşleniyor…</div>
  <div class="progress-bar-outer"><div class="progress-bar-inner" id="progressBar" style="width:0%"></div></div>
  <div class="progress-text" id="progressText">0%</div>
</div>

<!-- Results -->
<div class="results-grid" id="resultsGrid" style="display:none">
  <div class="result-card">
    <div class="rc-title">GAP ANALİZİ</div>
    <div id="gapResults"></div>
  </div>
  <div class="result-card">
    <div class="rc-title">MC-LSTM TAHMİN SONUÇLARI</div>
    <div id="lstmResults"><div style="color:var(--ink3);font-size:11px;">MC-LSTM henüz çalıştırılmadı.</div></div>
  </div>
</div>

<div class="result-card" id="probCard" style="display:none; margin-bottom:20px;">
  <div class="rc-title">OLASILIK TABLOSU — TAHMİN ADIMI BAŞINA</div>
  <div id="probTable"></div>
</div>

<div class="explanation" id="explanationBox" style="display:none">
  <strong>Yöntem Notu:</strong> Gap simülasyonu δ ∈ [-dMax, +dMax] kısıtlı Constrained Random Walk kullanır.
  Başlangıç ve bitiş noktaları sabit tutularak <strong id="expSimCount">5000</strong> yol üretilir,
  fiziksel olarak imkânsız olanlar (ulaşılamaz noktalar) elenir. Gösterilen bant geçerli yolların
  %10–%90 aralığıdır.<br><br>
  <strong>MC-Dropout LSTM:</strong> TensorFlow.js ile eğitilen küçük bir LSTM ağı, test zamanında dropout
  <em>açık</em> bırakılarak <strong id="expMCRep">200</strong> kez forward pass yapılır. Her pass farklı bir
  ağırlık maskesi demektir — bu yaklaşık Bayesian çıkarım verir. Median tahmin + %10/%90 bantları raporlanır.
</div>

</div>

<script>
// ======= STATE =======
let sensorY=[], manualY=[], gapPaths=[], lstmPredictions=[];
let mainChart = null;

// ======= UTILS =======
function parseInput(id) {
  return document.getElementById(id).value
    .split(/[\n,;]+/).map(v=>parseFloat(v.trim())).filter(v=>!isNaN(v));
}
function pct(arr, p) {
  const s=[...arr].sort((a,b)=>a-b);
  const i=Math.floor(p*(s.length-1));
  return s[i];
}
function linspace(a,b,n){return Array.from({length:n},(_,i)=>a+(b-a)*i/(n-1));}
function setProgress(pct,label='',text=''){
  document.getElementById('progressBar').style.width=pct+'%';
  document.getElementById('progressText').textContent=text||Math.round(pct)+'%';
  if(label) document.getElementById('progressLabel').textContent=label;
}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// ======= MANUAL ROW SY