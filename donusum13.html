<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Geli≈ümi≈ü Alan G√∂rselle≈ütirici V22</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: block; touch-action: none; }

        /* HUD - ≈ûeffaf ve Tƒ±klanabilir */
        #hud {
            position: fixed; top: 15px; left: 15px;
            background: rgba(0, 0, 0, 0.6);
            padding: 12px; border-radius: 10px;
            font-family: 'Courier New', monospace; font-size: 13px;
            border: 1px solid rgba(255,255,255,0.15);
            backdrop-filter: blur(5px); z-index: 100;
            max-width: 250px; cursor: pointer;
            transition: background 0.3s;
        }
        #hud:hover { background: rgba(30, 30, 30, 0.8); }
        #hud span { color: #00ffcc; font-weight: bold; }
        #hud .func-def { color: #ffcc00; font-size: 11px; display: block; margin-bottom: 2px; }
        #hud .equation-display { 
            color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; 
            font-style: italic; display: block; word-break: break-all; font-size: 12px;
        }

        /* Spectator (G√∂z) Butonu - 3 Kademeli */
        #spectatorBtn {
            position: fixed; top: 135px; left: 15px;
            width: 35px; height: 35px; border-radius: 50%;
            background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 102; font-size: 18px;
        }

        /* Kopyala/Yapƒ±≈ütƒ±r/Geri Butonlarƒ± */
        .mini-btn {
            position: fixed; top: 135px; width: 30px; height: 30px;
            border-radius: 50%; background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2); color: white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 102; font-size: 14px;
        }
        #copyBtn { left: 60px; }
        #pasteBtn { left: 100px; }
        #undoBtn { left: 140px; }

        .ui-panel {
            position: fixed; top: 15px; right: 15px;
            display: flex; flex-direction: column; gap: 10px; z-index: 101;
            align-items: flex-end;
        }

        .btn {
            background: rgba(40, 40, 40, 0.85); border: 1px solid rgba(255,255,255,0.25);
            color: white; width: 50px; height: 50px; border-radius: 12px;
            cursor: pointer; font-size: 20px; backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; font-weight: bold;
        }
        .btn.active { background: #007bff; border-color: #fff; }
        .btn.locked { background: #dc3545; border-color: #fff; }

        /* Slider Container - Multiple Columns */
        .slider-wrapper {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-bottom: 90px;
        }
        .s-slider-container {
            height: 45vh; width: 50px;
            background: rgba(40, 40, 40, 0.85);
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.25);
            display: flex; flex-direction: column; align-items: center;
            padding: 15px 0; gap: 5px;
        }
        .s-slider {
            -webkit-appearance: none; width: calc(45vh - 40px); height: 8px;
            background: #222; border-radius: 5px; transform: rotate(-90deg);
            margin-top: calc(22.5vh - 20px); cursor: pointer;
        }
        .s-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 25px; height: 25px;
            background: #00ffcc; border-radius: 50%; cursor: pointer; border: 2px solid white;
        }

        #settings, #s-config-popup, #summary-popup, #eq-popup, #json-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(10, 10, 10, 0.98); padding: 20px; border-radius: 20px;
            border: 1px solid #444; width: 90%; max-width: 480px;
            display: none; z-index: 1000; box-shadow: 0 20px 60px rgba(0,0,0,1);
            max-height: none; overflow-y: visible;
        }

        #eq-popup { z-index: 1001; }

        /* JSON Popup */
        #jsonTextarea {
            width: 100%; height: 300px; background: #000; border: 1px solid #444;
            color: #0f0; font-family: 'Courier New', monospace; font-size: 11px;
            padding: 10px; border-radius: 8px; resize: vertical;
        }

        /* Summary Styles */
        #summary-content { font-family: monospace; font-size: 11px; color: #ddd; line-height: 1.4; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        #summary-canvas { width: 100%; height: 200px; background: #000; margin-top: 15px; border: 1px solid #333; border-radius: 10px; }

        .left-bottom-btn { position: fixed; bottom: 15px; left: 15px; z-index: 101; display: flex; flex-direction: column; gap: 8px; align-items: flex-start; }
        .right-bottom-btn { position: fixed; bottom: 15px; right: 15px; z-index: 101; display:flex; flex-direction:column; align-items:flex-end; gap:5px; }

        #var-menu, #denklem-menu {
            display: none; background: rgba(30,30,30,0.95); border: 1px solid #555;
            border-radius: 10px; padding: 5px; margin-bottom: 5px;
        }
        #var-menu button, #denklem-menu button {
            display: block; width: 45px; height: 45px; margin: 4px;
            background: #222; border: 1px solid #444; color: white; border-radius: 8px; cursor: pointer;
        }

        .param-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .param-row input[type="number"] { flex: 1; background: #222; border: 1px solid #444; color: #0f0; padding: 8px; border-radius: 5px; font-size: 12px; }
        .param-row input[type="checkbox"] { width: 24px; height: 24px; cursor: pointer; flex-shrink: 0; }
        .param-row select { flex: 0 0 60px; background: #222; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 5px; font-size: 12px; }
        label { font-size: 12px; color: #aaa; min-width: 90px; }

        .var-grid { display: grid; grid-template-columns: 60px repeat(4, 1fr); gap: 8px; margin-bottom: 12px; background: #111; padding: 10px; border-radius: 8px;}
        .var-col { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .var-col input[type="checkbox"] { width: 24px; height: 24px; }
        .section-title { margin:12px 0 5px 0; color:#00ffcc; border-top:1px solid #333; padding-top:8px; font-size:13px; }
        
        input[type="text"] { width: 100%; background: #222; border: 1px solid #444; padding: 10px; color: #fff; border-radius: 8px; margin: 5px 0; box-sizing: border-box; }
        .apply-btn { width: 100%; background: #28a745; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; margin-top: 12px; cursor: pointer; }
        .save-load-btns { display: flex; gap: 10px; margin-bottom: 10px; }
        .save-btn { flex: 1; background: #007bff; color: white; border: none; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .load-btn { flex: 1; background: #dc3545; color: white; border: none; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        select { background: #222; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 8px; }

        .eq-input-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .eq-input-row label { min-width: 30px; font-weight: bold; color: #00ffcc; }
        .eq-input-row input { flex: 1; }

        /* Renk Grid - ƒ∞ki Kolon - Sadece ƒ∞sim */
        .color-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 8px;
        }
        .color-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .color-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .color-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .color-item label {
            min-width: 70px;
            font-size: 11px;
            color: #aaa;
        }
        .color-item input[type="number"] {
            width: 55px;
            background: #222;
            border: 1px solid #444;
            color: #0f0;
            padding: 4px;
            border-radius: 4px;
            font-size: 11px;
        }

        #colorModeBtn {
            width: 45px; height: 45px; border-radius: 50%;
            background: rgba(100,0,100,0.7); border: 1px solid rgba(255,255,255,0.3);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 10px; font-weight: bold;
        }

        #letterSelectBtn {
            width: 50px; height: 50px; border-radius: 12px;
            background: rgba(40, 40, 40, 0.85); border: 1px solid rgba(255,255,255,0.25);
            color: #ff00cc; font-weight: bold; font-size: 20px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Fonksiyon Popup Butonu */
        #eqPopupBtnInSettings {
            width: 40px; height: 40px; border-radius: 8px;
            background: rgba(0,100,200,0.8); border: 1px solid rgba(255,255,255,0.3);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 16px; font-weight: bold;
            flex-shrink: 0;
        }

        .eq-row-with-btn {
            display: flex; gap: 10px; align-items: center;
        }

        /* Popup backdrop */
        .popup-backdrop {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }

        /* Slider Assignment Label */
        .slider-label {
            font-size: 10px;
            color: #00ffcc;
            text-align: center;
            margin-top: -10px;
            font-weight: bold;
        }

        /* Variable Labels Container */
        .var-labels-container {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }
        .var-label-item {
            background: rgba(0, 100, 100, 0.6);
            border: 1px solid rgba(0, 255, 204, 0.4);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: bold;
            color: #00ffcc;
            min-width: 30px;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="popup-backdrop" id="popupBackdrop" onclick="closeAllPopups()"></div>

<div id="hud" onclick="showSummary()">
    <span class="func-def">f(x, y, s, p, d, f, a, b, c)</span>
    <span class="equation-display" id="eqDisplay">...</span>
    <div style="margin-top:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">
        X: <span id="curX">0.0</span> Y: <span id="curY">0.0</span><br>
        Val: <span id="curVal" style="color:#ff0055; font-size:14px;">0.000</span>
    </div>
    <div style="font-size: 10px; margin-top: 5px; color: #aaa;">
        S:<span id="valS">1.0</span> P:<span id="valP">1.0</span> D:<span id="valD">1.0</span> F:<span id="valF">1.0</span>
    </div>
</div>

<button id="spectatorBtn" onclick="toggleSpectator()">üëÅÔ∏è</button>
<button id="copyBtn" class="mini-btn" onclick="copyState()" title="Kopyala">üìã</button>
<button id="pasteBtn" class="mini-btn" onclick="pasteState()" title="Yapƒ±≈ütƒ±r">üì•</button>
<button id="undoBtn" class="mini-btn" onclick="undoState()" title="Geri">‚Ü©Ô∏è</button>

<div class="ui-panel ui-hideable">
    <button class="btn" onclick="toggleMenu()">‚öô</button>
    <button class="btn" onclick="manualZoom(1.4)">+</button>
    <button class="btn" onclick="manualZoom(0.7)">-</button>
    <button class="btn" id="targetBtn" onclick="toggleTargetMode()">üéØ</button>
    <button class="btn" id="masterLockBtn" onclick="toggleMasterLock()">üîí</button>
    <div class="slider-wrapper" id="sliderWrapper">
        <div class="s-slider-container">
            <span style="font-size: 10px; color: #888;">MAX</span>
            <input type="range" id="mainSlider0" class="s-slider" min="0" max="100" value="10" step="1" oninput="handleSliderChange(this.value, 0)">
            <span style="font-size: 10px; color: #888;">MIN</span>
            <div class="slider-label" id="sliderLabel0">S</div>
        </div>
    </div>
</div>

<div class="left-bottom-btn ui-hideable">
    <button id="colorModeBtn" onclick="toggleColorMode()">SOL</button>
    <div id="denklem-menu">
        <button onclick="selectDenklem('E')">E</button>
        <button onclick="selectDenklem('a')">a</button>
        <button onclick="selectDenklem('b')">b</button>
        <button onclick="selectDenklem('c')">c</button>
    </div>
    <button id="letterSelectBtn" onclick="toggleDenklemMenu()">E</button>
    <button class="btn" id="cfgBtn" onclick="toggleSConfig()">S Ayar</button>
</div>

<div class="right-bottom-btn ui-hideable">
    <div class="var-labels-container" id="varLabelsContainer">
        <div class="var-label-item">S</div>
    </div>
    <div id="var-menu">
        <button onclick="selectVariableForSlider('s')">S</button>
        <button onclick="selectVariableForSlider('p')">P</button>
        <button onclick="selectVariableForSlider('d')">D</button>
        <button onclick="selectVariableForSlider('f')">F</button>
    </div>
    <button class="btn" id="letterBtn" onclick="toggleVarMenu()" style="color:#00ffcc; border-color:#00ffcc">‚ñº</button>
</div>

<!-- EQUATION POPUP -->
<div id="eq-popup">
    <h3 style="margin:0 0 12px 0; border-bottom:1px solid #444; color:#00ffcc; font-size: 15px;">Ek Denklem Tanƒ±mlarƒ±</h3>
    <div class="eq-input-row">
        <label>a =</label>
        <input type="text" id="eqA" value="x*s + y*p" placeholder="Denklem a">
    </div>
    <div class="eq-input-row">
        <label>b =</label>
        <input type="text" id="eqB" value="sqrt(x^2 + y^2)" placeholder="Denklem b">
    </div>
    <div class="eq-input-row">
        <label>c =</label>
        <input type="text" id="eqC" value="atan2(y, x)" placeholder="Denklem c">
    </div>
    <button class="apply-btn" onclick="applyEqDefinitions()">UYGULA</button>
</div>

<!-- JSON POPUP -->
<div id="json-popup">
    <h3 style="margin:0 0 12px 0; border-bottom:1px solid #444; color:#00ffcc; font-size: 15px;">JSON Y√∂netimi</h3>
    <textarea id="jsonTextarea"></textarea>
    <div class="save-load-btns" style="margin-top:12px;">
        <button class="save-btn" onclick="copyJsonToClipboard()">üìã Kopyala</button>
        <button class="load-btn" onclick="loadJsonFromText()">üì• JSON Y√ºkle</button>
    </div>
    <button class="apply-btn" onclick="closePopup('json-popup')">KAPAT</button>
</div>

<!-- SUMMARY POPUP -->
<div id="summary-popup">
    <h3 style="margin:0 0 12px 0; border-bottom:1px solid #444; color:#00ffcc; font-size: 15px;">Sistem √ñzeti</h3>
    <div class="save-load-btns">
        <button class="save-btn" onclick="saveConfig()">üíæ ƒ∞ndir</button>
        <button class="load-btn" onclick="showJsonPopup()">üìù JSON</button>
    </div>
    <div id="summary-content"></div>
    <canvas id="summary-canvas" width="400" height="400"></canvas>
    <button class="apply-btn" onclick="closePopup('summary-popup')">KAPAT</button>
</div>

<!-- VARIABLE CONFIG POPUP -->
<div id="s-config-popup">
    <h3 style="margin:0 0 10px 0; border-bottom:1px solid #333; font-size: 15px;">Deƒüi≈üken Y√∂netimi</h3>
    <div class="var-grid">
        <div class="var-col">
            <label style="font-size:10px;">Sayƒ±</label>
            <select id="varCount" onchange="updateVarCount()">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
            </select>
        </div>
        <div class="var-col"><label>S</label><input type="checkbox" id="en_s" checked onchange="updateVarEnables()"></div>
        <div class="var-col"><label>P</label><input type="checkbox" id="en_p" checked onchange="updateVarEnables()"></div>
        <div class="var-col"><label>D</label><input type="checkbox" id="en_d" checked onchange="updateVarEnables()"></div>
        <div class="var-col"><label>F</label><input type="checkbox" id="en_f" checked onchange="updateVarEnables()"></div>
    </div>
    
    <div class="section-title">Ayar: <span id="cfgTitle">S</span></div>
    <div class="param-row"><label>Maksimum:</label><input type="number" id="vMax" value="10" step="0.1"></div>
    <div class="param-row"><label>Sabit Deƒüer:</label><input type="number" id="vCurrent" step="0.1"></div>
    <div class="param-row"><label>Minimum:</label><input type="number" id="vMin" value="0" step="0.1"></div>
    <div class="param-row"><label>Adƒ±m (Step):</label><input type="number" id="vStep" value="0.1" step="0.001"></div>

    <div class="section-title">Hedef Sabitle</div>
    <div class="param-row">
        <input type="checkbox" id="fixedTargetEnable">
        <label style="min-width:auto; margin-right:5px;">Aktif</label>
        <input type="number" id="fTargetX" placeholder="X" step="0.1">
        <input type="number" id="fTargetY" placeholder="Y" step="0.1">
    </div>

    <button class="apply-btn" onclick="applyVarConfig()">KAYDET</button>
</div>

<!-- MAIN SETTINGS -->
<div id="settings">
    <h3 style="margin:0 0 10px 0; border-bottom:1px solid #333; font-size: 15px;">G√∂rsel Ayarlar</h3>
    <label style="font-size: 12px;">Ana Denklem E(x, y, s, p, d, f, a, b, c):</label>
    <div class="eq-row-with-btn">
        <button id="eqPopupBtnInSettings" onclick="toggleEqPopup()">fx</button>
        <input type="text" id="eqInput" value="sin(sqrt(x^2 + y^2) * s) * cos(atan2(y,x) * p * 3)" style="margin:0;">
    </div>
    
    <div class="section-title">Renk Parametreleri</div>
    <div class="color-grid">
        <div class="color-column">
            <div class="color-item">
                <input type="checkbox" id="en_i3_left">
                <input type="checkbox" id="mark_i3_left">
                <label>Siyah</label>
                <input type="number" id="i3_left" value="-2" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_i2_left" checked>
                <input type="checkbox" id="mark_i2_left">
                <label>K.Kƒ±rmƒ±zƒ±</label>
                <input type="number" id="i2_left" value="-1" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_i1_left" checked>
                <input type="checkbox" id="mark_i1_left">
                <label>Sarƒ±</label>
                <input type="number" id="i1_left" value="-0.3" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h0_left" checked>
                <input type="checkbox" id="mark_h0_left" checked>
                <label>Ye≈üil</label>
                <input type="number" id="h0_left" value="0" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h1_left" checked>
                <input type="checkbox" id="mark_h1_left">
                <label>Mavi</label>
                <input type="number" id="h1_left" value="0.4" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h2_left" checked>
                <input type="checkbox" id="mark_h2_left">
                <label>Mor</label>
                <input type="number" id="h2_left" value="0.8" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h3_left">
                <input type="checkbox" id="mark_h3_left">
                <label>Siyah</label>
                <input type="number" id="h3_left" value="1.2" step="0.1">
            </div>
        </div>
        <div class="color-column">
            <div class="color-item">
                <input type="checkbox" id="en_i3_right">
                <input type="checkbox" id="mark_i3_right">
                <label>Siyah</label>
                <input type="number" id="i3_right" value="-1" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_i2_right">
                <input type="checkbox" id="mark_i2_right">
                <label>K.Kƒ±rmƒ±zƒ±</label>
                <input type="number" id="i2_right" value="0" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_i1_right">
                <input type="checkbox" id="mark_i1_right">
                <label>Sarƒ±</label>
                <input type="number" id="i1_right" value="0.5" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h0_right">
                <input type="checkbox" id="mark_h0_right">
                <label>Ye≈üil</label>
                <input type="number" id="h0_right" value="1" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h1_right">
                <input type="checkbox" id="mark_h1_right">
                <label>Mavi</label>
                <input type="number" id="h1_right" value="1.5" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h2_right">
                <input type="checkbox" id="mark_h2_right">
                <label>Mor</label>
                <input type="number" id="h2_right" value="2" step="0.1">
            </div>
            <div class="color-item">
                <input type="checkbox" id="en_h3_right">
                <input type="checkbox" id="mark_h3_right">
                <label>Siyah</label>
                <input type="number" id="h3_right" value="2.5" step="0.1">
            </div>
        </div>
    </div>

    <div class="section-title">Maskeleme</div>
    <div class="param-row">
        <input type="checkbox" id="boxEnable"><label>Aktif</label>
        <select id="maskType"><option value="rect">Kare</option><option value="circle">Daire</option><option value="diamond">Elmas</option></select>
        <select id="maskStyle"><option value="dashed">Kesikli</option><option value="solid">D√ºz</option><option value="grid">Izgara</option><option value="blackout">Karart</option></select>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
        <input type="number" id="bx1" value="-3" style="padding: 6px;">
        <input type="number" id="bx2" value="3" style="padding: 6px;">
        <input type="number" id="by1" value="-3" style="padding: 6px;">
        <input type="number" id="by2" value="3" style="padding: 6px;">
    </div>
    <button class="apply-btn" onclick="applySettings()">UYGULA</button>
</div>

<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    
    let sliderAssignments = ['s', 'p', 'd', 'f'];
    let currentSliderSelectIndex = 0;
    let activeDenklemLetter = 'E';
    let currentGraph = 1;
    let colorMode = 'left';
    const letters = ['s', 'p', 'd', 'f'];
    const denklemLetters = ['E', 'a', 'b', 'c'];
    let isSpectator = 0;
    let varSliderCount = 1;

    let clipboard = null;
    let beforePaste = null;

    let config = { 
        eq: "sin(sqrt(x^2 + y^2) * s) * cos(atan2(y,x) * p * 3)", 
        eqA: "x*s + y*p",
        eqB: "sqrt(x^2 + y^2)",
        eqC: "atan2(y, x)",
        colorOrigin: { x: 0, y: 0 },
        vars: {
            s: { val: 2.0, min: 0, max: 10, step: 0.1, enabled: true },
            p: { val: 3.0, min: 0, max: 10, step: 0.1, enabled: true },
            d: { val: 1.0, min: 0, max: 10, step: 0.1, enabled: true },
            f: { val: 1.5, min: 0, max: 10, step: 0.1, enabled: true }
        },
        paramsLeft: {
            i3: { val: -2, en: false, marker: false, color: [0, 0, 0] },
            i2: { val: -1,  en: true, marker: false, color: [130, 0, 0] },
            i1: { val: -0.3, en: true, marker: false, color: [255, 255, 0] },
            h0: { val: 0,  en: true, marker: true, color: [0, 255, 0] },
            h1: { val: 0.4, en: true, marker: false, color: [0, 0, 255] },
            h2: { val: 0.8,  en: true, marker: false, color: [150, 0, 255] },
            h3: { val: 1.2, en: false, marker: false, color: [0, 0, 0] }
        },
        paramsRight: {
            i3: { val: -1, en: false, marker: false, color: [0, 0, 0] },
            i2: { val: 0,  en: false, marker: false, color: [130, 0, 0] },
            i1: { val: 0.5, en: false, marker: false, color: [255, 255, 0] },
            h0: { val: 1,  en: false, marker: false, color: [0, 255, 0] },
            h1: { val: 1.5, en: false, marker: false, color: [0, 0, 255] },
            h2: { val: 2,  en: false, marker: false, color: [150, 0, 255] },
            h3: { val: 2.5, en: false, marker: false, color: [0, 0, 0] }
        },
        box: { enabled: false, type: 'rect', style: 'grid', x1: -3, x2: 3, y1: -3, y2: 3 },
        fixedTarget: { enabled: false, x: 0, y: 0 }
    };

    let config2 = JSON.parse(JSON.stringify(config));
    
    let view = { x: 0, y: 0, zoom: 40, isMoving: false, isTargetMode: false, isMasterLocked: false, target: { x: 0, y: 0 } };
    let compiledEq = math.compile(config.eq);
    let compiledEqA = math.compile(config.eqA);
    let compiledEqB = math.compile(config.eqB);
    let compiledEqC = math.compile(config.eqC);
    let renderTimer;

    function getActiveConfig() { return currentGraph === 1 ? config : config2; }
    function getActiveParams() { const cfg = getActiveConfig(); return colorMode === 'left' ? cfg.paramsLeft : cfg.paramsRight; }
    function interpolate(c1, c2, t) { return [Math.floor(c1[0]+(c2[0]-c1[0])*t), Math.floor(c1[1]+(c2[1]-c1[1])*t), Math.floor(c1[2]+(c2[2]-c1[2])*t)]; }

    function getRGB(val) {
        const p = getActiveParams();
        const keys = ['i3', 'i2', 'i1', 'h0', 'h1', 'h2', 'h3'];
        for (let j = 0; j < keys.length - 1; j++) {
            const k1 = keys[j], k2 = keys[j+1];
            if (p[k1].en && p[k2].en) {
                if (val >= p[k1].val && val <= p[k2].val) {
                    const t = (val - p[k1].val) / (p[k2].val - p[k1].val);
                    return interpolate(p[k1].color, p[k2].color, t);
                }
            }
        }
        return [0, 0, 0];
    }

    function getCompiledDenklem() {
        if (activeDenklemLetter === 'E') return compiledEq;
        if (activeDenklemLetter === 'a') return compiledEqA;
        if (activeDenklemLetter === 'b') return compiledEqB;
        if (activeDenklemLetter === 'c') return compiledEqC;
        return compiledEq;
    }

    function updateVarLabels() {
        const container = document.getElementById('varLabelsContainer');
        container.innerHTML = '';
        for (let i = 0; i < varSliderCount; i++) {
            const label = document.createElement('div');
            label.className = 'var-label-item';
            label.textContent = sliderAssignments[i].toUpperCase();
            container.appendChild(label);
        }
    }

    function render(step = 2) {
        const w = canvas.width, h = canvas.height, z = view.zoom;
        const cfg = getActiveConfig();
        const scope = { s: cfg.vars.s.val, p: cfg.vars.p.val, d: cfg.vars.d.val, f: cfg.vars.f.val };
        const b = cfg.box;

        try {
            scope.a = compiledEqA.evaluate(scope);
            scope.b = compiledEqB.evaluate(scope);
            scope.c = compiledEqC.evaluate(scope);
        } catch(e) {
            scope.a = 0; scope.b = 0; scope.c = 0;
        }

        const currentCompiled = getCompiledDenklem();

        for (let px = 0; px < w; px += step) {
            for (let py = 0; py < h; py += step) {
                const wx = (px - w / 2) / z + view.x;
                const wy = -(py - h / 2) / z + view.y;

                if (b.enabled && b.style === 'blackout') {
                    let inside = false;
                    if (b.type === 'rect') { if (wx >= b.x1 && wx <= b.x2 && wy >= b.y1 && wy <= b.y2) inside = true; }
                    else if (b.type === 'circle') { if (Math.hypot(wx, wy) <= Math.abs(b.x1)) inside = true; }
                    else if (b.type === 'diamond') { if (Math.abs(wx) + Math.abs(wy) <= Math.abs(b.x1)) inside = true; }
                    if (!inside) { ctx.fillStyle = "#000"; ctx.fillRect(px, py, step, step); continue; }
                }

                try {
                    scope.x = wx - cfg.colorOrigin.x; scope.y = wy - cfg.colorOrigin.y;
                    const val = currentCompiled.evaluate(scope);
                    const [r, g, bc] = getRGB(val);
                    ctx.fillStyle = `rgb(${r},${g},${bc})`;
                    ctx.fillRect(px, py, step, step);
                } catch(e) { ctx.fillStyle = "#000"; ctx.fillRect(px, py, step, step); }
            }
        }
        drawUIOverlay();
        updateHUD();
    }

    function closeAllPopups() {
        ['settings', 'summary-popup', 'json-popup', 's-config-popup'].forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        document.getElementById('popupBackdrop').style.display = 'none';
    }

    function showPopup(id) {
        closeAllPopups();
        document.getElementById(id).style.display = 'block';
        document.getElementById('popupBackdrop').style.display = 'block';
    }

    function closePopup(id) {
        document.getElementById(id).style.display = 'none';
        document.getElementById('popupBackdrop').style.display = 'none';
    }

    function toggleSpectator() {
        isSpectator = (isSpectator + 1) % 3;
        const els = document.querySelectorAll('.ui-hideable, #hud, #copyBtn, #pasteBtn, #undoBtn');
        if (isSpectator === 0) {
            els.forEach(el => { el.style.display = ''; el.style.opacity = '1'; });
        } else if (isSpectator === 1) {
            els.forEach(el => { el.style.display = ''; el.style.opacity = '0.3'; });
        } else {
            els.forEach(el => el.style.display = 'none');
        }
        document.getElementById('spectatorBtn').style.opacity = isSpectator === 2 ? "0.3" : "1";
    }

    function toggleDenklemMenu() {
        const m = document.getElementById('denklem-menu');
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    function selectDenklem(letter) {
        activeDenklemLetter = letter;
        document.getElementById('letterSelectBtn').innerText = letter;
        document.getElementById('denklem-menu').style.display = 'none';
        render(2);
    }

    function toggleColorMode() {
        colorMode = colorMode === 'left' ? 'right' : 'left';
        document.getElementById('colorModeBtn').innerText = colorMode === 'left' ? 'SOL' : 'SAƒû';
        render(2);
    }

    function toggleVarMenu() { 
        const m = document.getElementById('var-menu');
        if (m.style.display === 'block') {
            m.style.display = 'none';
        } else {
            currentSliderSelectIndex = 0;
            m.style.display = 'block';
        }
    }
    
    function selectVariableForSlider(char) {
        if (currentSliderSelectIndex < varSliderCount) {
            sliderAssignments[currentSliderSelectIndex] = char;
            document.getElementById('sliderLabel' + currentSliderSelectIndex).innerText = char.toUpperCase();
            
            const v = getActiveConfig().vars[char];
            const slider = document.getElementById('mainSlider' + currentSliderSelectIndex);
            if (slider) {
                slider.value = ((v.val - v.min) / (v.max - v.min)) * 100;
            }
            
            currentSliderSelectIndex = (currentSliderSelectIndex + 1) % varSliderCount;
            
            if (currentSliderSelectIndex === 0) {
                document.getElementById('var-menu').style.display = 'none';
            }
        }
        
        updateVarLabels();
        render(2);
    }

    function handleSliderChange(sliderVal, index) {
        const varChar = sliderAssignments[index];
        const v = getActiveConfig().vars[varChar];
        if (!v.enabled) return;
        let rawVal = v.min + (v.max - v.min) * (sliderVal / 100);
        if (v.step > 0) rawVal = Math.round(rawVal / v.step) * v.step;
        v.val = rawVal;
        startMoving();
    }

    function updateVarCount() {
        const count = parseInt(document.getElementById('varCount').value);
        varSliderCount = count;
        const wrapper = document.getElementById('sliderWrapper');
        wrapper.innerHTML = '';
        
        for (let i = 0; i < count; i++) {
            if (!sliderAssignments[i]) sliderAssignments[i] = letters[i];
            const container = document.createElement('div');
            container.className = 's-slider-container';
            const v = getActiveConfig().vars[sliderAssignments[i]];
            const sliderVal = ((v.val - v.min) / (v.max - v.min)) * 100;
            container.innerHTML = `
                <span style="font-size: 10px; color: #888;">MAX</span>
                <input type="range" id="mainSlider${i}" class="s-slider" min="0" max="100" value="${sliderVal}" step="1" oninput="handleSliderChange(this.value, ${i})">
                <span style="font-size: 10px; color: #888;">MIN</span>
                <div class="slider-label" id="sliderLabel${i}">${sliderAssignments[i].toUpperCase()}</div>
            `;
            wrapper.appendChild(container);
        }
        updateVarLabels();
    }

    function toggleSConfig() {
        if (document.getElementById('s-config-popup').style.display === 'block') {
            closePopup('s-config-popup');
            return;
        }
        showPopup('s-config-popup');
        const varChar = sliderAssignments[0];
        document.getElementById('cfgBtn').innerText = varChar.toUpperCase() + " Ayar";
        document.getElementById('cfgTitle').innerText = varChar.toUpperCase();
        letters.forEach(l => document.getElementById('en_' + l).checked = getActiveConfig().vars[l].enabled);
        const v = getActiveConfig().vars[varChar];
        document.getElementById('vCurrent').value = v.val;
        document.getElementById('vMin').value = v.min;
        document.getElementById('vMax').value = v.max;
        document.getElementById('vStep').value = v.step;
        document.getElementById('varCount').value = varSliderCount;

        const cfg = getActiveConfig();
        document.getElementById('fixedTargetEnable').checked = cfg.fixedTarget.enabled;
        document.getElementById('fTargetX').value = cfg.fixedTarget.x;
        document.getElementById('fTargetY').value = cfg.fixedTarget.y;
    }

    function updateVarEnables() { 
        letters.forEach(l => getActiveConfig().vars[l].enabled = document.getElementById('en_' + l).checked); 
    }

    function applyVarConfig() {
        const varChar = sliderAssignments[0];
        const v = getActiveConfig().vars[varChar];
        v.val = parseFloat(document.getElementById('vCurrent').value);
        v.min = parseFloat(document.getElementById('vMin').value);
        v.max = parseFloat(document.getElementById('vMax').value);
        v.step = parseFloat(document.getElementById('vStep').value);

        const cfg = getActiveConfig();
        cfg.fixedTarget.enabled = document.getElementById('fixedTargetEnable').checked;
        cfg.fixedTarget.x = parseFloat(document.getElementById('fTargetX').value) || 0;
        cfg.fixedTarget.y = parseFloat(document.getElementById('fTargetY').value) || 0;

        if (cfg.fixedTarget.enabled) {
            view.target.x = cfg.fixedTarget.x;
            view.target.y = cfg.fixedTarget.y;
        }

        closePopup('s-config-popup');
        render(2);
    }

    function toggleEqPopup() {
        const p = document.getElementById('eq-popup');
        const cfg = getActiveConfig();
        document.getElementById('eqA').value = cfg.eqA;
        document.getElementById('eqB').value = cfg.eqB;
        document.getElementById('eqC').value = cfg.eqC;
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    function applyEqDefinitions() {
        const cfg = getActiveConfig();
        cfg.eqA = document.getElementById('eqA').value;
        cfg.eqB = document.getElementById('eqB').value;
        cfg.eqC = document.getElementById('eqC').value;
        try {
            compiledEqA = math.compile(cfg.eqA);
            compiledEqB = math.compile(cfg.eqB);
            compiledEqC = math.compile(cfg.eqC);
        } catch(e) {
            alert('Denklem hatasƒ±: ' + e.message);
        }
        document.getElementById('eq-popup').style.display = 'none';
        render(2);
    }

    function showSummary() {
        const cont = document.getElementById('summary-content');
        const cfg = getActiveConfig();
        let html = `<b>Grafik:</b> ${currentGraph}<br><b>Renk Modu:</b> ${colorMode === 'left' ? 'Sol' : 'Saƒü'}<br><b>Ana Denklem (E):</b> ${cfg.eq}<br><b>a:</b> ${cfg.eqA}<br><b>b:</b> ${cfg.eqB}<br><b>c:</b> ${cfg.eqC}<br><br>`;
        letters.forEach(l => {
            const v = cfg.vars[l];
            html += `<b>${l.toUpperCase()}:</b> ${v.val.toFixed(3)} (Min: ${v.min}, Max: ${v.max}, Aktif: ${v.enabled})<br>`;
        });
        html += `<div class="summary-grid"><div><b>Maske:</b> ${cfg.box.type} (${cfg.box.style})<br><b>Alan:</b> [${cfg.box.x1}, ${cfg.box.x2}] x [${cfg.box.y1}, ${cfg.box.y2}]</div>`;
        html += `<div><b>Hedef:</b> X:${view.target.x.toFixed(2)}, Y:${view.target.y.toFixed(2)}<br><b>Sabit:</b> ${cfg.fixedTarget.enabled ? 'Evet' : 'Hayƒ±r'}<br><b>Renk Merk:</b> X:${cfg.colorOrigin.x}, Y:${cfg.colorOrigin.y}</div></div>`;
        cont.innerHTML = html;
        showPopup('summary-popup');
        renderMiniMap();
    }

    function renderMiniMap() {
        const mCanvas = document.getElementById('summary-canvas');
        const mCtx = mCanvas.getContext('2d');
        const res = 200; 
        const step = mCanvas.width / res;
        const cfg = getActiveConfig();
        const scope = { s: cfg.vars.s.val, p: cfg.vars.p.val, d: cfg.vars.d.val, f: cfg.vars.f.val };

        try {
            scope.a = compiledEqA.evaluate(scope);
            scope.b = compiledEqB.evaluate(scope);
            scope.c = compiledEqC.evaluate(scope);
        } catch(e) {
            scope.a = 0; scope.b = 0; scope.c = 0;
        }

        const currentCompiled = getCompiledDenklem();

        for(let i=0; i<res; i++) {
            for(let j=0; j<res; j++) {
                const wx = (i/res)*200 - 100;
                const wy = 100 - (j/res)*200;
                scope.x = wx - cfg.colorOrigin.x; scope.y = wy - cfg.colorOrigin.y;
                try {
                    const val = currentCompiled.evaluate(scope);
                    const [r,g,b] = getRGB(val);
                    mCtx.fillStyle = `rgb(${r},${g},${b})`;
                    mCtx.fillRect(i*step, j*step, step, step);
                } catch(e) { mCtx.fillStyle = "#000"; mCtx.fillRect(i*step, j*step, step, step); }
            }
        }

        const b = cfg.box;
        if (b.enabled) {
            const scale = mCanvas.width / 200;
            const x1 = (b.x1 + 100) * scale, y1 = (100 - b.y1) * scale;
            const x2 = (b.x2 + 100) * scale, y2 = (100 - b.y2) * scale;
            mCtx.strokeStyle = "white"; mCtx.lineWidth = 2;
            if (b.type === 'rect') {
                mCtx.strokeRect(Math.min(x1,x2), Math.min(y1,y2), Math.abs(x2-x1), Math.abs(y2-y1));
            }
        }

        const tx = (view.target.x + 100) * (mCanvas.width / 200);
        const ty = (100 - view.target.y) * (mCanvas.height / 200);
        mCtx.beginPath(); mCtx.arc(tx, ty, 4, 0, Math.PI*2); mCtx.fillStyle="white"; mCtx.fill();
        mCtx.strokeStyle="black"; mCtx.stroke();
    }

    function showJsonPopup() {
        const data = {
            graph1: config,
            graph2: config2,
            currentGraph: currentGraph,
            view: view,
            sliderAssignments: sliderAssignments,
            activeDenklemLetter: activeDenklemLetter,
            varSliderCount: varSliderCount,
            colorMode: colorMode
        };
        document.getElementById('jsonTextarea').value = JSON.stringify(data, null, 2);
        showPopup('json-popup');
    }

    function copyJsonToClipboard() {
        const textarea = document.getElementById('jsonTextarea');
        textarea.select();
        document.execCommand('copy');
        alert('JSON panoya kopyalandƒ±!');
    }

    function loadJsonFromText() {
        try {
            const json = document.getElementById('jsonTextarea').value;
            const data = JSON.parse(json);
            config = data.graph1;
            config2 = data.graph2;
            currentGraph = data.currentGraph;
            view = data.view;
            sliderAssignments = data.sliderAssignments || ['s', 'p', 'd', 'f'];
            activeDenklemLetter = data.activeDenklemLetter;
            varSliderCount = data.varSliderCount || 1;
            colorMode = data.colorMode || 'left';
            
            compiledEq = math.compile(config.eq);
            compiledEqA = math.compile(config.eqA);
            compiledEqB = math.compile(config.eqB);
            compiledEqC = math.compile(config.eqC);
            
            updateVarCount();
            document.getElementById('letterSelectBtn').innerText = activeDenklemLetter;
            document.getElementById('colorModeBtn').innerText = colorMode === 'left' ? 'SOL' : 'SAƒû';
            render(2);
            closePopup('json-popup');
            alert('JSON ba≈üarƒ±yla y√ºklendi!');
        } catch(e) {
            alert('JSON Hatasƒ±: ' + e.message);
        }
    }

    function saveConfig() {
        const data = {
            graph1: config,
            graph2: config2,
            currentGraph: currentGraph,
            view: view,
            sliderAssignments: sliderAssignments,
            activeDenklemLetter: activeDenklemLetter,
            varSliderCount: varSliderCount,
            colorMode: colorMode
        };
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'field_config_' + Date.now() + '.json';
        a.click();
        alert('Ayarlar indirildi!');
    }

    function copyState() {
        clipboard = {
            graph1: JSON.parse(JSON.stringify(config)),
            graph2: JSON.parse(JSON.stringify(config2)),
            currentGraph: currentGraph,
            sliderAssignments: [...sliderAssignments],
            activeDenklemLetter: activeDenklemLetter,
            colorMode: colorMode
        };
        alert('Durum kopyalandƒ±!');
    }

    function pasteState() {
        if (!clipboard) {
            alert('Kopyalanmƒ±≈ü durum yok!');
            return;
        }
        beforePaste = {
            graph1: JSON.parse(JSON.stringify(config)),
            graph2: JSON.parse(JSON.stringify(config2)),
            currentGraph: currentGraph,
            sliderAssignments: [...sliderAssignments],
            activeDenklemLetter: activeDenklemLetter,
            colorMode: colorMode
        };
        config = JSON.parse(JSON.stringify(clipboard.graph1));
        config2 = JSON.parse(JSON.stringify(clipboard.graph2));
        currentGraph = clipboard.currentGraph;
        sliderAssignments = [...clipboard.sliderAssignments];
        activeDenklemLetter = clipboard.activeDenklemLetter;
        colorMode = clipboard.colorMode;
        
        compiledEq = math.compile(config.eq);
        compiledEqA = math.compile(config.eqA);
        compiledEqB = math.compile(config.eqB);
        compiledEqC = math.compile(config.eqC);
        
        updateVarCount();
        document.getElementById('letterSelectBtn').innerText = activeDenklemLetter;
        document.getElementById('colorModeBtn').innerText = colorMode === 'left' ? 'SOL' : 'SAƒû';
        render(2);
        alert('Durum yapƒ±≈ütƒ±rƒ±ldƒ±!');
    }

    function undoState() {
        if (!beforePaste) {
            alert('Geri alƒ±nacak durum yok!');
            return;
        }
        config = JSON.parse(JSON.stringify(beforePaste.graph1));
        config2 = JSON.parse(JSON.stringify(beforePaste.graph2));
        currentGraph = beforePaste.currentGraph;
        sliderAssignments = [...beforePaste.sliderAssignments];
        activeDenklemLetter = beforePaste.activeDenklemLetter;
        colorMode = beforePaste.colorMode;
        
        compiledEq = math.compile(config.eq);
        compiledEqA = math.compile(config.eqA);
        compiledEqB = math.compile(config.eqB);
        compiledEqC = math.compile(config.eqC);
        
        updateVarCount();
        document.getElementById('letterSelectBtn').innerText = activeDenklemLetter;
        document.getElementById('colorModeBtn').innerText = colorMode === 'left' ? 'SOL' : 'SAƒû';
        beforePaste = null;
        render(2);
        alert('Geri alƒ±ndƒ±!');
    }

    function drawUIOverlay() {
        const w = canvas.width, h = canvas.height, z = view.zoom;
        const cfg = getActiveConfig();
        const b = cfg.box;
        
        if (b.enabled && b.style !== 'blackout') {
            const x1 = (b.x1 - view.x) * z + w / 2, y1 = -(b.y1 - view.y) * z + h / 2;
            const x2 = (b.x2 - view.x) * z + w / 2, y2 = -(b.y2 - view.y) * z + h / 2;
            ctx.strokeStyle = "rgba(255,255,255,0.7)"; ctx.lineWidth = 2;
            if (b.type === 'rect') {
                const rx = Math.min(x1, x2), ry = Math.min(y1, y2), rw = Math.abs(x2-x1), rh = Math.abs(y2-y1);
                if (b.style === 'grid') {
                    ctx.save(); ctx.beginPath(); ctx.rect(rx,ry,rw,rh); ctx.clip();
                    ctx.strokeStyle = "rgba(255,255,255,0.2)";
                    for(let i=Math.floor(view.x-w/z); i<=Math.ceil(view.x+w/z); i++) {
                        let sx = (i-view.x)*z+w/2; ctx.beginPath(); ctx.moveTo(sx,0); ctx.lineTo(sx,h); ctx.stroke();
                    }
                    for(let i=Math.floor(view.y-h/z); i<=Math.ceil(view.y+h/z); i++) {
                        let sy = -(i-view.y)*z+h/2; ctx.beginPath(); ctx.moveTo(0,sy); ctx.lineTo(w,sy); ctx.stroke();
                    }
                    ctx.restore();
                }
                if (b.style === 'dashed') ctx.setLineDash([8,6]);
                ctx.strokeRect(rx, ry, rw, rh);
            }
            ctx.setLineDash([]);
        }

        // Contour lines - D√ºz √ßizgiler
        const p = getActiveParams();
        const scope = { s: cfg.vars.s.val, p: cfg.vars.p.val, d: cfg.vars.d.val, f: cfg.vars.f.val };
        try {
            scope.a = compiledEqA.evaluate(scope);
            scope.b = compiledEqB.evaluate(scope);
            scope.c = compiledEqC.evaluate(scope);
        } catch(e) {}

        const currentCompiled = getCompiledDenklem();
        const keys = ['i3', 'i2', 'i1', 'h0', 'h1', 'h2', 'h3'];
        
        keys.forEach(k => {
            if (p[k].marker && p[k].en) {
                const targetVal = p[k].val;
                ctx.strokeStyle = "rgba(255,255,255,0.9)";
                ctx.lineWidth = 2;
                
                // Marching squares algorithm for contour lines
                const gridRes = 100;
                const stepX = w / gridRes;
                const stepY = h / gridRes;
                
                for (let i = 0; i < gridRes; i++) {
                    for (let j = 0; j < gridRes; j++) {
                        const px1 = i * stepX;
                        const py1 = j * stepY;
                        const px2 = (i + 1) * stepX;
                        const py2 = (j + 1) * stepY;
                        
                        const corners = [
                            [px1, py1], [px2, py1], [px2, py2], [px1, py2]
                        ];
                        
                        const values = corners.map(([px, py]) => {
                            const wx = (px - w/2) / z + view.x;
                            const wy = -(py - h/2) / z + view.y;
                            scope.x = wx - cfg.colorOrigin.x;
                            scope.y = wy - cfg.colorOrigin.y;
                            try {
                                return currentCompiled.evaluate(scope);
                            } catch(e) {
                                return 0;
                            }
                        });
                        
                        // Check if contour passes through this cell
                        const minVal = Math.min(...values);
                        const maxVal = Math.max(...values);
                        
                        if (targetVal >= minVal && targetVal <= maxVal && maxVal - minVal > 0.01) {
                            // Linear interpolation to find edge crossings
                            const edges = [];
                            for (let e = 0; e < 4; e++) {
                                const v1 = values[e];
                                const v2 = values[(e + 1) % 4];
                                if ((v1 - targetVal) * (v2 - targetVal) < 0) {
                                    const t = (targetVal - v1) / (v2 - v1);
                                    const p1 = corners[e];
                                    const p2 = corners[(e + 1) % 4];
                                    edges.push([
                                        p1[0] + t * (p2[0] - p1[0]),
                                        p1[1] + t * (p2[1] - p1[1])
                                    ]);
                                }
                            }
                            
                            if (edges.length >= 2) {
                                ctx.beginPath();
                                ctx.moveTo(edges[0][0], edges[0][1]);
                                ctx.lineTo(edges[1][0], edges[1][1]);
                                ctx.stroke();
                            }
                        }
                    }
                }
            }
        });

        let tx = (view.isTargetMode || cfg.fixedTarget.enabled) ? (view.target.x - view.x) * z + w / 2 : w/2;
        let ty = (view.isTargetMode || cfg.fixedTarget.enabled) ? -(view.target.y - view.y) * z + h / 2 : h/2;
        ctx.beginPath(); ctx.arc(tx, ty, 5, 0, Math.PI*2); ctx.fillStyle="white"; ctx.fill();
        ctx.strokeStyle="black"; ctx.lineWidth = 2; ctx.stroke();
    }

    function updateHUD() {
        const cfg = getActiveConfig();
        const denklemMap = { 'E': cfg.eq, 'a': cfg.eqA, 'b': cfg.eqB, 'c': cfg.eqC };
        document.getElementById('eqDisplay').innerText = denklemMap[activeDenklemLetter];
        ['s','p','d','f'].forEach(l => document.getElementById('val'+l.toUpperCase()).innerText = cfg.vars[l].val.toFixed(2));
        let cx = (view.isTargetMode || cfg.fixedTarget.enabled) ? view.target.x : view.x;
        let cy = (view.isTargetMode || cfg.fixedTarget.enabled) ? view.target.y : view.y;
        document.getElementById('curX').innerText = cx.toFixed(2);
        document.getElementById('curY').innerText = cy.toFixed(2);
        try {
            const scope = {x:cx-cfg.colorOrigin.x, y:cy-cfg.colorOrigin.y, s:cfg.vars.s.val, p:cfg.vars.p.val, d:cfg.vars.d.val, f:cfg.vars.f.val};
            scope.a = compiledEqA.evaluate(scope);
            scope.b = compiledEqB.evaluate(scope);
            scope.c = compiledEqC.evaluate(scope);
            const v = getCompiledDenklem().evaluate(scope);
            document.getElementById('curVal').innerText = (typeof v === 'number') ? v.toFixed(4) : "0.000";
        } catch(e) { document.getElementById('curVal').innerText = "Err"; }
    }

    function startMoving() { 
        if(view.isMasterLocked) return; 
        view.isMoving=true; 
        clearTimeout(renderTimer); 
        render(12); 
        renderTimer=setTimeout(()=>{view.isMoving=false; render(2);}, 150); 
    }
    
    function toggleMenu() { 
        if (document.getElementById('settings').style.display === 'block') {
            closePopup('settings');
        } else {
            showPopup('settings');
        }
    }
    
    function toggleTargetMode() { 
        if(getActiveConfig().fixedTarget.enabled) return;
        view.isTargetMode=!view.isTargetMode; 
        document.getElementById('targetBtn').classList.toggle('active'); 
        render(2); 
    }
    
    function toggleMasterLock() { 
        view.isMasterLocked=!view.isMasterLocked; 
        const b=document.getElementById('masterLockBtn'); 
        b.classList.toggle('locked'); 
        b.innerText=view.isMasterLocked?"üîì":"üîí"; 
        render(2); 
    }

    function applySettings() {
        const cfg = getActiveConfig();
        cfg.eq = document.getElementById('eqInput').value;
        
        try {
            compiledEq = math.compile(cfg.eq);
        } catch(e) {
            alert('Ana denklem hatasƒ±: ' + e.message);
            return;
        }
        
        const keys = ['i3','i2','i1','h0','h1','h2','h3'];
        keys.forEach(k => {
            cfg.paramsLeft[k].val = parseFloat(document.getElementById(k + '_left').value);
            cfg.paramsLeft[k].en = document.getElementById('en_' + k + '_left').checked;
            cfg.paramsLeft[k].marker = document.getElementById('mark_' + k + '_left').checked;
            cfg.paramsRight[k].val = parseFloat(document.getElementById(k + '_right').value);
            cfg.paramsRight[k].en = document.getElementById('en_' + k + '_right').checked;
            cfg.paramsRight[k].marker = document.getElementById('mark_' + k + '_right').checked;
        });
        
        cfg.box.enabled = document.getElementById('boxEnable').checked;
        cfg.box.type = document.getElementById('maskType').value;
        cfg.box.style = document.getElementById('maskStyle').value;
        cfg.box.x1 = parseFloat(document.getElementById('bx1').value); 
        cfg.box.x2 = parseFloat(document.getElementById('bx2').value);
        cfg.box.y1 = parseFloat(document.getElementById('by1').value); 
        cfg.box.y2 = parseFloat(document.getElementById('by2').value);
        
        closePopup('settings');
        render(2);
    }

    let isDown = false, lastMouse = {x:0, y:0};
    let touchDistance = 0;

    function handleIn(ex, ey) {
        if(view.isMasterLocked || !isDown) return;
        const cfg = getActiveConfig();
        if(view.isTargetMode && !cfg.fixedTarget.enabled) { 
            view.target.x = (ex-canvas.width/2)/view.zoom + view.x; 
            view.target.y = -(ey-canvas.height/2)/view.zoom + view.y; 
            render(2); 
        } else if(!view.isTargetMode) { 
            view.x -= (ex-lastMouse.x)/view.zoom; 
            view.y += (ey-lastMouse.y)/view.zoom; 
            lastMouse={x:ex, y:ey}; 
            startMoving(); 
        }
    }

    canvas.addEventListener('mousedown', e => {isDown=true; lastMouse={x:e.clientX, y:e.clientY}; handleIn(e.clientX, e.clientY);});
    window.addEventListener('mouseup', () => isDown=false);
    window.addEventListener('mousemove', e => handleIn(e.clientX, e.clientY));
    
    canvas.addEventListener('touchstart', e => {
        if(e.touches.length === 1){
            isDown=true; 
            lastMouse={x:e.touches[0].clientX, y:e.touches[0].clientY}; 
            handleIn(lastMouse.x, lastMouse.y);
        } else if(e.touches.length === 2) {
            isDown = false;
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            touchDistance = Math.hypot(dx, dy);
        }
    }, {passive:false});
    
    canvas.addEventListener('touchmove', e => {
        if(e.touches.length === 1) {
            handleIn(e.touches[0].clientX, e.touches[0].clientY);
        } else if(e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const dist = Math.hypot(dx, dy);
            if (touchDistance > 0) {
                const scale = dist / touchDistance;
                manualZoom(scale);
            }
            touchDistance = dist;
        }
        e.preventDefault();
    }, {passive:false});
    
    window.addEventListener('touchend', ()=>{ isDown=false; touchDistance=0; });
    
    function manualZoom(f) { view.zoom *= f; startMoving(); }
    canvas.addEventListener('wheel', e => {manualZoom(e.deltaY>0?0.8:1.25); e.preventDefault();}, {passive:false});

    window.addEventListener('resize', () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; render(2); });
    canvas.width=window.innerWidth; canvas.height=window.innerHeight;
    updateVarLabels();
    render(2);
</script>
</body>
</html>